<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<!-- Created by htmlize-1.56 in css mode. -->
<html>
  <head>
    <title>config.el</title>
  <style>
    body > pre {
      font-size: 1rem;
      max-width: min(100rem, 100%);
      width: max-content;
      white-space: pre-wrap;
      margin: auto;
    }
  </style>
    <style type="text/css">
    <!--
      body {
        color: #383a42;
        background-color: #fafafa;
      }
      .bold {
        /* bold */
        font-weight: bold;
      }
      .builtin {
        /* font-lock-builtin-face */
        color: #a626a4;
      }
      .comment {
        /* font-lock-comment-face */
        color: #9ca0a4;
      }
      .comment-delimiter {
        /* font-lock-comment-delimiter-face */
        color: #9ca0a4;
      }
      .constant {
        /* font-lock-constant-face */
        color: #b751b6;
      }
      .doc {
        /* font-lock-doc-face */
        color: #84888b;
        font-style: italic;
      }
      .error {
        /* error */
        color: #e45649;
      }
      .function-name {
        /* font-lock-function-name-face */
        color: #a626a4;
      }
      .highlight-numbers-number {
        /* highlight-numbers-number */
        color: #da8548;
        font-weight: bold;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #e45649;
      }
      .negation-char {
        /* font-lock-negation-char-face */
        color: #4078f2;
        font-weight: bold;
      }
      .regexp-grouping-backslash {
        /* font-lock-regexp-grouping-backslash */
        color: #4078f2;
        font-weight: bold;
      }
      .regexp-grouping-construct {
        /* font-lock-regexp-grouping-construct */
        color: #4078f2;
        font-weight: bold;
      }
      .string {
        /* font-lock-string-face */
        color: #50a14f;
      }
      .success {
        /* success */
        color: #50a14f;
      }
      .type {
        /* font-lock-type-face */
        color: #986801;
      }
      .variable-name {
        /* font-lock-variable-name-face */
        color: #6a1868;
      }
      .warning {
        /* warning */
        color: #986801;
      }
      .warning-1 {
        /* font-lock-warning-face */
        color: #986801;
      }

      a {
        color: inherit;
        background-color: inherit;
        font: inherit;
        text-decoration: inherit;
      }
      a:hover {
        text-decoration: underline;
      }
    -->
    </style>
  </head>
  <body>
    <pre>
<span class="comment-delimiter">;;; </span><span class="comment">config.el -*- lexical-binding: t; -*-
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Personal Information][Personal Information:1]]
</span>(<span class="keyword">setq</span> user-full-name <span class="string">"TEC"</span>
      user-mail-address <span class="string">"tec@tecosaur.com"</span>)
<span class="comment-delimiter">;; </span><span class="comment">Personal Information:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Personal Information][Personal Information:2]]
</span>(<span class="keyword">setq</span> auth-sources '(<span class="string">"~/.authinfo.gpg"</span>)
      auth-source-cache-expiry nil) <span class="comment-delimiter">; </span><span class="comment">default is 7200 (2h)
</span><span class="comment-delimiter">;; </span><span class="comment">Personal Information:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Simple settings][Simple settings:1]]
</span>(<span class="keyword">setq-default</span>
 delete-by-moving-to-trash t                      <span class="comment-delimiter">; </span><span class="comment">Delete files to trash
</span> window-combination-resize t                      <span class="comment-delimiter">; </span><span class="comment">take new window space from all other windows (not just current)
</span> x-stretch-cursor t)                              <span class="comment-delimiter">; </span><span class="comment">Stretch cursor to the glyph width
</span>
(<span class="keyword">setq</span> undo-limit <span class="highlight-numbers-number">80000000</span>                         <span class="comment-delimiter">; </span><span class="comment">Raise undo-limit to 80Mb
</span>      evil-want-fine-undo t                       <span class="comment-delimiter">; </span><span class="comment">By default while in insert all changes are one big blob. Be more granular
</span>      auto-save-default t                         <span class="comment-delimiter">; </span><span class="comment">Nobody likes to loose work, I certainly don't
</span>      truncate-string-ellipsis <span class="string">"&#226;&#128;&#166;"</span>)               <span class="comment-delimiter">; </span><span class="comment">Unicode ellispis are nicer than "...", and also save /precious/ space
</span>
(display-time-mode <span class="highlight-numbers-number">1</span>)                             <span class="comment-delimiter">; </span><span class="comment">Enable time in the mode-line
</span>
(<span class="keyword">if</span> (equal <span class="string">"Battery status not available"</span>
           (battery))
    (display-battery-mode <span class="highlight-numbers-number">1</span>)                        <span class="comment-delimiter">; </span><span class="comment">On laptops it's nice to know how much power you have
</span>  (<span class="keyword">setq</span> password-cache-expiry nil))               <span class="comment-delimiter">; </span><span class="comment">I can trust my desktops ... can't I? (no battery = desktop)
</span>
(global-subword-mode <span class="highlight-numbers-number">1</span>)                           <span class="comment-delimiter">; </span><span class="comment">Iterate through CamelCase words
</span><span class="comment-delimiter">;; </span><span class="comment">Simple settings:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Frame sizing][Frame sizing:1]]
</span>(add-to-list 'default-frame-alist '(height . <span class="highlight-numbers-number">24</span>))
(add-to-list 'default-frame-alist '(width . <span class="highlight-numbers-number">80</span>))
<span class="comment-delimiter">;; </span><span class="comment">Frame sizing:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Auto-customisations][Auto-customisations:1]]
</span>(<span class="keyword">setq-default</span> custom-file (expand-file-name <span class="string">".custom.el"</span> doom-private-dir))
(<span class="keyword">when</span> (file-exists-p custom-file)
  (load custom-file))
<span class="comment-delimiter">;; </span><span class="comment">Auto-customisations:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Windows][Windows:1]]
</span>(<span class="keyword">setq</span> evil-vsplit-window-right t
      evil-split-window-below t)
<span class="comment-delimiter">;; </span><span class="comment">Windows:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Windows][Windows:2]]
</span>(<span class="keyword">defadvice!</span> prompt-for-buffer (<span class="type">&amp;rest</span> _)
  <span class="builtin">:after</span> '(evil-window-split evil-window-vsplit)
  (+ivy/switch-buffer))
<span class="comment-delimiter">;; </span><span class="comment">Windows:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Windows][Windows:3]]
</span>(<span class="keyword">setq</span> +ivy-buffer-preview t)
<span class="comment-delimiter">;; </span><span class="comment">Windows:3 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Windows][Windows:4]]
</span>(<span class="keyword">map!</span> <span class="builtin">:map</span> evil-window-map
      <span class="string">"SPC"</span> #'rotate-layout
      <span class="comment-delimiter">;; </span><span class="comment">Navigation
</span>      <span class="string">"&lt;left&gt;"</span>     #'evil-window-left
      <span class="string">"&lt;down&gt;"</span>     #'evil-window-down
      <span class="string">"&lt;up&gt;"</span>       #'evil-window-up
      <span class="string">"&lt;right&gt;"</span>    #'evil-window-right
      <span class="comment-delimiter">;; </span><span class="comment">Swapping windows
</span>      <span class="string">"C-&lt;left&gt;"</span>       #'+evil/window-move-left
      <span class="string">"C-&lt;down&gt;"</span>       #'+evil/window-move-down
      <span class="string">"C-&lt;up&gt;"</span>         #'+evil/window-move-up
      <span class="string">"C-&lt;right&gt;"</span>      #'+evil/window-move-right)
<span class="comment-delimiter">;; </span><span class="comment">Windows:4 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Buffer defaults][Buffer defaults:1]]
</span><span class="comment-delimiter">;; </span><span class="comment">(setq-default major-mode 'org-mode)
</span><span class="comment-delimiter">;; </span><span class="comment">Buffer defaults:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Font Face][Font Face:1]]
</span>(<span class="keyword">setq</span> doom-font (font-spec <span class="builtin">:family</span> <span class="string">"JetBrains Mono"</span> <span class="builtin">:size</span> <span class="highlight-numbers-number">24</span>)
      doom-big-font (font-spec <span class="builtin">:family</span> <span class="string">"JetBrains Mono"</span> <span class="builtin">:size</span> <span class="highlight-numbers-number">36</span>)
      doom-variable-pitch-font (font-spec <span class="builtin">:family</span> <span class="string">"Overpass"</span> <span class="builtin">:size</span> <span class="highlight-numbers-number">24</span>)
      doom-serif-font (font-spec <span class="builtin">:family</span> <span class="string">"IBM Plex Mono"</span> <span class="builtin">:weight</span> 'light))
<span class="comment-delimiter">;; </span><span class="comment">Font Face:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Theme and modeline][Theme and modeline:1]]
</span>(<span class="keyword">setq</span> doom-theme 'doom-vibrant)
(<span class="keyword">delq!</span> t custom-theme-load-path)
<span class="comment-delimiter">;; </span><span class="comment">Theme and modeline:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Theme and modeline][Theme and modeline:2]]
</span>(<span class="keyword">custom-set-faces!</span>
  '(doom-modeline-buffer-modified <span class="builtin">:foreground</span> <span class="string">"orange"</span>))
<span class="comment-delimiter">;; </span><span class="comment">Theme and modeline:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Theme and modeline][Theme and modeline:3]]
</span>(<span class="keyword">defun</span> <span class="function-name">doom-modeline-conditional-buffer-encoding</span> ()
  <span class="doc">"We expect the encoding to be LF UTF-8, so only show the modeline when this is not the case"</span>
  (<span class="keyword">setq-local</span> doom-modeline-buffer-encoding
              (<span class="keyword">unless</span> (<span class="keyword">and</span> (memq (plist-get (coding-system-plist buffer-file-coding-system) <span class="builtin">:category</span>)
                                 '(coding-category-undecided coding-category-utf-8))
                           (not (memq (coding-system-eol-type buffer-file-coding-system) '(<span class="highlight-numbers-number">1</span> <span class="highlight-numbers-number">2</span>))))
                t)))

(add-hook 'after-change-major-mode-hook #'doom-modeline-conditional-buffer-encoding)
<span class="comment-delimiter">;; </span><span class="comment">Theme and modeline:3 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Miscellaneous][Miscellaneous:1]]
</span>(<span class="keyword">setq</span> display-line-numbers-type 'relative)
<span class="comment-delimiter">;; </span><span class="comment">Miscellaneous:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Miscellaneous][Miscellaneous:2]]
</span>(<span class="keyword">setq</span> doom-fallback-buffer-name <span class="string">"&#226;&#150;&#186; Doom"</span>
      +doom-dashboard-name <span class="string">"&#226;&#150;&#186; Doom"</span>)
<span class="comment-delimiter">;; </span><span class="comment">Miscellaneous:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Miscellaneous][Miscellaneous:3]]
</span>(<span class="keyword">custom-set-faces!</span> '(doom-modeline-evil-insert-state <span class="builtin">:weight</span> bold <span class="builtin">:foreground</span> <span class="string">"#339CDB"</span>))
<span class="comment-delimiter">;; </span><span class="comment">Miscellaneous:3 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Mouse buttons][Mouse buttons:1]]
</span>(<span class="keyword">map!</span> <span class="builtin">:n</span> [mouse-8] #'better-jumper-jump-backward
      <span class="builtin">:n</span> [mouse-9] #'better-jumper-jump-forward)
<span class="comment-delimiter">;; </span><span class="comment">Mouse buttons:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Window title][Window title:1]]
</span>(<span class="keyword">setq</span> frame-title-format
      '(<span class="string">""</span>
        (<span class="builtin">:eval</span>
         (<span class="keyword">if</span> (s-contains-p org-roam-directory (<span class="keyword">or</span> buffer-file-name <span class="string">""</span>))
             (replace-regexp-in-string
              <span class="string">".*/[0-9]*-?"</span> <span class="string">"&#226;&#152;&#176; "</span>
              (subst-char-in-string ?_ ?  buffer-file-name))
           <span class="string">"%b"</span>))
        (<span class="builtin">:eval</span>
         (<span class="keyword">let</span> ((project-name (projectile-project-name)))
           (<span class="keyword">unless</span> (string= <span class="string">"-"</span> project-name)
             (format (<span class="keyword">if</span> (buffer-modified-p)  <span class="string">" &#226;&#151;&#137; %s"</span> <span class="string">" &#226;&#128;&#134;&#226;&#151;&#143;&#226;&#128;&#134; %s"</span>) project-name))))))
<span class="comment-delimiter">;; </span><span class="comment">Window title:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Splash screen][Splash screen:1]]
</span>(<span class="keyword">defvar</span> <span class="variable-name">fancy-splash-image-template</span>
  (expand-file-name <span class="string">"misc/splash-images/blackhole-lines-template.svg"</span> doom-private-dir)
  <span class="doc">"Default template svg used for the splash image, with substitutions from "</span>)
(<span class="keyword">defvar</span> <span class="variable-name">fancy-splash-image-nil</span>
  (expand-file-name <span class="string">"misc/splash-images/transparent-pixel.png"</span> doom-private-dir)
  <span class="doc">"An image to use at minimum size, usually a transparent pixel"</span>)

(<span class="keyword">setq</span> fancy-splash-sizes
      `((<span class="builtin">:height</span> <span class="highlight-numbers-number">500</span> <span class="builtin">:min-height</span> <span class="highlight-numbers-number">50</span> <span class="builtin">:padding</span> (<span class="highlight-numbers-number">0</span> . <span class="highlight-numbers-number">4</span>) <span class="builtin">:template</span> ,(expand-file-name <span class="string">"misc/splash-images/blackhole-lines-0.svg"</span> doom-private-dir))
        (<span class="builtin">:height</span> <span class="highlight-numbers-number">440</span> <span class="builtin">:min-height</span> <span class="highlight-numbers-number">42</span> <span class="builtin">:padding</span> (<span class="highlight-numbers-number">1</span> . <span class="highlight-numbers-number">4</span>) <span class="builtin">:template</span> ,(expand-file-name <span class="string">"misc/splash-images/blackhole-lines-0.svg"</span> doom-private-dir))
        (<span class="builtin">:height</span> <span class="highlight-numbers-number">400</span> <span class="builtin">:min-height</span> <span class="highlight-numbers-number">38</span> <span class="builtin">:padding</span> (<span class="highlight-numbers-number">1</span> . <span class="highlight-numbers-number">4</span>) <span class="builtin">:template</span> ,(expand-file-name <span class="string">"misc/splash-images/blackhole-lines-1.svg"</span> doom-private-dir))
        (<span class="builtin">:height</span> <span class="highlight-numbers-number">350</span> <span class="builtin">:min-height</span> <span class="highlight-numbers-number">36</span> <span class="builtin">:padding</span> (<span class="highlight-numbers-number">1</span> . <span class="highlight-numbers-number">3</span>) <span class="builtin">:template</span> ,(expand-file-name <span class="string">"misc/splash-images/blackhole-lines-2.svg"</span> doom-private-dir))
        (<span class="builtin">:height</span> <span class="highlight-numbers-number">300</span> <span class="builtin">:min-height</span> <span class="highlight-numbers-number">34</span> <span class="builtin">:padding</span> (<span class="highlight-numbers-number">1</span> . <span class="highlight-numbers-number">3</span>) <span class="builtin">:template</span> ,(expand-file-name <span class="string">"misc/splash-images/blackhole-lines-3.svg"</span> doom-private-dir))
        (<span class="builtin">:height</span> <span class="highlight-numbers-number">250</span> <span class="builtin">:min-height</span> <span class="highlight-numbers-number">32</span> <span class="builtin">:padding</span> (<span class="highlight-numbers-number">1</span> . <span class="highlight-numbers-number">2</span>) <span class="builtin">:template</span> ,(expand-file-name <span class="string">"misc/splash-images/blackhole-lines-4.svg"</span> doom-private-dir))
        (<span class="builtin">:height</span> <span class="highlight-numbers-number">200</span> <span class="builtin">:min-height</span> <span class="highlight-numbers-number">30</span> <span class="builtin">:padding</span> (<span class="highlight-numbers-number">1</span> . <span class="highlight-numbers-number">2</span>) <span class="builtin">:template</span> ,(expand-file-name <span class="string">"misc/splash-images/blackhole-lines-5.svg"</span> doom-private-dir))
        (<span class="builtin">:height</span> <span class="highlight-numbers-number">100</span> <span class="builtin">:min-height</span> <span class="highlight-numbers-number">24</span> <span class="builtin">:padding</span> (<span class="highlight-numbers-number">1</span> . <span class="highlight-numbers-number">2</span>) <span class="builtin">:template</span> ,(expand-file-name <span class="string">"misc/splash-images/emacs-e-template.svg"</span> doom-private-dir))
        (<span class="builtin">:height</span> <span class="highlight-numbers-number">0</span>   <span class="builtin">:min-height</span> <span class="highlight-numbers-number">0</span>  <span class="builtin">:padding</span> (<span class="highlight-numbers-number">0</span> . <span class="highlight-numbers-number">0</span>) <span class="builtin">:file</span> ,fancy-splash-image-nil)))

(<span class="keyword">defvar</span> <span class="variable-name">fancy-splash-sizes</span>
  `((<span class="builtin">:height</span> <span class="highlight-numbers-number">500</span> <span class="builtin">:min-height</span> <span class="highlight-numbers-number">50</span> <span class="builtin">:padding</span> (<span class="highlight-numbers-number">0</span> . <span class="highlight-numbers-number">2</span>))
    (<span class="builtin">:height</span> <span class="highlight-numbers-number">440</span> <span class="builtin">:min-height</span> <span class="highlight-numbers-number">42</span> <span class="builtin">:padding</span> (<span class="highlight-numbers-number">1</span> . <span class="highlight-numbers-number">4</span>))
    (<span class="builtin">:height</span> <span class="highlight-numbers-number">330</span> <span class="builtin">:min-height</span> <span class="highlight-numbers-number">35</span> <span class="builtin">:padding</span> (<span class="highlight-numbers-number">1</span> . <span class="highlight-numbers-number">3</span>))
    (<span class="builtin">:height</span> <span class="highlight-numbers-number">200</span> <span class="builtin">:min-height</span> <span class="highlight-numbers-number">30</span> <span class="builtin">:padding</span> (<span class="highlight-numbers-number">1</span> . <span class="highlight-numbers-number">2</span>))
    (<span class="builtin">:height</span> <span class="highlight-numbers-number">0</span>   <span class="builtin">:min-height</span> <span class="highlight-numbers-number">0</span>  <span class="builtin">:padding</span> (<span class="highlight-numbers-number">0</span> . <span class="highlight-numbers-number">0</span>) <span class="builtin">:file</span> ,fancy-splash-image-nil))
  <span class="doc">"list of plists with the following properties
  :height the height of the image
  :min-height minimum `</span><span class="doc"><span class="constant">frame-height</span></span><span class="doc">' for image
  :padding `</span><span class="doc"><span class="constant">+doom-dashboard-banner-padding</span></span><span class="doc">' to apply
  :template non-default template file
  :file file to use instead of template"</span>)

(<span class="keyword">defvar</span> <span class="variable-name">fancy-splash-template-colours</span>
  '((<span class="string">"$colour1"</span> . keywords) (<span class="string">"$colour2"</span> . type) (<span class="string">"$colour3"</span> . base5) (<span class="string">"$colour4"</span> . base8))
  <span class="doc">"list of colour-replacement alists of the form (\"$placeholder\" . 'theme-colour) which applied the template"</span>)

(<span class="keyword">unless</span> (file-exists-p (expand-file-name <span class="string">"theme-splashes"</span> doom-cache-dir))
  (make-directory (expand-file-name <span class="string">"theme-splashes"</span> doom-cache-dir) t))

(<span class="keyword">defun</span> <span class="function-name">fancy-splash-filename</span> (theme-name height)
  (expand-file-name (concat (file-name-as-directory <span class="string">"theme-splashes"</span>)
                            theme-name
                            <span class="string">"-"</span> (number-to-string height) <span class="string">".svg"</span>)
                    doom-cache-dir))

(<span class="keyword">defun</span> <span class="function-name">fancy-splash-clear-cache</span> ()
  <span class="doc">"Delete all cached fancy splash images"</span>
  (<span class="keyword">interactive</span>)
  (delete-directory (expand-file-name <span class="string">"theme-splashes"</span> doom-cache-dir) t)
  (message <span class="string">"Cache cleared!"</span>))

(<span class="keyword">defun</span> <span class="function-name">fancy-splash-generate-image</span> (template height)
  <span class="doc">"Read TEMPLATE and create an image if HEIGHT with colour substitutions as
   described by `</span><span class="doc"><span class="constant">fancy-splash-template-colours</span></span><span class="doc">' for the current theme"</span>
  (<span class="keyword">with-temp-buffer</span>
    (insert-file-contents template)
    (re-search-forward <span class="string">"$height"</span> nil t)
    (replace-match (number-to-string height) nil nil)
    (<span class="keyword">dolist</span> (substitution fancy-splash-template-colours)
      (goto-char (point-min))
      (<span class="keyword">while</span> (re-search-forward (car substitution) nil t)
        (replace-match (doom-color (cdr substitution)) nil nil)))
    (write-region nil nil
                  (fancy-splash-filename (symbol-name doom-theme) height) nil nil)))

(<span class="keyword">defun</span> <span class="function-name">fancy-splash-generate-images</span> ()
  <span class="doc">"Perform `</span><span class="doc"><span class="constant">fancy-splash-generate-image</span></span><span class="doc">' in bulk"</span>
  (<span class="keyword">dolist</span> (size fancy-splash-sizes)
    (<span class="keyword">unless</span> (plist-get size <span class="builtin">:file</span>)
      (fancy-splash-generate-image (<span class="keyword">or</span> (plist-get size <span class="builtin">:file</span>)
                                       (plist-get size <span class="builtin">:template</span>)
                                       fancy-splash-image-template)
                                   (plist-get size <span class="builtin">:height</span>)))))

(<span class="keyword">defun</span> <span class="function-name">ensure-theme-splash-images-exist</span> (<span class="type">&amp;optional</span> height)
  (<span class="keyword">unless</span> (file-exists-p (fancy-splash-filename
                          (symbol-name doom-theme)
                          (<span class="keyword">or</span> height
                              (plist-get (car fancy-splash-sizes) <span class="builtin">:height</span>))))
    (fancy-splash-generate-images)))

(<span class="keyword">defun</span> <span class="function-name">get-appropriate-splash</span> ()
  (<span class="keyword">let</span> ((height (frame-height)))
    (cl-some (<span class="keyword">lambda</span> (size) (<span class="keyword">when</span> (&gt;= height (plist-get size <span class="builtin">:min-height</span>)) size))
             fancy-splash-sizes)))

(<span class="keyword">setq</span> fancy-splash-last-size nil)
(<span class="keyword">setq</span> fancy-splash-last-theme nil)
(<span class="keyword">defun</span> <span class="function-name">set-appropriate-splash</span> (<span class="type">&amp;rest</span> _)
  (<span class="keyword">let</span> ((appropriate-image (get-appropriate-splash)))
    (<span class="keyword">unless</span> (<span class="keyword">and</span> (equal appropriate-image fancy-splash-last-size)
                 (equal doom-theme fancy-splash-last-theme)))
    (<span class="keyword">unless</span> (plist-get appropriate-image <span class="builtin">:file</span>)
      (ensure-theme-splash-images-exist (plist-get appropriate-image <span class="builtin">:height</span>)))
    (<span class="keyword">setq</span> fancy-splash-image
          (<span class="keyword">or</span> (plist-get appropriate-image <span class="builtin">:file</span>)
              (fancy-splash-filename (symbol-name doom-theme) (plist-get appropriate-image <span class="builtin">:height</span>))))
    (<span class="keyword">setq</span> +doom-dashboard-banner-padding (plist-get appropriate-image <span class="builtin">:padding</span>))
    (<span class="keyword">setq</span> fancy-splash-last-size appropriate-image)
    (<span class="keyword">setq</span> fancy-splash-last-theme doom-theme)
    (+doom-dashboard-reload)))

(add-hook 'window-size-change-functions #'set-appropriate-splash)
(add-hook 'doom-load-theme-hook #'set-appropriate-splash)
<span class="comment-delimiter">;; </span><span class="comment">Splash screen:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::daemon initialisation][daemon initialisation]]
</span>(<span class="keyword">defun</span> <span class="function-name">greedily-do-daemon-setup</span> ()
  (<span class="keyword">require</span> '<span class="constant">org</span>)
  (<span class="keyword">when</span> (<span class="keyword">require</span> '<span class="constant">mu4e</span> nil t)
    (<span class="keyword">setq</span> mu4e-confirm-quit t)
    (<span class="keyword">setq</span> +mu4e-lock-greedy t)
    (<span class="keyword">setq</span> +mu4e-lock-relaxed t)
    (+mu4e-lock-add-watcher)
    (<span class="keyword">when</span> (+mu4e-lock-available t)
      (mu4e~start)))
  (<span class="keyword">when</span> (<span class="keyword">require</span> '<span class="constant">elfeed</span> nil t)
    (run-at-time nil (* <span class="highlight-numbers-number">8</span> <span class="highlight-numbers-number">60</span> <span class="highlight-numbers-number">60</span>) #'elfeed-update)))

(<span class="keyword">when</span> (daemonp)
  (add-hook 'emacs-startup-hook #'greedily-do-daemon-setup))
<span class="comment-delimiter">;; </span><span class="comment">daemon initialisation ends here
</span>
(<span class="keyword">use-package!</span> keycast
  <span class="builtin">:commands</span> keycast-mode
  <span class="builtin">:config</span>
  (<span class="keyword">define-minor-mode</span> <span class="function-name">keycast-mode</span>
    <span class="doc">"Show current command and its key binding in the mode line."</span>
    <span class="builtin">:global</span> t
    (<span class="keyword">if</span> keycast-mode
        (<span class="keyword">progn</span>
          (add-hook 'pre-command-hook 'keycast--update t)
          (add-to-list 'global-mode-string '(<span class="string">""</span> mode-line-keycast <span class="string">" "</span>)))
      (remove-hook 'pre-command-hook 'keycast--update)
      (<span class="keyword">setq</span> global-mode-string (remove '(<span class="string">""</span> mode-line-keycast <span class="string">" "</span>) global-mode-string))))
  (<span class="keyword">custom-set-faces!</span>
    '(keycast-command <span class="builtin">:inherit</span> doom-modeline-debug
                      <span class="builtin">:height</span> <span class="highlight-numbers-number">0.9</span>)
    '(keycast-key <span class="builtin">:inherit</span> custom-modified
                  <span class="builtin">:height</span> <span class="highlight-numbers-number">1.1</span>
                  <span class="builtin">:weight</span> bold)))

(<span class="keyword">use-package!</span> gif-screencast
  <span class="builtin">:commands</span> gif-screencast-mode
  <span class="builtin">:config</span>
  (<span class="keyword">map!</span> <span class="builtin">:map</span> gif-screencast-mode-map
        <span class="builtin">:g</span> <span class="string">"&lt;f8&gt;"</span> #'gif-screencast-toggle-pause
        <span class="builtin">:g</span> <span class="string">"&lt;f9&gt;"</span> #'gif-screencast-stop)
  (<span class="keyword">setq</span> gif-screencast-program <span class="string">"maim"</span>
        gif-screencast-args `(<span class="string">"--quality"</span> <span class="string">"3"</span> <span class="string">"-i"</span> ,(string-trim-right
                                                     (shell-command-to-string
                                                      <span class="string">"xdotool getactivewindow"</span>)))
        gif-screencast-optimize-args '(<span class="string">"--batch"</span> <span class="string">"--optimize=3"</span> <span class="string">"--usecolormap=/tmp/doom-color-theme"</span>))
  (<span class="keyword">defun</span> <span class="function-name">gif-screencast-write-colormap</span> ()
    (f-write-text
     (replace-regexp-in-string
      <span class="string">"\n+"</span> <span class="string">"\n"</span>
      (mapconcat (<span class="keyword">lambda</span> (c) (<span class="keyword">if</span> (listp (cdr c))
                                 (cadr c))) doom-themes--colors <span class="string">"\n"</span>))
     'utf-8
     <span class="string">"/tmp/doom-color-theme"</span> ))
  (gif-screencast-write-colormap)
  (add-hook 'doom-load-theme-hook #'gif-screencast-write-colormap))

(<span class="keyword">use-package!</span> vlf-setup
  <span class="builtin">:defer-incrementally</span> vlf-tune vlf-base vlf-write vlf-search vlf-occur vlf-follow vlf-ediff vlf)

(<span class="keyword">use-package!</span> screenshot
  <span class="builtin">:defer</span> t
  <span class="builtin">:config</span> (<span class="keyword">setq</span> screenshot-upload-fn <span class="string">"upload %s 2&gt;/dev/null"</span>))

(<span class="keyword">use-package!</span> aas
  <span class="builtin">:commands</span> aas-mode)

(<span class="keyword">use-package!</span> laas
  <span class="builtin">:hook</span> (LaTeX-mode . laas-mode)
  <span class="builtin">:config</span>
  (<span class="keyword">defun</span> <span class="function-name">laas-tex-fold-maybe</span> ()
    (<span class="keyword">unless</span> (equal <span class="string">"/"</span> aas-transient-snippet-key)
      (+latex-fold-last-macro-a)))
  (add-hook 'aas-post-snippet-expand-hook #'laas-tex-fold-maybe))

(<span class="keyword">use-package!</span> engrave-faces-latex
  <span class="builtin">:after</span> ox-latex)

(<span class="keyword">use-package!</span> ox-gfm
  <span class="builtin">:after</span> org)

(<span class="keyword">use-package!</span> org-pandoc-import
  <span class="builtin">:after</span> org)

(<span class="keyword">use-package</span> org-roam-server
  <span class="builtin">:after</span> (org-roam server)
  <span class="builtin">:config</span>
  (<span class="keyword">setq</span> org-roam-server-host <span class="string">"127.0.0.1"</span>
        org-roam-server-port <span class="highlight-numbers-number">8078</span>
        org-roam-server-export-inline-images t
        org-roam-server-authenticate nil
        org-roam-server-network-label-truncate t
        org-roam-server-network-label-truncate-length <span class="highlight-numbers-number">60</span>
        org-roam-server-network-label-wrap-length <span class="highlight-numbers-number">20</span>)
  (<span class="keyword">defun</span> <span class="function-name">org-roam-server-open</span> ()
    <span class="doc">"Ensure the server is active, then open the roam graph."</span>
    (<span class="keyword">interactive</span>)
    (org-roam-server-mode <span class="highlight-numbers-number">1</span>)
    (browse-url-xdg-open (format <span class="string">"http://localhost:%d"</span> org-roam-server-port))))

(<span class="keyword">use-package!</span> authinfo-color-mode
  <span class="builtin">:mode</span> (<span class="string">"authinfo.gpg\\'"</span> . authinfo-color-mode)
  <span class="builtin">:init</span> (advice-add 'authinfo-mode <span class="builtin">:override</span> #'authinfo-color-mode))

<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Abbrev mode][Abbrev mode:1]]
</span>(<span class="keyword">use-package</span> abbrev
  <span class="builtin">:init</span>
  (<span class="keyword">setq-default</span> abbrev-mode t)
  <span class="comment-delimiter">;; </span><span class="comment">a hook funtion that sets the abbrev-table to org-mode-abbrev-table
</span>  <span class="comment-delimiter">;; </span><span class="comment">whenever the major mode is a text mode
</span>  (<span class="keyword">defun</span> <span class="function-name">tec/set-text-mode-abbrev-table</span> ()
    (<span class="keyword">if</span> (derived-mode-p 'text-mode)
        (<span class="keyword">setq</span> local-abbrev-table org-mode-abbrev-table)))
  <span class="builtin">:commands</span> abbrev-mode
  <span class="builtin">:hook</span>
  (abbrev-mode . tec/set-text-mode-abbrev-table)
  <span class="builtin">:config</span>
  (<span class="keyword">setq</span> abbrev-file-name (expand-file-name <span class="string">"abbrev.el"</span> doom-private-dir))
  (<span class="keyword">setq</span> save-abbrevs 'silently))
<span class="comment-delimiter">;; </span><span class="comment">Abbrev mode:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Defaults][Defaults:1]]
</span>(<span class="keyword">setq</span> calc-angle-mode 'rad  <span class="comment-delimiter">; </span><span class="comment">radians are rad
</span>      calc-symbolic-mode t) <span class="comment-delimiter">; </span><span class="comment">keeps expressions like \sqrt{2} irrational for as long as possible
</span><span class="comment-delimiter">;; </span><span class="comment">Defaults:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*CalcTeX][CalcTeX:1]]
</span>(<span class="keyword">use-package!</span> calctex
  <span class="builtin">:commands</span> calctex-mode
  <span class="builtin">:init</span>
  (add-hook 'calc-mode-hook #'calctex-mode)
  <span class="builtin">:config</span>
  (<span class="keyword">setq</span> calctex-additional-latex-packages <span class="string">"
\\usepackage[usenames]{color}
\\usepackage{xcolor}
\\usepackage{soul}
\\usepackage{adjustbox}
\\usepackage{amsmath}
\\usepackage{amssymb}
\\usepackage{siunitx}
\\usepackage{cancel}
\\usepackage{mathtools}
\\usepackage{mathalpha}
\\usepackage{xparse}
\\usepackage{arevmath}"</span>
        calctex-additional-latex-macros
        (concat calctex-additional-latex-macros
                <span class="string">"\n\\let\\evalto\\Rightarrow"</span>))
  (<span class="keyword">defadvice!</span> no-messaging-a (orig-fn <span class="type">&amp;rest</span> args)
    <span class="builtin">:around</span> #'calctex-default-dispatching-render-process
    (<span class="keyword">let</span> ((inhibit-message t) message-log-max)
      (apply orig-fn args)))
  <span class="comment-delimiter">;; </span><span class="comment">Fix hardcoded dvichop path (whyyyyyyy)
</span>  (<span class="keyword">let</span> ((vendor-folder (concat (file-truename doom-local-dir)
                               <span class="string">"straight/"</span>
                               (format <span class="string">"build-%s"</span> emacs-version)
                               <span class="string">"/calctex/vendor/"</span>)))
    (<span class="keyword">setq</span> calctex-dvichop-sty (concat vendor-folder <span class="string">"texd/dvichop"</span>)
          calctex-dvichop-bin (concat vendor-folder <span class="string">"texd/dvichop"</span>)))
  (<span class="keyword">unless</span> (file-exists-p calctex-dvichop-bin)
    (message <span class="string">"CalcTeX: Building dvichop binary"</span>)
    (<span class="keyword">let</span> ((default-directory (file-name-directory calctex-dvichop-bin)))
      (call-process <span class="string">"make"</span> nil nil nil))))
<span class="comment-delimiter">;; </span><span class="comment">CalcTeX:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Embedded calc][Embedded calc:1]]
</span>(<span class="keyword">map!</span> <span class="builtin">:map</span> calc-mode-map
      <span class="builtin">:after</span> calc
      <span class="builtin">:localleader</span>
      <span class="builtin">:desc</span> <span class="string">"Embedded calc (toggle)"</span> <span class="string">"e"</span> #'calc-embedded)
(<span class="keyword">map!</span> <span class="builtin">:map</span> org-mode-map
      <span class="builtin">:after</span> org
      <span class="builtin">:localleader</span>
      <span class="builtin">:desc</span> <span class="string">"Embedded calc (toggle)"</span> <span class="string">"E"</span> #'calc-embedded)
(<span class="keyword">map!</span> <span class="builtin">:map</span> latex-mode-map
      <span class="builtin">:after</span> latex
      <span class="builtin">:localleader</span>
      <span class="builtin">:desc</span> <span class="string">"Embedded calc (toggle)"</span> <span class="string">"e"</span> #'calc-embedded)
<span class="comment-delimiter">;; </span><span class="comment">Embedded calc:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Embedded calc][Embedded calc:2]]
</span>(<span class="keyword">defvar</span> <span class="variable-name">calc-embedded-trail-window</span> nil)
(<span class="keyword">defvar</span> <span class="variable-name">calc-embedded-calculator-window</span> nil)

(<span class="keyword">defadvice!</span> calc-embedded-with-side-pannel (<span class="type">&amp;rest</span> _)
  <span class="builtin">:after</span> #'calc-do-embedded
  (<span class="keyword">when</span> calc-embedded-trail-window
    (<span class="keyword">ignore-errors</span>
      (delete-window calc-embedded-trail-window))
    (<span class="keyword">setq</span> calc-embedded-trail-window nil))
  (<span class="keyword">when</span> calc-embedded-calculator-window
    (<span class="keyword">ignore-errors</span>
      (delete-window calc-embedded-calculator-window))
    (<span class="keyword">setq</span> calc-embedded-calculator-window nil))
  (<span class="keyword">when</span> (<span class="keyword">and</span> calc-embedded-info
             (&gt; (* (window-width) (window-height)) <span class="highlight-numbers-number">1200</span>))
    (<span class="keyword">let</span> ((main-window (selected-window))
          (vertical-p (&gt; (window-width) <span class="highlight-numbers-number">80</span>)))
      (select-window
       (<span class="keyword">setq</span> calc-embedded-trail-window
             (<span class="keyword">if</span> vertical-p
                 (split-window-horizontally (- (max <span class="highlight-numbers-number">30</span> (/ (window-width) <span class="highlight-numbers-number">3</span>))))
               (split-window-vertically (- (max <span class="highlight-numbers-number">8</span> (/ (window-height) <span class="highlight-numbers-number">4</span>)))))))
      (switch-to-buffer <span class="string">"*Calc Trail*"</span>)
      (select-window
       (<span class="keyword">setq</span> calc-embedded-calculator-window
             (<span class="keyword">if</span> vertical-p
                 (split-window-vertically <span class="highlight-numbers-number">-6</span>)
               (split-window-horizontally (- (/ (window-width) <span class="highlight-numbers-number">2</span>))))))
      (switch-to-buffer <span class="string">"*Calculator*"</span>)
      (select-window main-window))))
<span class="comment-delimiter">;; </span><span class="comment">Embedded calc:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Centaur Tabs][Centaur Tabs:1]]
</span>(<span class="keyword">after!</span> centaur-tabs
  (centaur-tabs-mode <span class="highlight-numbers-number">-1</span>)
  (<span class="keyword">setq</span> centaur-tabs-height <span class="highlight-numbers-number">36</span>
        centaur-tabs-set-icons t
        centaur-tabs-modified-marker <span class="string">"o"</span>
        centaur-tabs-close-button <span class="string">"&#195;&#151;"</span>
        centaur-tabs-set-bar 'above
        centaur-tabs-gray-out-icons 'buffer)
  (centaur-tabs-change-fonts <span class="string">"P22 Underground Book"</span> <span class="highlight-numbers-number">160</span>))
<span class="comment-delimiter">;; </span><span class="comment">(setq x-underline-at-descent-line t)
</span><span class="comment-delimiter">;; </span><span class="comment">Centaur Tabs:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Company][Company:1]]
</span>(<span class="keyword">after!</span> company
  (<span class="keyword">setq</span> company-idle-delay <span class="highlight-numbers-number">0.5</span>
        company-minimum-prefix-length <span class="highlight-numbers-number">2</span>)
  (<span class="keyword">setq</span> company-show-numbers t)
  (add-hook 'evil-normal-state-entry-hook #'company-abort)) <span class="comment-delimiter">;; </span><span class="comment">make aborting less annoying.
</span><span class="comment-delimiter">;; </span><span class="comment">Company:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Company][Company:2]]
</span>(<span class="keyword">setq-default</span> history-length <span class="highlight-numbers-number">1000</span>)
(<span class="keyword">setq-default</span> prescient-history-length <span class="highlight-numbers-number">1000</span>)
<span class="comment-delimiter">;; </span><span class="comment">Company:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Plain Text][Plain Text:1]]
</span>(set-company-backend!
  '(text-mode
    markdown-mode
    gfm-mode)
  '(<span class="builtin">:seperate</span>
    company-ispell
    company-files
    company-yasnippet))
<span class="comment-delimiter">;; </span><span class="comment">Plain Text:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*ESS][ESS:1]]
</span>(set-company-backend! 'ess-r-mode '(company-R-args company-R-objects company-dabbrev-code <span class="builtin">:separate</span>))
<span class="comment-delimiter">;; </span><span class="comment">ESS:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Elcord][Elcord:1]]
</span>(<span class="keyword">setq</span> elcord-use-major-mode-as-main-icon t)
<span class="comment-delimiter">;; </span><span class="comment">Elcord:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Emacs Everywhere][Emacs Everywhere:1]]
</span>(<span class="keyword">when</span> (daemonp)
  (<span class="keyword">require</span> '<span class="constant">spell-fu</span>)
  (<span class="keyword">setq</span> emacs-everywhere-major-mode-function #'org-mode
        emacs-everywhere-frame-name-format <span class="string">"Edit &#226;&#136;&#183; %s &#226;&#128;&#148; %s"</span>)
  (<span class="keyword">require</span> '<span class="constant">emacs-everywhere</span>))
<span class="comment-delimiter">;; </span><span class="comment">Emacs Everywhere:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Emojify][Emojify:1]]
</span>(<span class="keyword">setq</span> emojify-emoji-set <span class="string">"twemoji-v2"</span>)
<span class="comment-delimiter">;; </span><span class="comment">Emojify:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Emojify][Emojify:2]]
</span>(<span class="keyword">defvar</span> <span class="variable-name">emojify-disabled-emojis</span>
  '(<span class="comment-delimiter">;; </span><span class="comment">Org
</span>    <span class="string">"&#226;&#151;&#188;"</span> <span class="string">"&#226;&#152;&#145;"</span> <span class="string">"&#226;&#152;&#184;"</span> <span class="string">"&#226;&#154;&#153;"</span> <span class="string">"&#226;&#143;&#169;"</span> <span class="string">"&#226;&#143;&#170;"</span> <span class="string">"&#226;&#172;&#134;"</span> <span class="string">"&#226;&#172;&#135;"</span> <span class="string">"&#226;&#157;&#147;"</span>
    <span class="comment-delimiter">;; </span><span class="comment">Terminal powerline
</span>    <span class="string">"&#226;&#156;&#148;"</span>
    <span class="comment-delimiter">;; </span><span class="comment">Box drawing
</span>    <span class="string">"&#226;&#150;&#182;"</span> <span class="string">"&#226;&#151;&#128;"</span>)
  <span class="doc">"Charachters that should never be affected by `</span><span class="doc"><span class="constant">emojify-mode</span></span><span class="doc">'."</span>)

(<span class="keyword">defadvice!</span> emojify-delete-from-data ()
  <span class="doc">"Ensure `</span><span class="doc"><span class="constant">emojify-disabled-emojis</span></span><span class="doc">' don't appear in `</span><span class="doc"><span class="constant">emojify-emojis</span></span><span class="doc">'."</span>
  <span class="builtin">:after</span> #'emojify-set-emoji-data
  (<span class="keyword">dolist</span> (emoji emojify-disabled-emojis)
    (remhash emoji emojify-emojis)))
<span class="comment-delimiter">;; </span><span class="comment">Emojify:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Emojify][Emojify:3]]
</span>(<span class="keyword">add-hook!</span> '(mu4e-compose-mode org-msg-edit-mode circe-channel-mode) (emoticon-to-emoji <span class="highlight-numbers-number">1</span>))
<span class="comment-delimiter">;; </span><span class="comment">Emojify:3 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Eros-eval][Eros-eval:1]]
</span>(<span class="keyword">setq</span> eros-eval-result-prefix <span class="string">"&#226;&#159;&#185; "</span>)
<span class="comment-delimiter">;; </span><span class="comment">Eros-eval:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*EVIL][EVIL:1]]
</span>(<span class="keyword">after!</span> evil-escape (evil-escape-mode <span class="highlight-numbers-number">-1</span>))
<span class="comment-delimiter">;; </span><span class="comment">EVIL:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*EVIL][EVIL:2]]
</span>(<span class="keyword">after!</span> evil (<span class="keyword">setq</span> evil-ex-substitute-global t)) <span class="comment-delimiter">; </span><span class="comment">I like my s/../.. to by global by default
</span><span class="comment-delimiter">;; </span><span class="comment">EVIL:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Info colours][Info colours:1]]
</span>(<span class="keyword">use-package!</span> info-colors
  <span class="builtin">:commands</span> (info-colors-fontify-node))

(add-hook 'Info-selection-hook 'info-colors-fontify-node)

(add-hook 'Info-mode-hook #'mixed-pitch-mode)
<span class="comment-delimiter">;; </span><span class="comment">Info colours:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Configuration][Configuration:1]]
</span>(<span class="keyword">setq</span> ispell-dictionary <span class="string">"en-custom"</span>)
<span class="comment-delimiter">;; </span><span class="comment">Configuration:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Configuration][Configuration:2]]
</span>(<span class="keyword">setq</span> ispell-personal-dictionary (expand-file-name <span class="string">".ispell_personal"</span> doom-private-dir))
<span class="comment-delimiter">;; </span><span class="comment">Configuration:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Ivy][Ivy:1]]
</span>(<span class="keyword">setq</span> ivy-read-action-function #'ivy-hydra-read-action)
<span class="comment-delimiter">;; </span><span class="comment">Ivy:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Ivy][Ivy:2]]
</span>(<span class="keyword">setq</span> ivy-sort-max-size <span class="highlight-numbers-number">50000</span>)
<span class="comment-delimiter">;; </span><span class="comment">Ivy:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Magit][Magit:1]]
</span><span class="comment-delimiter">;; </span><span class="comment">(after! magit
</span><span class="comment-delimiter">;;   </span><span class="comment">(magit-delta-mode +1))
</span><span class="comment-delimiter">;; </span><span class="comment">Magit:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Org Chef][Org Chef:1]]
</span>(<span class="keyword">use-package!</span> org-chef
  <span class="builtin">:commands</span> (org-chef-insert-recipe org-chef-get-recipe-from-url))
<span class="comment-delimiter">;; </span><span class="comment">Org Chef:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Projectile][Projectile:1]]
</span>(<span class="keyword">setq</span> projectile-ignored-projects '(<span class="string">"~/"</span> <span class="string">"/tmp"</span> <span class="string">"~/.emacs.d/.local/straight/repos/"</span>))
(<span class="keyword">defun</span> <span class="function-name">projectile-ignored-project-function</span> (filepath)
  <span class="doc">"Return t if FILEPATH is within any of `</span><span class="doc"><span class="constant">projectile-ignored-projects</span></span><span class="doc">'"</span>
  (<span class="keyword">or</span> (mapcar (<span class="keyword">lambda</span> (p) (s-starts-with-p p filepath)) projectile-ignored-projects)))
<span class="comment-delimiter">;; </span><span class="comment">Projectile:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Smart Parentheses][Smart Parentheses:1]]
</span>(sp-local-pair
 '(org-mode)
 <span class="string">"&lt;&lt;"</span> <span class="string">"&gt;&gt;"</span>
 <span class="builtin">:actions</span> '(insert))
<span class="comment-delimiter">;; </span><span class="comment">Smart Parentheses:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Spray][Spray:1]]
</span>(<span class="keyword">setq</span> spray-wpm <span class="highlight-numbers-number">500</span>
      spray-height <span class="highlight-numbers-number">700</span>)
<span class="comment-delimiter">;; </span><span class="comment">Spray:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Tramp][Tramp:1]]
</span>(<span class="keyword">after!</span> tramp
  (setenv <span class="string">"SHELL"</span> <span class="string">"/bin/bash"</span>)
  (<span class="keyword">setq</span> tramp-shell-prompt-pattern <span class="string">"</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(?:</span></span><span class="string">^</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">|</span></span><span class="string"></span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">[</span><span class="string"><span class="negation-char">^</span></span><span class="string">]#$%&gt;\n]*#?[]#$%&gt;&#238;&#130;&#176;] *</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">&#27;\\[[0-9;]*[a-zA-Z] *</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">*"</span>)) <span class="comment-delimiter">;; </span><span class="comment">default + &#238;&#130;&#176;
</span><span class="comment-delimiter">;; </span><span class="comment">Tramp:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Guix][Guix:1]]
</span>(<span class="keyword">after!</span> tramp
  (<span class="keyword">appendq!</span> tramp-remote-path
            '(<span class="string">"~/.guix-profile/bin"</span> <span class="string">"~/.guix-profile/sbin"</span>
              <span class="string">"/run/current-system/profile/bin"</span>
              <span class="string">"/run/current-system/profile/sbin"</span>)))
<span class="comment-delimiter">;; </span><span class="comment">Guix:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Treemacs][Treemacs:1]]
</span>(<span class="keyword">after!</span> treemacs
  (<span class="keyword">defvar</span> <span class="variable-name">treemacs-file-ignore-extensions</span> '()
    <span class="doc">"File extension which `</span><span class="doc"><span class="constant">treemacs-ignore-filter</span></span><span class="doc">' will ensure are ignored"</span>)
  (<span class="keyword">defvar</span> <span class="variable-name">treemacs-file-ignore-globs</span> '()
    <span class="doc">"Globs which will are transformed to `</span><span class="doc"><span class="constant">treemacs-file-ignore-regexps</span></span><span class="doc">' which `</span><span class="doc"><span class="constant">treemacs-ignore-filter</span></span><span class="doc">' will ensure are ignored"</span>)
  (<span class="keyword">defvar</span> <span class="variable-name">treemacs-file-ignore-regexps</span> '()
    <span class="doc">"RegExps to be tested to ignore files, generated from `</span><span class="doc"><span class="constant">treeemacs-file-ignore-globs</span></span><span class="doc">'"</span>)
  (<span class="keyword">defun</span> <span class="function-name">treemacs-file-ignore-generate-regexps</span> ()
    <span class="doc">"Generate `</span><span class="doc"><span class="constant">treemacs-file-ignore-regexps</span></span><span class="doc">' from `</span><span class="doc"><span class="constant">treemacs-file-ignore-globs</span></span><span class="doc">'"</span>
    (<span class="keyword">setq</span> treemacs-file-ignore-regexps (mapcar 'dired-glob-regexp treemacs-file-ignore-globs)))
  (<span class="keyword">if</span> (equal treemacs-file-ignore-globs '()) nil (treemacs-file-ignore-generate-regexps))
  (<span class="keyword">defun</span> <span class="function-name">treemacs-ignore-filter</span> (file full-path)
    <span class="doc">"Ignore files specified by `</span><span class="doc"><span class="constant">treemacs-file-ignore-extensions</span></span><span class="doc">', and `</span><span class="doc"><span class="constant">treemacs-file-ignore-regexps</span></span><span class="doc">'"</span>
    (<span class="keyword">or</span> (member (file-name-extension file) treemacs-file-ignore-extensions)
        (<span class="keyword">let</span> ((ignore-file nil))
          (<span class="keyword">dolist</span> (regexp treemacs-file-ignore-regexps ignore-file)
            (<span class="keyword">setq</span> ignore-file (<span class="keyword">or</span> ignore-file (<span class="keyword">if</span> (string-match-p regexp full-path) t nil)))))))
  (add-to-list 'treemacs-ignored-file-predicates #'treemacs-ignore-filter))
<span class="comment-delimiter">;; </span><span class="comment">Treemacs:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Treemacs][Treemacs:2]]
</span>(<span class="keyword">setq</span> treemacs-file-ignore-extensions
      '(<span class="comment-delimiter">;; </span><span class="comment">LaTeX
</span>        <span class="string">"aux"</span>
        <span class="string">"ptc"</span>
        <span class="string">"fdb_latexmk"</span>
        <span class="string">"fls"</span>
        <span class="string">"synctex.gz"</span>
        <span class="string">"toc"</span>
        <span class="comment-delimiter">;; </span><span class="comment">LaTeX - glossary
</span>        <span class="string">"glg"</span>
        <span class="string">"glo"</span>
        <span class="string">"gls"</span>
        <span class="string">"glsdefs"</span>
        <span class="string">"ist"</span>
        <span class="string">"acn"</span>
        <span class="string">"acr"</span>
        <span class="string">"alg"</span>
        <span class="comment-delimiter">;; </span><span class="comment">LaTeX - pgfplots
</span>        <span class="string">"mw"</span>
        <span class="comment-delimiter">;; </span><span class="comment">LaTeX - pdfx
</span>        <span class="string">"pdfa.xmpi"</span>
        ))
(<span class="keyword">setq</span> treemacs-file-ignore-globs
      '(<span class="comment-delimiter">;; </span><span class="comment">LaTeX
</span>        <span class="string">"*/_minted-*"</span>
        <span class="comment-delimiter">;; </span><span class="comment">AucTeX
</span>        <span class="string">"*/.auctex-auto"</span>
        <span class="string">"*/_region_.log"</span>
        <span class="string">"*/_region_.tex"</span>))
<span class="comment-delimiter">;; </span><span class="comment">Treemacs:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Which-key][Which-key:1]]
</span>(<span class="keyword">setq</span> which-key-idle-delay <span class="highlight-numbers-number">0.5</span>) <span class="comment-delimiter">;; </span><span class="comment">I need the help, I really do
</span><span class="comment-delimiter">;; </span><span class="comment">Which-key:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Which-key][Which-key:2]]
</span>(<span class="keyword">setq</span> which-key-allow-multiple-replacements t)
(<span class="keyword">after!</span> which-key
  (<span class="keyword">pushnew!</span>
   which-key-replacement-alist
   '((<span class="string">""</span> . <span class="string">"\\`+?evil[-:]?</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(?:</span></span><span class="string">a-</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">?</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">.*</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">"</span>) . (nil . <span class="string">"&#226;&#151;&#130;\\1"</span>))
   '((<span class="string">"\\`g s"</span> . <span class="string">"\\`evilem--?motion-</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">.*</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">"</span>) . (nil . <span class="string">"&#226;&#151;&#131;\\1"</span>))
   ))
<span class="comment-delimiter">;; </span><span class="comment">Which-key:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Writeroom][Writeroom:1]]
</span>(<span class="keyword">setq</span> +zen-text-scale <span class="highlight-numbers-number">0.6</span>)
<span class="comment-delimiter">;; </span><span class="comment">Writeroom:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Writeroom][Writeroom:2]]
</span>(<span class="keyword">after!</span> writeroom-mode
  (add-hook 'writeroom-mode-hook
            (<span class="keyword">defun</span> <span class="function-name">+zen-cleaner-org</span> ()
              (<span class="keyword">when</span> (<span class="keyword">and</span> (eq major-mode 'org-mode) writeroom-mode)
                (<span class="keyword">setq-local</span> -display-line-numbers display-line-numbers
                            display-line-numbers nil)
                (<span class="keyword">setq-local</span> -org-indent-mode org-indent-mode)
                (org-indent-mode <span class="highlight-numbers-number">-1</span>)
                (<span class="keyword">when</span> (<span class="keyword">featurep</span> '<span class="constant">org-superstar</span>)
                  (<span class="keyword">setq-local</span> -org-superstar-headline-bullets-list org-superstar-headline-bullets-list
                              <span class="comment-delimiter">;; </span><span class="comment">org-superstar-headline-bullets-list '("&#240;&#159;&#153;&#144;" "&#240;&#159;&#153;&#145;" "&#240;&#159;&#153;&#146;" "&#240;&#159;&#153;&#147;" "&#240;&#159;&#153;&#148;" "&#240;&#159;&#153;&#149;" "&#240;&#159;&#153;&#150;" "&#240;&#159;&#153;&#151;")
</span>                              org-superstar-headline-bullets-list '(<span class="string">"&#240;&#159;&#153;&#152;"</span> <span class="string">"&#240;&#159;&#153;&#153;"</span> <span class="string">"&#240;&#159;&#153;&#154;"</span> <span class="string">"&#240;&#159;&#153;&#155;"</span>)
                              -org-superstar-remove-leading-stars org-superstar-remove-leading-stars
                              org-superstar-remove-leading-stars t)
                  (org-superstar-restart)))))
  (add-hook 'writeroom-mode-disable-hook
            (<span class="keyword">defun</span> <span class="function-name">+zen-dirty-org</span> ()
              (<span class="keyword">when</span> (eq major-mode 'org-mode)
                (<span class="keyword">setq-local</span> display-line-numbers -display-line-numbers)
                (<span class="keyword">when</span> -org-indent-mode
                  (org-indent-mode <span class="highlight-numbers-number">1</span>))
                (<span class="keyword">when</span> (<span class="keyword">featurep</span> '<span class="constant">org-superstar</span>)
                  (<span class="keyword">setq-local</span> org-superstar-headline-bullets-list -org-superstar-headline-bullets-list
                              org-superstar-remove-leading-stars -org-superstar-remove-leading-stars)
                  (org-superstar-restart))))))
<span class="comment-delimiter">;; </span><span class="comment">Writeroom:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*xkcd][xkcd:1]]
</span>(<span class="keyword">use-package!</span> xkcd
  <span class="builtin">:commands</span> (xkcd-get-json
             xkcd-download xkcd-get
             <span class="comment-delimiter">;; </span><span class="comment">now for funcs from my extension of this pkg
</span>             +xkcd-find-and-copy +xkcd-find-and-view
             +xkcd-fetch-info +xkcd-select)
  <span class="builtin">:config</span>
  (<span class="keyword">setq</span> xkcd-cache-dir (expand-file-name <span class="string">"xkcd/"</span> doom-cache-dir)
        xkcd-cache-latest (concat xkcd-cache-dir <span class="string">"latest"</span>))
  (<span class="keyword">unless</span> (file-exists-p xkcd-cache-dir)
    (make-directory xkcd-cache-dir))
  (<span class="keyword">after!</span> evil-snipe
    (add-to-list 'evil-snipe-disabled-modes 'xkcd-mode))
  <span class="builtin">:general</span> (<span class="builtin">:states</span> 'normal
            <span class="builtin">:keymaps</span> 'xkcd-mode-map
            <span class="string">"&lt;right&gt;"</span> #'xkcd-next
            <span class="string">"n"</span>       #'xkcd-next <span class="comment-delimiter">; </span><span class="comment">evil-ish
</span>            <span class="string">"&lt;left&gt;"</span>  #'xkcd-prev
            <span class="string">"N"</span>       #'xkcd-prev <span class="comment-delimiter">; </span><span class="comment">evil-ish
</span>            <span class="string">"r"</span>       #'xkcd-rand
            <span class="string">"a"</span>       #'xkcd-rand <span class="comment-delimiter">; </span><span class="comment">because image-rotate can interfere
</span>            <span class="string">"t"</span>       #'xkcd-alt-text
            <span class="string">"q"</span>       #'xkcd-kill-buffer
            <span class="string">"o"</span>       #'xkcd-open-browser
            <span class="string">"e"</span>       #'xkcd-open-explanation-browser
            <span class="comment-delimiter">;; </span><span class="comment">extras
</span>            <span class="string">"s"</span>       #'+xkcd-find-and-view
            <span class="string">"/"</span>       #'+xkcd-find-and-view
            <span class="string">"y"</span>       #'+xkcd-copy))
<span class="comment-delimiter">;; </span><span class="comment">xkcd:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*xkcd][xkcd:2]]
</span>(<span class="keyword">after!</span> xkcd
  (<span class="keyword">require</span> '<span class="constant">emacsql-sqlite</span>)

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-select</span> ()
    <span class="doc">"Prompt the user for an xkcd using `</span><span class="doc"><span class="constant">ivy-read</span></span><span class="doc">' and `</span><span class="doc"><span class="constant">+xkcd-select-format</span></span><span class="doc">'. Return the xkcd number or nil"</span>
    (<span class="keyword">let*</span> (prompt-lines
           (-dummy (maphash (<span class="keyword">lambda</span> (key xkcd-info)
                              (<span class="keyword">push</span> (+xkcd-select-format xkcd-info) prompt-lines))
                            +xkcd-stored-info))
           (num (ivy-read (format <span class="string">"xkcd (%s): "</span> xkcd-latest) prompt-lines)))
      (<span class="keyword">if</span> (equal <span class="string">""</span> num) xkcd-latest
        (string-to-number (replace-regexp-in-string <span class="string">"</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[0-9]+</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">.*"</span> <span class="string">"\\1"</span> num)))))

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-select-format</span> (xkcd-info)
    <span class="doc">"Creates each ivy-read line from an xkcd info plist. Must start with the xkcd number"</span>
    (format <span class="string">"%-4s  %-30s %s"</span>
            (propertize (number-to-string (plist-get xkcd-info <span class="builtin">:num</span>))
                        'face 'counsel-key-binding)
            (plist-get xkcd-info <span class="builtin">:title</span>)
            (propertize (plist-get xkcd-info <span class="builtin">:alt</span>)
                        'face '(variable-pitch font-lock-comment-face))))

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-fetch-info</span> (<span class="type">&amp;optional</span> num)
    <span class="doc">"Fetch the parsed json info for comic NUM. Fetches latest when omitted or 0"</span>
    (<span class="keyword">require</span> '<span class="constant">xkcd</span>)
    (<span class="keyword">when</span> (<span class="keyword">or</span> (not num) (= num <span class="highlight-numbers-number">0</span>))
      (+xkcd-check-latest)
      (<span class="keyword">setq</span> num xkcd-latest))
    (<span class="keyword">let</span> ((res (<span class="keyword">or</span> (gethash num +xkcd-stored-info)
                   (puthash num (+xkcd-db-read num) +xkcd-stored-info))))
      (<span class="keyword">unless</span> res
        (+xkcd-db-write
         (<span class="keyword">let*</span> ((url (format <span class="string">"https://xkcd.com/%d/info.0.json"</span> num))
                (json-assoc
                 (<span class="keyword">if</span> (gethash num +xkcd-stored-info)
                     (gethash num +xkcd-stored-info)
                   (json-read-from-string (xkcd-get-json url num)))))
           json-assoc))
        (<span class="keyword">setq</span> res (+xkcd-db-read num)))
      res))

  <span class="comment-delimiter">;; </span><span class="comment">since we've done this, we may as well go one little step further
</span>  (<span class="keyword">defun</span> <span class="function-name">+xkcd-find-and-copy</span> ()
    <span class="doc">"Prompt for an xkcd using `</span><span class="doc"><span class="constant">+xkcd-select</span></span><span class="doc">' and copy url to clipboard"</span>
    (<span class="keyword">interactive</span>)
    (+xkcd-copy (+xkcd-select)))

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-copy</span> (<span class="type">&amp;optional</span> num)
    <span class="doc">"Copy a url to xkcd NUM to the clipboard"</span>
    (<span class="keyword">interactive</span> <span class="string">"i"</span>)
    (<span class="keyword">let</span> ((num (<span class="keyword">or</span> num xkcd-cur)))
      (gui-select-text (format <span class="string">"https://xkcd.com/%d"</span> num))
      (message <span class="string">"xkcd.com/%d copied to clipboard"</span> num)))

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-find-and-view</span> ()
    <span class="doc">"Prompt for an xkcd using `</span><span class="doc"><span class="constant">+xkcd-select</span></span><span class="doc">' and view it"</span>
    (<span class="keyword">interactive</span>)
    (xkcd-get (+xkcd-select))
    (switch-to-buffer <span class="string">"*xkcd*"</span>))

  (<span class="keyword">defvar</span> <span class="variable-name">+xkcd-latest-max-age</span> (* <span class="highlight-numbers-number">60</span> <span class="highlight-numbers-number">60</span>) <span class="comment-delimiter">; </span><span class="comment">1 hour
</span>    <span class="doc">"Time after which xkcd-latest should be refreshed, in seconds"</span>)

  <span class="comment-delimiter">;; </span><span class="comment">initialise `</span><span class="comment"><span class="constant">xkcd-latest</span></span><span class="comment">' and `</span><span class="comment"><span class="constant">+xkcd-stored-info</span></span><span class="comment">' with latest xkcd
</span>  (<span class="keyword">add-transient-hook!</span> '+xkcd-select
    (<span class="keyword">require</span> '<span class="constant">xkcd</span>)
    (+xkcd-fetch-info xkcd-latest)
    (<span class="keyword">setq</span> +xkcd-stored-info (+xkcd-db-read-all)))

  (<span class="keyword">add-transient-hook!</span> '+xkcd-fetch-info
    (xkcd-update-latest))

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-check-latest</span> ()
    <span class="doc">"Use value in `</span><span class="doc"><span class="constant">xkcd-cache-latest</span></span><span class="doc">' as long as it isn't older thabn `</span><span class="doc"><span class="constant">+xkcd-latest-max-age</span></span><span class="doc">'"</span>
    (<span class="keyword">unless</span> (<span class="keyword">and</span> (file-exists-p xkcd-cache-latest)
                 (&lt; (- (time-to-seconds (current-time))
                       (time-to-seconds (file-attribute-modification-time (file-attributes xkcd-cache-latest))))
                    +xkcd-latest-max-age))
      (<span class="keyword">let*</span> ((out (xkcd-get-json <span class="string">"http://xkcd.com/info.0.json"</span> <span class="highlight-numbers-number">0</span>))
             (json-assoc (json-read-from-string out))
             (latest (cdr (assoc 'num json-assoc))))
        (<span class="keyword">when</span> (/= xkcd-latest latest)
          (+xkcd-db-write json-assoc)
          (<span class="keyword">with-current-buffer</span> (find-file xkcd-cache-latest)
            (<span class="keyword">setq</span> xkcd-latest latest)
            (erase-buffer)
            (insert (number-to-string latest))
            (save-buffer)
            (kill-buffer (current-buffer)))))
      (shell-command (format <span class="string">"touch %s"</span> xkcd-cache-latest))))

  (<span class="keyword">defvar</span> <span class="variable-name">+xkcd-stored-info</span> (make-hash-table <span class="builtin">:test</span> 'eql)
    <span class="doc">"Basic info on downloaded xkcds, in the form of a hashtable"</span>)

  (<span class="keyword">defadvice!</span> xkcd-get-json--and-cache (url <span class="type">&amp;optional</span> num)
    <span class="doc">"Fetch the Json coming from URL.
If the file NUM.json exists, use it instead.
If NUM is 0, always download from URL.
The return value is a string."</span>
    <span class="builtin">:override</span> #'xkcd-get-json
    (<span class="keyword">let*</span> ((file (format <span class="string">"%s%d.json"</span> xkcd-cache-dir num))
           (cached (<span class="keyword">and</span> (file-exists-p file) (not (eq num <span class="highlight-numbers-number">0</span>))))
           (out (<span class="keyword">with-current-buffer</span> (<span class="keyword">if</span> cached
                                         (find-file file)
                                       (url-retrieve-synchronously url))
                  (goto-char (point-min))
                  (<span class="keyword">unless</span> cached (re-search-forward <span class="string">"^$"</span>))
                  (<span class="keyword">prog1</span>
                      (buffer-substring-no-properties (point) (point-max))
                    (kill-buffer (current-buffer))))))
      (<span class="keyword">unless</span> (<span class="keyword">or</span> cached (eq num <span class="highlight-numbers-number">0</span>))
        (xkcd-cache-json num out))
      out))

  (<span class="keyword">defadvice!</span> +xkcd-get (num)
    <span class="doc">"Get the xkcd number NUM."</span>
    <span class="builtin">:override</span> 'xkcd-get
    (<span class="keyword">interactive</span> <span class="string">"nEnter comic number: "</span>)
    (xkcd-update-latest)
    (get-buffer-create <span class="string">"*xkcd*"</span>)
    (switch-to-buffer <span class="string">"*xkcd*"</span>)
    (xkcd-mode)
    (<span class="keyword">let</span> (buffer-read-only)
      (erase-buffer)
      (<span class="keyword">setq</span> xkcd-cur num)
      (<span class="keyword">let*</span> ((xkcd-data (+xkcd-fetch-info num))
             (num (plist-get xkcd-data <span class="builtin">:num</span>))
             (img (plist-get xkcd-data <span class="builtin">:img</span>))
             (safe-title (plist-get xkcd-data <span class="builtin">:safe-title</span>))
             (alt (plist-get xkcd-data <span class="builtin">:alt</span>))
             title file)
        (message <span class="string">"Getting comic..."</span>)
        (<span class="keyword">setq</span> file (xkcd-download img num))
        (<span class="keyword">setq</span> title (format <span class="string">"%d: %s"</span> num safe-title))
        (insert (propertize title
                            'face 'outline-1))
        (center-line)
        (insert <span class="string">"\n"</span>)
        (xkcd-insert-image file num)
        (<span class="keyword">if</span> (eq xkcd-cur <span class="highlight-numbers-number">0</span>)
            (<span class="keyword">setq</span> xkcd-cur num))
        (<span class="keyword">setq</span> xkcd-alt alt)
        (message <span class="string">"%s"</span> title))))

  (<span class="keyword">defconst</span> <span class="variable-name">+xkcd-db--sqlite-available-p</span>
    (<span class="keyword">with-demoted-errors</span> <span class="string">"+org-xkcd initialization: %S"</span>
      (emacsql-sqlite-ensure-binary)
      t))

  (<span class="keyword">defvar</span> <span class="variable-name">+xkcd-db--connection</span> (make-hash-table <span class="builtin">:test</span> #'equal)
    <span class="doc">"Database connection to +org-xkcd database."</span>)

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-db--get</span> ()
    <span class="doc">"Return the sqlite db file."</span>
    (expand-file-name <span class="string">"xkcd.db"</span> xkcd-cache-dir))

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-db--get-connection</span> ()
    <span class="doc">"Return the database connection, if any."</span>
    (gethash (file-truename xkcd-cache-dir)
             +xkcd-db--connection))

  (<span class="keyword">defconst</span> <span class="variable-name">+xkcd-db--table-schema</span>
    '((xkcds
       [(num integer <span class="builtin">:unique</span> <span class="builtin">:primary-key</span>)
        (year        <span class="builtin">:not-null</span>)
        (month       <span class="builtin">:not-null</span>)
        (link        <span class="builtin">:not-null</span>)
        (news        <span class="builtin">:not-null</span>)
        (safe_title  <span class="builtin">:not-null</span>)
        (title       <span class="builtin">:not-null</span>)
        (transcript  <span class="builtin">:not-null</span>)
        (alt         <span class="builtin">:not-null</span>)
        (img         <span class="builtin">:not-null</span>)])))

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-db--init</span> (db)
    <span class="doc">"Initialize database DB with the correct schema and user version."</span>
    (emacsql-with-transaction db
      (<span class="keyword">pcase-dolist</span> (`(,table . ,schema) +xkcd-db--table-schema)
        (emacsql db [<span class="builtin">:create-table</span> $i1 $S2] table schema))))

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-db</span> ()
    <span class="doc">"Entrypoint to the +org-xkcd sqlite database.
Initializes and stores the database, and the database connection.
Performs a database upgrade when required."</span>
    (<span class="keyword">unless</span> (<span class="keyword">and</span> (+xkcd-db--get-connection)
                 (emacsql-live-p (+xkcd-db--get-connection)))
      (<span class="keyword">let*</span> ((db-file (+xkcd-db--get))
             (init-db (not (file-exists-p db-file))))
        (make-directory (file-name-directory db-file) t)
        (<span class="keyword">let</span> ((conn (emacsql-sqlite db-file)))
          (set-process-query-on-exit-flag (emacsql-process conn) nil)
          (puthash (file-truename xkcd-cache-dir)
                   conn
                   +xkcd-db--connection)
          (<span class="keyword">when</span> init-db
            (+xkcd-db--init conn)))))
    (+xkcd-db--get-connection))

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-db-query</span> (sql <span class="type">&amp;rest</span> args)
    <span class="doc">"Run SQL query on +org-xkcd database with ARGS.
SQL can be either the emacsql vector representation, or a string."</span>
    (<span class="keyword">if</span>  (stringp sql)
        (emacsql (+xkcd-db) (apply #'format sql args))
      (apply #'emacsql (+xkcd-db) sql args)))

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-db-read</span> (num)
    (<span class="keyword">when-let</span> ((res
                (car (+xkcd-db-query [<span class="builtin">:select</span> * <span class="builtin">:from</span> xkcds
                                      <span class="builtin">:where</span> (= num $s1)]
                                     num
                                     <span class="builtin">:limit</span> <span class="highlight-numbers-number">1</span>))))
      (+xkcd-db-list-to-plist res)))

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-db-read-all</span> ()
    (<span class="keyword">let</span> ((xkcd-table (make-hash-table <span class="builtin">:test</span> 'eql <span class="builtin">:size</span> <span class="highlight-numbers-number">4000</span>)))
      (mapcar (<span class="keyword">lambda</span> (xkcd-info-list)
                (puthash (car xkcd-info-list) (+xkcd-db-list-to-plist xkcd-info-list) xkcd-table))
              (+xkcd-db-query [<span class="builtin">:select</span> * <span class="builtin">:from</span> xkcds]))
      xkcd-table))

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-db-list-to-plist</span> (xkcd-datalist)
    `(<span class="builtin">:num</span> ,(nth <span class="highlight-numbers-number">0</span> xkcd-datalist)
      <span class="builtin">:year</span> ,(nth <span class="highlight-numbers-number">1</span> xkcd-datalist)
      <span class="builtin">:month</span> ,(nth <span class="highlight-numbers-number">2</span> xkcd-datalist)
      <span class="builtin">:link</span> ,(nth <span class="highlight-numbers-number">3</span> xkcd-datalist)
      <span class="builtin">:news</span> ,(nth <span class="highlight-numbers-number">4</span> xkcd-datalist)
      <span class="builtin">:safe-title</span> ,(nth <span class="highlight-numbers-number">5</span> xkcd-datalist)
      <span class="builtin">:title</span> ,(nth <span class="highlight-numbers-number">6</span> xkcd-datalist)
      <span class="builtin">:transcript</span> ,(nth <span class="highlight-numbers-number">7</span> xkcd-datalist)
      <span class="builtin">:alt</span> ,(nth <span class="highlight-numbers-number">8</span> xkcd-datalist)
      <span class="builtin">:img</span> ,(nth <span class="highlight-numbers-number">9</span> xkcd-datalist)))

  (<span class="keyword">defun</span> <span class="function-name">+xkcd-db-write</span> (data)
    (+xkcd-db-query [<span class="builtin">:insert-into</span> xkcds
                     <span class="builtin">:values</span> $v1]
                    (list (vector
                           (cdr (assoc 'num        data))
                           (cdr (assoc 'year       data))
                           (cdr (assoc 'month      data))
                           (cdr (assoc 'link       data))
                           (cdr (assoc 'news       data))
                           (cdr (assoc 'safe_title data))
                           (cdr (assoc 'title      data))
                           (cdr (assoc 'transcript data))
                           (cdr (assoc 'alt        data))
                           (cdr (assoc 'img        data))
                           )))))
<span class="comment-delimiter">;; </span><span class="comment">xkcd:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*YASnippet][YASnippet:1]]
</span>(<span class="keyword">setq</span> yas-triggers-in-field t)
<span class="comment-delimiter">;; </span><span class="comment">YASnippet:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Ebooks][Ebooks:1]]
</span>(<span class="keyword">use-package!</span> calibredb
  <span class="builtin">:commands</span> calibredb
  <span class="builtin">:config</span>
  (<span class="keyword">setq</span> calibredb-root-dir <span class="string">"~/Desktop/TEC/Other/Ebooks"</span>
        calibredb-db-dir (expand-file-name <span class="string">"metadata.db"</span> calibredb-root-dir))
  (<span class="keyword">map!</span> <span class="builtin">:map</span> calibredb-show-mode-map
        <span class="builtin">:ne</span> <span class="string">"?"</span> #'calibredb-entry-dispatch
        <span class="builtin">:ne</span> <span class="string">"o"</span> #'calibredb-find-file
        <span class="builtin">:ne</span> <span class="string">"O"</span> #'calibredb-find-file-other-frame
        <span class="builtin">:ne</span> <span class="string">"V"</span> #'calibredb-open-file-with-default-tool
        <span class="builtin">:ne</span> <span class="string">"s"</span> #'calibredb-set-metadata-dispatch
        <span class="builtin">:ne</span> <span class="string">"e"</span> #'calibredb-export-dispatch
        <span class="builtin">:ne</span> <span class="string">"q"</span> #'calibredb-entry-quit
        <span class="builtin">:ne</span> <span class="string">"."</span> #'calibredb-open-dired
        <span class="builtin">:ne</span> [tab] #'calibredb-toggle-view-at-point
        <span class="builtin">:ne</span> <span class="string">"M-t"</span> #'calibredb-set-metadata--tags
        <span class="builtin">:ne</span> <span class="string">"M-a"</span> #'calibredb-set-metadata--author_sort
        <span class="builtin">:ne</span> <span class="string">"M-A"</span> #'calibredb-set-metadata--authors
        <span class="builtin">:ne</span> <span class="string">"M-T"</span> #'calibredb-set-metadata--title
        <span class="builtin">:ne</span> <span class="string">"M-c"</span> #'calibredb-set-metadata--comments)
  (<span class="keyword">map!</span> <span class="builtin">:map</span> calibredb-search-mode-map
        <span class="builtin">:ne</span> [mouse-3] #'calibredb-search-mouse
        <span class="builtin">:ne</span> <span class="string">"RET"</span> #'calibredb-find-file
        <span class="builtin">:ne</span> <span class="string">"?"</span> #'calibredb-dispatch
        <span class="builtin">:ne</span> <span class="string">"a"</span> #'calibredb-add
        <span class="builtin">:ne</span> <span class="string">"A"</span> #'calibredb-add-dir
        <span class="builtin">:ne</span> <span class="string">"c"</span> #'calibredb-clone
        <span class="builtin">:ne</span> <span class="string">"d"</span> #'calibredb-remove
        <span class="builtin">:ne</span> <span class="string">"D"</span> #'calibredb-remove-marked-items
        <span class="builtin">:ne</span> <span class="string">"j"</span> #'calibredb-next-entry
        <span class="builtin">:ne</span> <span class="string">"k"</span> #'calibredb-previous-entry
        <span class="builtin">:ne</span> <span class="string">"l"</span> #'calibredb-virtual-library-list
        <span class="builtin">:ne</span> <span class="string">"L"</span> #'calibredb-library-list
        <span class="builtin">:ne</span> <span class="string">"n"</span> #'calibredb-virtual-library-next
        <span class="builtin">:ne</span> <span class="string">"N"</span> #'calibredb-library-next
        <span class="builtin">:ne</span> <span class="string">"p"</span> #'calibredb-virtual-library-previous
        <span class="builtin">:ne</span> <span class="string">"P"</span> #'calibredb-library-previous
        <span class="builtin">:ne</span> <span class="string">"s"</span> #'calibredb-set-metadata-dispatch
        <span class="builtin">:ne</span> <span class="string">"S"</span> #'calibredb-switch-library
        <span class="builtin">:ne</span> <span class="string">"o"</span> #'calibredb-find-file
        <span class="builtin">:ne</span> <span class="string">"O"</span> #'calibredb-find-file-other-frame
        <span class="builtin">:ne</span> <span class="string">"v"</span> #'calibredb-view
        <span class="builtin">:ne</span> <span class="string">"V"</span> #'calibredb-open-file-with-default-tool
        <span class="builtin">:ne</span> <span class="string">"."</span> #'calibredb-open-dired
        <span class="builtin">:ne</span> <span class="string">"b"</span> #'calibredb-catalog-bib-dispatch
        <span class="builtin">:ne</span> <span class="string">"e"</span> #'calibredb-export-dispatch
        <span class="builtin">:ne</span> <span class="string">"r"</span> #'calibredb-search-refresh-and-clear-filter
        <span class="builtin">:ne</span> <span class="string">"R"</span> #'calibredb-search-clear-filter
        <span class="builtin">:ne</span> <span class="string">"q"</span> #'calibredb-search-quit
        <span class="builtin">:ne</span> <span class="string">"m"</span> #'calibredb-mark-and-forward
        <span class="builtin">:ne</span> <span class="string">"f"</span> #'calibredb-toggle-favorite-at-point
        <span class="builtin">:ne</span> <span class="string">"x"</span> #'calibredb-toggle-archive-at-point
        <span class="builtin">:ne</span> <span class="string">"h"</span> #'calibredb-toggle-highlight-at-point
        <span class="builtin">:ne</span> <span class="string">"u"</span> #'calibredb-unmark-and-forward
        <span class="builtin">:ne</span> <span class="string">"i"</span> #'calibredb-edit-annotation
        <span class="builtin">:ne</span> <span class="string">"DEL"</span> #'calibredb-unmark-and-backward
        <span class="builtin">:ne</span> [backtab] #'calibredb-toggle-view
        <span class="builtin">:ne</span> [tab] #'calibredb-toggle-view-at-point
        <span class="builtin">:ne</span> <span class="string">"M-n"</span> #'calibredb-show-next-entry
        <span class="builtin">:ne</span> <span class="string">"M-p"</span> #'calibredb-show-previous-entry
        <span class="builtin">:ne</span> <span class="string">"/"</span> #'calibredb-search-live-filter
        <span class="builtin">:ne</span> <span class="string">"M-t"</span> #'calibredb-set-metadata--tags
        <span class="builtin">:ne</span> <span class="string">"M-a"</span> #'calibredb-set-metadata--author_sort
        <span class="builtin">:ne</span> <span class="string">"M-A"</span> #'calibredb-set-metadata--authors
        <span class="builtin">:ne</span> <span class="string">"M-T"</span> #'calibredb-set-metadata--title
        <span class="builtin">:ne</span> <span class="string">"M-c"</span> #'calibredb-set-metadata--comments))
<span class="comment-delimiter">;; </span><span class="comment">Ebooks:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Ebooks][Ebooks:2]]
</span>(<span class="keyword">use-package!</span> nov
  <span class="builtin">:mode</span> (<span class="string">"\\.epub\\'"</span> . nov-mode)
  <span class="builtin">:config</span>
  (<span class="keyword">map!</span> <span class="builtin">:map</span> nov-mode-map
        <span class="builtin">:n</span> <span class="string">"RET"</span> #'nov-scroll-up)

  (<span class="keyword">defun</span> <span class="function-name">doom-modeline-segment--nov-info</span> ()
    (concat
     <span class="string">" "</span>
     (propertize
      (cdr (assoc 'creator nov-metadata))
      'face 'doom-modeline-project-parent-dir)
     <span class="string">" "</span>
     (cdr (assoc 'title nov-metadata))
     <span class="string">" "</span>
     (propertize
      (format <span class="string">"%d/%d"</span>
              (1+ nov-documents-index)
              (length nov-documents))
      'face 'doom-modeline-info)))

  (advice-add 'nov-render-title <span class="builtin">:override</span> #'ignore)

  (<span class="keyword">defun</span> <span class="function-name">+nov-mode-setup</span> ()
    (face-remap-add-relative 'variable-pitch
                             <span class="builtin">:family</span> <span class="string">"Merriweather"</span>
                             <span class="builtin">:height</span> <span class="highlight-numbers-number">1.4</span>
                             <span class="builtin">:width</span> 'semi-expanded)
    (face-remap-add-relative 'default <span class="builtin">:height</span> <span class="highlight-numbers-number">1.3</span>)
    (<span class="keyword">setq-local</span> line-spacing <span class="highlight-numbers-number">0.2</span>
                next-screen-context-lines <span class="highlight-numbers-number">4</span>
                shr-use-colors nil)
    (<span class="keyword">require</span> '<span class="constant">visual-fill-column</span> nil t)
    (<span class="keyword">setq-local</span> visual-fill-column-center-text t
                visual-fill-column-width <span class="highlight-numbers-number">80</span>
                nov-text-width <span class="highlight-numbers-number">80</span>)
    (visual-fill-column-mode <span class="highlight-numbers-number">1</span>)
    (hl-line-mode <span class="highlight-numbers-number">-1</span>)

    (add-to-list '+lookup-definition-functions #'+lookup/dictionary-definition)

    (<span class="keyword">setq-local</span> mode-line-format
                `((<span class="builtin">:eval</span>
                   (doom-modeline-segment--workspace-name))
                  (<span class="builtin">:eval</span>
                   (doom-modeline-segment--window-number))
                  (<span class="builtin">:eval</span>
                   (doom-modeline-segment--nov-info))
                  ,(propertize
                    <span class="string">" %P "</span>
                    'face 'doom-modeline-buffer-minor-mode)
                  ,(propertize
                    <span class="string">" "</span>
                    'face (<span class="keyword">if</span> (doom-modeline--active) 'mode-line 'mode-line-inactive)
                    'display `((space
                                <span class="builtin">:align-to</span>
                                (- (+ right right-fringe right-margin)
                                   ,(* (<span class="keyword">let</span> ((width (doom-modeline--font-width)))
                                         (<span class="keyword">or</span> (<span class="keyword">and</span> (= width <span class="highlight-numbers-number">1</span>) <span class="highlight-numbers-number">1</span>)
                                             (/ width (frame-char-width) <span class="highlight-numbers-number">1.0</span>)))
                                       (string-width
                                        (format-mode-line (cons <span class="string">""</span> '(<span class="builtin">:eval</span> (doom-modeline-segment--major-mode))))))))))
                  (<span class="builtin">:eval</span> (doom-modeline-segment--major-mode)))))

  (add-hook 'nov-mode-hook #'+nov-mode-setup))
<span class="comment-delimiter">;; </span><span class="comment">Ebooks:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*IRC][IRC:3]]
</span>(<span class="keyword">after!</span> circe
  (<span class="keyword">setq-default</span> circe-use-tls t)
  (<span class="keyword">setq</span> circe-notifications-alert-icon <span class="string">"/usr/share/icons/breeze/actions/24/network-connect.svg"</span>
        lui-logging-directory <span class="string">"~/.emacs.d/.local/etc/irc"</span>
        lui-logging-file-format <span class="string">"{buffer}/%Y/%m-%d.txt"</span>
        circe-format-self-say <span class="string">"{nick:+13s} &#226;&#148;&#131; {body}"</span>)

  (<span class="keyword">custom-set-faces!</span>
    '(circe-my-message-face <span class="builtin">:weight</span> unspecified))

  (enable-lui-logging-globally)
  (enable-circe-display-images)

  (<span class="keyword">defun</span> <span class="function-name">lui-org-to-irc</span> ()
    <span class="doc">"Examine a buffer with simple org-mode formatting, and converts the empasis:
  *bold*, /italic/, and _underline_ to IRC semi-standard escape codes.
  =code= is converted to inverse (highlighted) text."</span>
    (goto-char (point-min))
    (<span class="keyword">while</span> (re-search-forward <span class="string">"\\_&lt;</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(?1:</span></span><span class="string">[*/_=]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(?2:</span></span><span class="string">[</span><span class="string"><span class="negation-char">^</span></span><span class="string">[:space:]]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(?:</span></span><span class="string">.*?[</span><span class="string"><span class="negation-char">^</span></span><span class="string">[:space:]]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">?</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">\\1\\_&gt;"</span> nil t)
      (replace-match
       (concat (<span class="keyword">pcase</span> (match-string <span class="highlight-numbers-number">1</span>)
                 (<span class="string">"*"</span> <span class="string">"&#2;"</span>)
                 (<span class="string">"/"</span> <span class="string">"&#29;"</span>)
                 (<span class="string">"_"</span> <span class="string">"&#31;"</span>)
                 (<span class="string">"="</span> <span class="string">"&#22;"</span>))
               (match-string <span class="highlight-numbers-number">2</span>)
               <span class="string">"&#15;"</span>) <span class="warning-1">nil nil)))</span>
  
  (add-hook 'lui-pre-input-hook #'lui-org-to-irc)

  (<span class="keyword">defun</span> <span class="function-name">lui-ascii-to-emoji</span> ()
    (goto-char (point-min))
    (<span class="keyword">while</span> (re-search-forward <span class="string">"</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string"> </span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">?::?</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[</span><span class="string"><span class="negation-char">^</span></span><span class="string">[:space:]:]+</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">:</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string"> </span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">?"</span> nil t)
      (replace-match
       (concat
        (match-string <span class="highlight-numbers-number">1</span>)
        (<span class="keyword">or</span> (cdr (assoc (match-string <span class="highlight-numbers-number">2</span>) lui-emojis-alist))
            (concat <span class="string">":"</span> (match-string <span class="highlight-numbers-number">2</span>) <span class="string">":"</span>))
        (match-string <span class="highlight-numbers-number">3</span>))
       nil nil)))
  
  (<span class="keyword">defun</span> <span class="function-name">lui-emoticon-to-emoji</span> ()
    (<span class="keyword">dolist</span> (emoticon lui-emoticons-alist)
      (goto-char (point-min))
      (<span class="keyword">while</span> (re-search-forward (concat <span class="string">" "</span> (car emoticon) <span class="string">"</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string"> </span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">?"</span>) nil t)
        (replace-match (concat <span class="string">" "</span>
                               (cdr (assoc (cdr emoticon) lui-emojis-alist))
                               (match-string <span class="highlight-numbers-number">1</span>))))))
  
  (<span class="keyword">define-minor-mode</span> <span class="function-name">lui-emojify</span>
    <span class="doc">"Replace :emojis: and ;) emoticons with unicode emoji chars."</span>
    <span class="builtin">:global</span> t
    <span class="builtin">:init-value</span> t
    (<span class="keyword">if</span> lui-emojify
        (<span class="keyword">add-hook!</span> lui-pre-input #'lui-ascii-to-emoji #'lui-emoticon-to-emoji)
      (<span class="keyword">remove-hook!</span> lui-pre-input #'lui-ascii-to-emoji #'lui-emoticon-to-emoji)))
  (<span class="keyword">defvar</span> <span class="variable-name">lui-emojis-alist</span>
    '((<span class="string">"grinning"</span>                      . <span class="string">"&#240;&#159;&#152;&#128;"</span>)
      (<span class="string">"smiley"</span>                        . <span class="string">"&#240;&#159;&#152;&#131;"</span>)
      (<span class="string">"smile"</span>                         . <span class="string">"&#240;&#159;&#152;&#132;"</span>)
      (<span class="string">"grin"</span>                          . <span class="string">"&#240;&#159;&#152;&#129;"</span>)
      (<span class="string">"laughing"</span>                      . <span class="string">"&#240;&#159;&#152;&#134;"</span>)
      (<span class="string">"sweat_smile"</span>                   . <span class="string">"&#240;&#159;&#152;&#133;"</span>)
      (<span class="string">"joy"</span>                           . <span class="string">"&#240;&#159;&#152;&#130;"</span>)
      (<span class="string">"rofl"</span>                          . <span class="string">"&#240;&#159;&#164;&#163;"</span>)
      (<span class="string">"relaxed"</span>                       . <span class="string">"&#226;&#152;&#186;&#239;&#184;&#143;"</span>)
      (<span class="string">"blush"</span>                         . <span class="string">"&#240;&#159;&#152;&#138;"</span>)
      (<span class="string">"innocent"</span>                      . <span class="string">"&#240;&#159;&#152;&#135;"</span>)
      (<span class="string">"slight_smile"</span>                  . <span class="string">"&#240;&#159;&#153;&#130;"</span>)
      (<span class="string">"upside_down"</span>                   . <span class="string">"&#240;&#159;&#153;&#131;"</span>)
      (<span class="string">"wink"</span>                          . <span class="string">"&#240;&#159;&#152;&#137;"</span>)
      (<span class="string">"relieved"</span>                      . <span class="string">"&#240;&#159;&#152;&#140;"</span>)
      (<span class="string">"heart_eyes"</span>                    . <span class="string">"&#240;&#159;&#152;&#141;"</span>)
      (<span class="string">"yum"</span>                           . <span class="string">"&#240;&#159;&#152;&#139;"</span>)
      (<span class="string">"stuck_out_tongue"</span>              . <span class="string">"&#240;&#159;&#152;&#155;"</span>)
      (<span class="string">"stuck_out_tongue_closed_eyes"</span>  . <span class="string">"&#240;&#159;&#152;&#157;"</span>)
      (<span class="string">"stuck_out_tongue_wink"</span>         . <span class="string">"&#240;&#159;&#152;&#156;"</span>)
      (<span class="string">"zanzy"</span>                         . <span class="string">"&#240;&#159;&#164;&#170;"</span>)
      (<span class="string">"raised_eyebrow"</span>                . <span class="string">"&#240;&#159;&#164;&#168;"</span>)
      (<span class="string">"monocle"</span>                       . <span class="string">"&#240;&#159;&#167;&#144;"</span>)
      (<span class="string">"nerd"</span>                          . <span class="string">"&#240;&#159;&#164;&#147;"</span>)
      (<span class="string">"cool"</span>                          . <span class="string">"&#240;&#159;&#152;&#142;"</span>)
      (<span class="string">"star_struck"</span>                   . <span class="string">"&#240;&#159;&#164;&#169;"</span>)
      (<span class="string">"party"</span>                         . <span class="string">"&#240;&#159;&#165;&#179;"</span>)
      (<span class="string">"smirk"</span>                         . <span class="string">"&#240;&#159;&#152;&#143;"</span>)
      (<span class="string">"unamused"</span>                      . <span class="string">"&#240;&#159;&#152;&#146;"</span>)
      (<span class="string">"disapointed"</span>                   . <span class="string">"&#240;&#159;&#152;&#158;"</span>)
      (<span class="string">"pensive"</span>                       . <span class="string">"&#240;&#159;&#152;&#148;"</span>)
      (<span class="string">"worried"</span>                       . <span class="string">"&#240;&#159;&#152;&#159;"</span>)
      (<span class="string">"confused"</span>                      . <span class="string">"&#240;&#159;&#152;&#149;"</span>)
      (<span class="string">"slight_frown"</span>                  . <span class="string">"&#240;&#159;&#153;&#129;"</span>)
      (<span class="string">"frown"</span>                         . <span class="string">"&#226;&#152;&#185;&#239;&#184;&#143;"</span>)
      (<span class="string">"persevere"</span>                     . <span class="string">"&#240;&#159;&#152;&#163;"</span>)
      (<span class="string">"confounded"</span>                    . <span class="string">"&#240;&#159;&#152;&#150;"</span>)
      (<span class="string">"tired"</span>                         . <span class="string">"&#240;&#159;&#152;&#171;"</span>)
      (<span class="string">"weary"</span>                         . <span class="string">"&#240;&#159;&#152;&#169;"</span>)
      (<span class="string">"pleading"</span>                      . <span class="string">"&#240;&#159;&#165;&#186;"</span>)
      (<span class="string">"tear"</span>                          . <span class="string">"&#240;&#159;&#152;&#162;"</span>)
      (<span class="string">"cry"</span>                           . <span class="string">"&#240;&#159;&#152;&#162;"</span>)
      (<span class="string">"sob"</span>                           . <span class="string">"&#240;&#159;&#152;&#173;"</span>)
      (<span class="string">"triumph"</span>                       . <span class="string">"&#240;&#159;&#152;&#164;"</span>)
      (<span class="string">"angry"</span>                         . <span class="string">"&#240;&#159;&#152;&#160;"</span>)
      (<span class="string">"rage"</span>                          . <span class="string">"&#240;&#159;&#152;&#161;"</span>)
      (<span class="string">"exploding_head"</span>                . <span class="string">"&#240;&#159;&#164;&#175;"</span>)
      (<span class="string">"flushed"</span>                       . <span class="string">"&#240;&#159;&#152;&#179;"</span>)
      (<span class="string">"hot"</span>                           . <span class="string">"&#240;&#159;&#165;&#181;"</span>)
      (<span class="string">"cold"</span>                          . <span class="string">"&#240;&#159;&#165;&#182;"</span>)
      (<span class="string">"scream"</span>                        . <span class="string">"&#240;&#159;&#152;&#177;"</span>)
      (<span class="string">"fearful"</span>                       . <span class="string">"&#240;&#159;&#152;&#168;"</span>)
      (<span class="string">"disapointed"</span>                   . <span class="string">"&#240;&#159;&#152;&#176;"</span>)
      (<span class="string">"relieved"</span>                      . <span class="string">"&#240;&#159;&#152;&#165;"</span>)
      (<span class="string">"sweat"</span>                         . <span class="string">"&#240;&#159;&#152;&#147;"</span>)
      (<span class="string">"thinking"</span>                      . <span class="string">"&#240;&#159;&#164;&#148;"</span>)
      (<span class="string">"shush"</span>                         . <span class="string">"&#240;&#159;&#164;&#171;"</span>)
      (<span class="string">"liar"</span>                          . <span class="string">"&#240;&#159;&#164;&#165;"</span>)
      (<span class="string">"blank_face"</span>                    . <span class="string">"&#240;&#159;&#152;&#182;"</span>)
      (<span class="string">"neutral"</span>                       . <span class="string">"&#240;&#159;&#152;&#144;"</span>)
      (<span class="string">"expressionless"</span>                . <span class="string">"&#240;&#159;&#152;&#145;"</span>)
      (<span class="string">"grimace"</span>                       . <span class="string">"&#240;&#159;&#152;&#172;"</span>)
      (<span class="string">"rolling_eyes"</span>                  . <span class="string">"&#240;&#159;&#153;&#132;"</span>)
      (<span class="string">"hushed"</span>                        . <span class="string">"&#240;&#159;&#152;&#175;"</span>)
      (<span class="string">"frowning"</span>                      . <span class="string">"&#240;&#159;&#152;&#166;"</span>)
      (<span class="string">"anguished"</span>                     . <span class="string">"&#240;&#159;&#152;&#167;"</span>)
      (<span class="string">"wow"</span>                           . <span class="string">"&#240;&#159;&#152;&#174;"</span>)
      (<span class="string">"astonished"</span>                    . <span class="string">"&#240;&#159;&#152;&#178;"</span>)
      (<span class="string">"sleeping"</span>                      . <span class="string">"&#240;&#159;&#152;&#180;"</span>)
      (<span class="string">"drooling"</span>                      . <span class="string">"&#240;&#159;&#164;&#164;"</span>)
      (<span class="string">"sleepy"</span>                        . <span class="string">"&#240;&#159;&#152;&#170;"</span>)
      (<span class="string">"dizzy"</span>                         . <span class="string">"&#240;&#159;&#152;&#181;"</span>)
      (<span class="string">"zipper_mouth"</span>                  . <span class="string">"&#240;&#159;&#164;&#144;"</span>)
      (<span class="string">"woozy"</span>                         . <span class="string">"&#240;&#159;&#165;&#180;"</span>)
      (<span class="string">"sick"</span>                          . <span class="string">"&#240;&#159;&#164;&#162;"</span>)
      (<span class="string">"vomiting"</span>                      . <span class="string">"&#240;&#159;&#164;&#174;"</span>)
      (<span class="string">"sneeze"</span>                        . <span class="string">"&#240;&#159;&#164;&#167;"</span>)
      (<span class="string">"mask"</span>                          . <span class="string">"&#240;&#159;&#152;&#183;"</span>)
      (<span class="string">"bandaged_head"</span>                 . <span class="string">"&#240;&#159;&#164;&#149;"</span>)
      (<span class="string">"money_face"</span>                    . <span class="string">"&#240;&#159;&#164;&#145;"</span>)
      (<span class="string">"cowboy"</span>                        . <span class="string">"&#240;&#159;&#164;&#160;"</span>)
      (<span class="string">"imp"</span>                           . <span class="string">"&#240;&#159;&#152;&#136;"</span>)
      (<span class="string">"ghost"</span>                         . <span class="string">"&#240;&#159;&#145;&#187;"</span>)
      (<span class="string">"alien"</span>                         . <span class="string">"&#240;&#159;&#145;&#189;"</span>)
      (<span class="string">"robot"</span>                         . <span class="string">"&#240;&#159;&#164;&#150;"</span>)
      (<span class="string">"clap"</span>                          . <span class="string">"&#240;&#159;&#145;&#143;"</span>)
      (<span class="string">"thumpup"</span>                       . <span class="string">"&#240;&#159;&#145;&#141;"</span>)
      (<span class="string">"+1"</span>                            . <span class="string">"&#240;&#159;&#145;&#141;"</span>)
      (<span class="string">"thumbdown"</span>                     . <span class="string">"&#240;&#159;&#145;&#142;"</span>)
      (<span class="string">"-1"</span>                            . <span class="string">"&#240;&#159;&#145;&#142;"</span>)
      (<span class="string">"ok"</span>                            . <span class="string">"&#240;&#159;&#145;&#140;"</span>)
      (<span class="string">"pinch"</span>                         . <span class="string">"&#240;&#159;&#164;&#143;"</span>)
      (<span class="string">"left"</span>                          . <span class="string">"&#240;&#159;&#145;&#136;"</span>)
      (<span class="string">"right"</span>                         . <span class="string">"&#240;&#159;&#145;&#137;"</span>)
      (<span class="string">"down"</span>                          . <span class="string">"&#240;&#159;&#145;&#135;"</span>)
      (<span class="string">"wave"</span>                          . <span class="string">"&#240;&#159;&#145;&#139;"</span>)
      (<span class="string">"pray"</span>                          . <span class="string">"&#240;&#159;&#153;&#143;"</span>)
      (<span class="string">"eyes"</span>                          . <span class="string">"&#240;&#159;&#145;&#128;"</span>)
      (<span class="string">"brain"</span>                         . <span class="string">"&#240;&#159;&#167;&#160;"</span>)
      (<span class="string">"facepalm"</span>                      . <span class="string">"&#240;&#159;&#164;&#166;"</span>)
      (<span class="string">"tada"</span>                          . <span class="string">"&#240;&#159;&#142;&#137;"</span>)
      (<span class="string">"fire"</span>                          . <span class="string">"&#240;&#159;&#148;&#165;"</span>)
      (<span class="string">"flying_money"</span>                  . <span class="string">"&#240;&#159;&#146;&#184;"</span>)
      (<span class="string">"lighbulb"</span>                      . <span class="string">"&#240;&#159;&#146;&#161;"</span>)
      (<span class="string">"heart"</span>                         . <span class="string">"&#226;&#157;&#164;&#239;&#184;&#143;"</span>)
      (<span class="string">"sparkling_heart"</span>               . <span class="string">"&#240;&#159;&#146;&#150;"</span>)
      (<span class="string">"heartbreak"</span>                    . <span class="string">"&#240;&#159;&#146;&#148;"</span>)
      (<span class="string">"100"</span>                           . <span class="string">"&#240;&#159;&#146;&#175;"</span>)))
  
  (<span class="keyword">defvar</span> <span class="variable-name">lui-emoticons-alist</span>
    '((<span class="string">":)"</span>   . <span class="string">"slight_smile"</span>)
      (<span class="string">";)"</span>   . <span class="string">"wink"</span>)
      (<span class="string">":D"</span>   . <span class="string">"smile"</span>)
      (<span class="string">"=D"</span>   . <span class="string">"grin"</span>)
      (<span class="string">"xD"</span>   . <span class="string">"laughing"</span>)
      (<span class="string">";("</span>   . <span class="string">"joy"</span>)
      (<span class="string">":P"</span>   . <span class="string">"stuck_out_tongue"</span>)
      (<span class="string">";D"</span>   . <span class="string">"stuck_out_tongue_wink"</span>)
      (<span class="string">"xP"</span>   . <span class="string">"stuck_out_tongue_closed_eyes"</span>)
      (<span class="string">":("</span>   . <span class="string">"slight_frown"</span>)
      (<span class="string">";("</span>   . <span class="string">"cry"</span>)
      (<span class="string">";'("</span>  . <span class="string">"sob"</span>)
      (<span class="string">"&gt;:("</span>  . <span class="string">"angry"</span>)
      (<span class="string">"&gt;&gt;:("</span> . <span class="string">"rage"</span>)
      (<span class="string">":o"</span>   . <span class="string">"wow"</span>)
      (<span class="string">":O"</span>   . <span class="string">"astonished"</span>)
      (<span class="string">":/"</span>   . <span class="string">"confused"</span>)
      (<span class="string">":-/"</span>  . <span class="string">"thinking"</span>)
      (<span class="string">":|"</span>   . <span class="string">"neutral"</span>)
      (<span class="string">":-|"</span>  . <span class="string">"expressionless"</span>)))

  (<span class="keyword">defun</span> <span class="function-name">named-circe-prompt</span> ()
    (lui-set-prompt
     (concat (propertize (format <span class="string">"%13s &gt; "</span> (circe-nick))
                         'face 'circe-prompt-face)
             <span class="string">""</span>)))
  (add-hook 'circe-chat-mode-hook #'named-circe-prompt)

  (<span class="keyword">appendq!</span> all-the-icons-mode-icon-alist
            '((circe-channel-mode all-the-icons-material <span class="string">"message"</span> <span class="builtin">:face</span> all-the-icons-lblue)
              (circe-server-mode all-the-icons-material <span class="string">"chat_bubble_outline"</span> <span class="builtin">:face</span> all-the-icons-purple))))

(<span class="keyword">defun</span> <span class="function-name">auth-server-pass</span> (server)
  (<span class="keyword">if-let</span> ((secret (plist-get (car (auth-source-search <span class="builtin">:host</span> server)) <span class="builtin">:secret</span>)))
      (<span class="keyword">if</span> (functionp secret)
          (funcall secret) secret)
    (<span class="warning-1">error</span> <span class="string">"Could not fetch password for host %s"</span> server)))

(<span class="keyword">defun</span> <span class="function-name">register-irc-auths</span> ()
  (<span class="keyword">require</span> '<span class="constant">circe</span>)
  (<span class="keyword">require</span> '<span class="constant">dash</span>)
  (<span class="keyword">let</span> ((accounts (-filter (<span class="keyword">lambda</span> (a) (string= <span class="string">"irc"</span> (plist-get a <span class="builtin">:for</span>)))
                           (auth-source-search <span class="builtin">:require</span> '(<span class="builtin">:for</span>) <span class="builtin">:max</span> <span class="highlight-numbers-number">10</span>))))
    (<span class="keyword">appendq!</span> circe-network-options
              (mapcar (<span class="keyword">lambda</span> (entry)
                        (<span class="keyword">let*</span> ((host (plist-get entry <span class="builtin">:host</span>))
                               (label (<span class="keyword">or</span> (plist-get entry <span class="builtin">:label</span>) host))
                               (_ports (mapcar #'string-to-number
                                               (s-split <span class="string">","</span> (plist-get entry <span class="builtin">:port</span>))))
                               (port (<span class="keyword">if</span> (= <span class="highlight-numbers-number">1</span> (length _ports)) (car _ports) _ports))
                               (user (plist-get entry <span class="builtin">:user</span>))
                               (nick (<span class="keyword">or</span> (plist-get entry <span class="builtin">:nick</span>) user))
                               (channels (mapcar (<span class="keyword">lambda</span> (c) (concat <span class="string">"#"</span> c))
                                                 (s-split <span class="string">","</span> (plist-get entry <span class="builtin">:channels</span>)))))
                          `(,label
                            <span class="builtin">:host</span> ,host <span class="builtin">:port</span> ,port <span class="builtin">:nick</span> ,nick
                            <span class="builtin">:sasl-username</span> ,user <span class="builtin">:sasl-password</span> auth-server-pass
                            <span class="builtin">:channels</span> ,channels)))
                      accounts))))

(<span class="keyword">add-transient-hook!</span> #'=irc (register-irc-auths))
<span class="comment-delimiter">;; </span><span class="comment">IRC:3 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::org-emph-to-irc][org-emph-to-irc]]
</span>(<span class="keyword">defun</span> <span class="function-name">lui-org-to-irc</span> ()
  <span class="doc">"Examine a buffer with simple org-mode formatting, and converts the empasis:
*bold*, /italic/, and _underline_ to IRC semi-standard escape codes.
=code= is converted to inverse (highlighted) text."</span>
  (goto-char (point-min))
  (<span class="keyword">while</span> (re-search-forward <span class="string">"\\_&lt;</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(?1:</span></span><span class="string">[*/_=]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(?2:</span></span><span class="string">[</span><span class="string"><span class="negation-char">^</span></span><span class="string">[:space:]]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(?:</span></span><span class="string">.*?[</span><span class="string"><span class="negation-char">^</span></span><span class="string">[:space:]]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">?</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">\\1\\_&gt;"</span> nil t)
    (replace-match
     (concat (<span class="keyword">pcase</span> (match-string <span class="highlight-numbers-number">1</span>)
               (<span class="string">"*"</span> <span class="string">"&#2;"</span>)
               (<span class="string">"/"</span> <span class="string">"&#29;"</span>)
               (<span class="string">"_"</span> <span class="string">"&#31;"</span>)
               (<span class="string">"="</span> <span class="string">"&#22;"</span>))
             (match-string <span class="highlight-numbers-number">2</span>)
             <span class="string">"&#15;"</span>) <span class="warning-1">nil nil)))</span>

(add-hook 'lui-pre-input-hook #'lui-org-to-irc)
<span class="comment-delimiter">;; </span><span class="comment">org-emph-to-irc ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Keybindings][Keybindings:1]]
</span>(<span class="keyword">map!</span> <span class="builtin">:map</span> elfeed-search-mode-map
      <span class="builtin">:after</span> elfeed-search
      [remap kill-this-buffer] <span class="string">"q"</span>
      [remap kill-buffer] <span class="string">"q"</span>
      <span class="builtin">:n</span> doom-leader-key nil
      <span class="builtin">:n</span> <span class="string">"q"</span> #'+rss/quit
      <span class="builtin">:n</span> <span class="string">"e"</span> #'elfeed-update
      <span class="builtin">:n</span> <span class="string">"r"</span> #'elfeed-search-untag-all-unread
      <span class="builtin">:n</span> <span class="string">"u"</span> #'elfeed-search-tag-all-unread
      <span class="builtin">:n</span> <span class="string">"s"</span> #'elfeed-search-live-filter
      <span class="builtin">:n</span> <span class="string">"RET"</span> #'elfeed-search-show-entry
      <span class="builtin">:n</span> <span class="string">"p"</span> #'elfeed-show-pdf
      <span class="builtin">:n</span> <span class="string">"+"</span> #'elfeed-search-tag-all
      <span class="builtin">:n</span> <span class="string">"-"</span> #'elfeed-search-untag-all
      <span class="builtin">:n</span> <span class="string">"S"</span> #'elfeed-search-set-filter
      <span class="builtin">:n</span> <span class="string">"b"</span> #'elfeed-search-browse-url
      <span class="builtin">:n</span> <span class="string">"y"</span> #'elfeed-search-yank)
(<span class="keyword">map!</span> <span class="builtin">:map</span> elfeed-show-mode-map
      <span class="builtin">:after</span> elfeed-show
      [remap kill-this-buffer] <span class="string">"q"</span>
      [remap kill-buffer] <span class="string">"q"</span>
      <span class="builtin">:n</span> doom-leader-key nil
      <span class="builtin">:nm</span> <span class="string">"q"</span> #'+rss/delete-pane
      <span class="builtin">:nm</span> <span class="string">"o"</span> #'ace-link-elfeed
      <span class="builtin">:nm</span> <span class="string">"RET"</span> #'org-ref-elfeed-add
      <span class="builtin">:nm</span> <span class="string">"n"</span> #'elfeed-show-next
      <span class="builtin">:nm</span> <span class="string">"N"</span> #'elfeed-show-prev
      <span class="builtin">:nm</span> <span class="string">"p"</span> #'elfeed-show-pdf
      <span class="builtin">:nm</span> <span class="string">"+"</span> #'elfeed-show-tag
      <span class="builtin">:nm</span> <span class="string">"-"</span> #'elfeed-show-untag
      <span class="builtin">:nm</span> <span class="string">"s"</span> #'elfeed-show-new-live-search
      <span class="builtin">:nm</span> <span class="string">"y"</span> #'elfeed-show-yank)
<span class="comment-delimiter">;; </span><span class="comment">Keybindings:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Usability enhancements][Usability enhancements:1]]
</span>(<span class="keyword">after!</span> elfeed-search
  (set-evil-initial-state! 'elfeed-search-mode 'normal))
(<span class="keyword">after!</span> elfeed-show-mode
  (set-evil-initial-state! 'elfeed-show-mode   'normal))

(<span class="keyword">after!</span> evil-snipe
  (<span class="keyword">push</span> 'elfeed-show-mode   evil-snipe-disabled-modes)
  (<span class="keyword">push</span> 'elfeed-search-mode evil-snipe-disabled-modes))
<span class="comment-delimiter">;; </span><span class="comment">Usability enhancements:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Visual enhancements][Visual enhancements:1]]
</span>(<span class="keyword">after!</span> elfeed

  (elfeed-org)
  (<span class="keyword">use-package!</span> elfeed-link)

  (<span class="keyword">setq</span> elfeed-search-filter <span class="string">"@1-week-ago +unread"</span>
        elfeed-search-print-entry-function '+rss/elfeed-search-print-entry
        elfeed-search-title-min-width <span class="highlight-numbers-number">80</span>
        elfeed-show-entry-switch #'pop-to-buffer
        elfeed-show-entry-delete #'+rss/delete-pane
        elfeed-show-refresh-function #'+rss/elfeed-show-refresh--better-style
        shr-max-image-proportion <span class="highlight-numbers-number">0.6</span>)

  (<span class="keyword">add-hook!</span> 'elfeed-show-mode-hook (hide-mode-line-mode <span class="highlight-numbers-number">1</span>))
  (<span class="keyword">add-hook!</span> 'elfeed-search-update-hook #'hide-mode-line-mode)

  (<span class="keyword">defface</span> <span class="variable-name">elfeed-show-title-face</span> '((t (<span class="builtin">:weight</span> ultrabold <span class="builtin">:slant</span> italic <span class="builtin">:height</span> <span class="highlight-numbers-number">1.5</span>)))
    <span class="doc">"title face in elfeed show buffer"</span>
    <span class="builtin">:group</span> 'elfeed)
  (<span class="keyword">defface</span> <span class="variable-name">elfeed-show-author-face</span> `((t (<span class="builtin">:weight</span> light)))
    <span class="doc">"title face in elfeed show buffer"</span>
    <span class="builtin">:group</span> 'elfeed)
  (set-face-attribute 'elfeed-search-title-face nil
                      <span class="builtin">:foreground</span> 'nil
                      <span class="builtin">:weight</span> 'light)

  (<span class="keyword">defadvice!</span> +rss-elfeed-wrap-h-nicer ()
    <span class="doc">"Enhances an elfeed entry's readability by wrapping it to a width of
`</span><span class="doc"><span class="constant">fill-column</span></span><span class="doc">' and centering it with `</span><span class="doc"><span class="constant">visual-fill-column-mode</span></span><span class="doc">'."</span>
    <span class="builtin">:override</span> #'+rss-elfeed-wrap-h
    (<span class="keyword">let</span> ((inhibit-read-only t)
          (inhibit-modification-hooks t))
      (<span class="keyword">setq-local</span> truncate-lines nil)
      (<span class="keyword">setq-local</span> shr-width <span class="highlight-numbers-number">120</span>)
      (<span class="keyword">setq-local</span> line-spacing <span class="highlight-numbers-number">0.2</span>)
      (<span class="keyword">setq-local</span> visual-fill-column-center-text t)
      (visual-fill-column-mode)
      <span class="comment-delimiter">;; </span><span class="comment">(setq-local shr-current-font '(:family "Merriweather" :height 1.2))
</span>      (set-buffer-modified-p nil)))

  (<span class="keyword">defun</span> <span class="function-name">+rss/elfeed-search-print-entry</span> (entry)
    <span class="doc">"Print ENTRY to the buffer."</span>
    (<span class="keyword">let*</span> ((elfeed-goodies/tag-column-width <span class="highlight-numbers-number">40</span>)
           (elfeed-goodies/feed-source-column-width <span class="highlight-numbers-number">30</span>)
           (title (<span class="keyword">or</span> (elfeed-meta entry <span class="builtin">:title</span>) (elfeed-entry-title entry) <span class="string">""</span>))
           (title-faces (elfeed-search--faces (elfeed-entry-tags entry)))
           (feed (elfeed-entry-feed entry))
           (feed-title
            (<span class="keyword">when</span> feed
              (<span class="keyword">or</span> (elfeed-meta feed <span class="builtin">:title</span>) (elfeed-feed-title feed))))
           (tags (mapcar #'symbol-name (elfeed-entry-tags entry)))
           (tags-str (concat (mapconcat 'identity tags <span class="string">","</span>)))
           (title-width (- (window-width) elfeed-goodies/feed-source-column-width
                           elfeed-goodies/tag-column-width <span class="highlight-numbers-number">4</span>))

           (tag-column (elfeed-format-column
                        tags-str (elfeed-clamp (length tags-str)
                                               elfeed-goodies/tag-column-width
                                               elfeed-goodies/tag-column-width)
                        <span class="builtin">:left</span>))
           (feed-column (elfeed-format-column
                         feed-title (elfeed-clamp elfeed-goodies/feed-source-column-width
                                                  elfeed-goodies/feed-source-column-width
                                                  elfeed-goodies/feed-source-column-width)
                         <span class="builtin">:left</span>)))

      (insert (propertize feed-column 'face 'elfeed-search-feed-face) <span class="string">" "</span>)
      (insert (propertize tag-column 'face 'elfeed-search-tag-face) <span class="string">" "</span>)
      (insert (propertize title 'face title-faces 'kbd-help title))
      (<span class="keyword">setq-local</span> line-spacing <span class="highlight-numbers-number">0.2</span>)))

  (<span class="keyword">defun</span> <span class="function-name">+rss/elfeed-show-refresh--better-style</span> ()
    <span class="doc">"Update the buffer to match the selected entry, using a mail-style."</span>
    (<span class="keyword">interactive</span>)
    (<span class="keyword">let*</span> ((inhibit-read-only t)
           (title (elfeed-entry-title elfeed-show-entry))
           (date (seconds-to-time (elfeed-entry-date elfeed-show-entry)))
           (author (elfeed-meta elfeed-show-entry <span class="builtin">:author</span>))
           (link (elfeed-entry-link elfeed-show-entry))
           (tags (elfeed-entry-tags elfeed-show-entry))
           (tagsstr (mapconcat #'symbol-name tags <span class="string">", "</span>))
           (nicedate (format-time-string <span class="string">"%a, %e %b %Y %T %Z"</span> date))
           (content (elfeed-deref (elfeed-entry-content elfeed-show-entry)))
           (type (elfeed-entry-content-type elfeed-show-entry))
           (feed (elfeed-entry-feed elfeed-show-entry))
           (feed-title (elfeed-feed-title feed))
           (base (<span class="keyword">and</span> feed (elfeed-compute-base (elfeed-feed-url feed)))))
      (erase-buffer)
      (insert <span class="string">"\n"</span>)
      (insert (format <span class="string">"%s\n\n"</span> (propertize title 'face 'elfeed-show-title-face)))
      (insert (format <span class="string">"%s\t"</span> (propertize feed-title 'face 'elfeed-search-feed-face)))
      (<span class="keyword">when</span> (<span class="keyword">and</span> author elfeed-show-entry-author)
        (insert (format <span class="string">"%s\n"</span> (propertize author 'face 'elfeed-show-author-face))))
      (insert (format <span class="string">"%s\n\n"</span> (propertize nicedate 'face 'elfeed-log-date-face)))
      (<span class="keyword">when</span> tags
        (insert (format <span class="string">"%s\n"</span>
                        (propertize tagsstr 'face 'elfeed-search-tag-face))))
      <span class="comment-delimiter">;; </span><span class="comment">(insert (propertize "Link: " 'face 'message-header-name))
</span>      <span class="comment-delimiter">;; </span><span class="comment">(elfeed-insert-link link link)
</span>      <span class="comment-delimiter">;; </span><span class="comment">(insert "\n")
</span>      (<span class="keyword">cl-loop</span> for enclosure in (elfeed-entry-enclosures elfeed-show-entry)
               do (insert (propertize <span class="string">"Enclosure: "</span> 'face 'message-header-name))
               do (elfeed-insert-link (car enclosure))
               do (insert <span class="string">"\n"</span>))
      (insert <span class="string">"\n"</span>)
      (<span class="keyword">if</span> content
          (<span class="keyword">if</span> (eq type 'html)
              (elfeed-insert-html content base)
            (insert content))
        (insert (propertize <span class="string">"(empty)\n"</span> 'face 'italic)))
      (goto-char (point-min))))

  )
<span class="comment-delimiter">;; </span><span class="comment">Visual enhancements:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Functionality enhancements][Functionality enhancements:1]]
</span>(<span class="keyword">after!</span> elfeed-show
  (<span class="keyword">require</span> '<span class="constant">url</span>)

  (<span class="keyword">defvar</span> <span class="variable-name">elfeed-pdf-dir</span>
    (expand-file-name <span class="string">"pdfs/"</span>
                      (file-name-directory (directory-file-name elfeed-enclosure-default-dir))))

  (<span class="keyword">defvar</span> <span class="variable-name">elfeed-link-pdfs</span>
    '((<span class="string">"https://www.jstatsoft.org/index.php/jss/article/view/v0</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[</span><span class="string"><span class="negation-char">^</span></span><span class="string">/]+</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">"</span> . <span class="string">"https://www.jstatsoft.org/index.php/jss/article/view/v0\\1/v\\1.pdf"</span>)
      (<span class="string">"http://arxiv.org/abs/</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[</span><span class="string"><span class="negation-char">^</span></span><span class="string">/]+</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">"</span> . <span class="string">"https://arxiv.org/pdf/\\1.pdf"</span>))
    <span class="doc">"List of alists of the form (REGEX-FOR-LINK . FORM-FOR-PDF)"</span>)

  (<span class="keyword">defun</span> <span class="function-name">elfeed-show-pdf</span> (entry)
    (<span class="keyword">interactive</span>
     (list (<span class="keyword">or</span> elfeed-show-entry (elfeed-search-selected <span class="builtin">:ignore-region</span>))))
    (<span class="keyword">let</span> ((link (elfeed-entry-link entry))
          (feed-name (plist-get (elfeed-feed-meta (elfeed-entry-feed entry)) <span class="builtin">:title</span>))
          (title (elfeed-entry-title entry))
          (file-view-function
           (<span class="keyword">lambda</span> (f)
             (<span class="keyword">when</span> elfeed-show-entry
               (elfeed-kill-buffer))
             (pop-to-buffer (find-file-noselect f))))
          pdf)

      (<span class="keyword">let</span> ((file (expand-file-name
                   (concat (subst-char-in-string ?/ ?, title) <span class="string">".pdf"</span>)
                   (expand-file-name (subst-char-in-string ?/ ?, feed-name)
                                     elfeed-pdf-dir))))
        (<span class="keyword">if</span> (file-exists-p file)
            (funcall file-view-function file)
          (<span class="keyword">dolist</span> (link-pdf elfeed-link-pdfs)
            (<span class="keyword">when</span> (<span class="keyword">and</span> (string-match-p (car link-pdf) link)
                       (not pdf))
              (<span class="keyword">setq</span> pdf (replace-regexp-in-string (car link-pdf) (cdr link-pdf) link))))
          (<span class="keyword">if</span> (not pdf)
              (message <span class="string">"No associated PDF for entry"</span>)
            (message <span class="string">"Fetching %s"</span> pdf)
            (<span class="keyword">unless</span> (file-exists-p (file-name-directory file))
              (make-directory (file-name-directory file) t))
            (url-copy-file pdf file)
            (funcall file-view-function file))))))

  )
<span class="comment-delimiter">;; </span><span class="comment">Functionality enhancements:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Dictionary][Dictionary:1]]
</span>(<span class="keyword">use-package!</span> lexic
  <span class="builtin">:commands</span> lexic-search lexic-list-dictionary
  <span class="builtin">:config</span>
  (<span class="keyword">map!</span> <span class="builtin">:map</span> lexic-mode-map
        <span class="builtin">:n</span> <span class="string">"q"</span> #'lexic-return-from-lexic
        <span class="builtin">:nv</span> <span class="string">"RET"</span> #'lexic-search-word-at-point
        <span class="builtin">:n</span> <span class="string">"a"</span> #'outline-show-all
        <span class="builtin">:n</span> <span class="string">"h"</span> (<span class="keyword">cmd!</span> (outline-hide-sublevels <span class="highlight-numbers-number">3</span>))
        <span class="builtin">:n</span> <span class="string">"o"</span> #'lexic-toggle-entry
        <span class="builtin">:n</span> <span class="string">"n"</span> #'lexic-next-entry
        <span class="builtin">:n</span> <span class="string">"N"</span> (<span class="keyword">cmd!</span> (lexic-next-entry t))
        <span class="builtin">:n</span> <span class="string">"p"</span> #'lexic-previous-entry
        <span class="builtin">:n</span> <span class="string">"P"</span> (<span class="keyword">cmd!</span> (lexic-previous-entry t))
        <span class="builtin">:n</span> <span class="string">"E"</span> (<span class="keyword">cmd!</span> (lexic-return-from-lexic) <span class="comment-delimiter">; </span><span class="comment">expand
</span>                     (switch-to-buffer (lexic-get-buffer)))
        <span class="builtin">:n</span> <span class="string">"M"</span> (<span class="keyword">cmd!</span> (lexic-return-from-lexic) <span class="comment-delimiter">; </span><span class="comment">minimise
</span>                     (lexic-goto-lexic))
        <span class="builtin">:n</span> <span class="string">"C-p"</span> #'lexic-search-history-backwards
        <span class="builtin">:n</span> <span class="string">"C-n"</span> #'lexic-search-history-forwards
        <span class="builtin">:n</span> <span class="string">"/"</span> (<span class="keyword">cmd!</span> (call-interactively #'lexic-search))))
<span class="comment-delimiter">;; </span><span class="comment">Dictionary:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Dictionary][Dictionary:2]]
</span>(<span class="keyword">defadvice!</span> +lookup/dictionary-definition-lexic (identifier <span class="type">&amp;optional</span> arg)
  <span class="doc">"Look up the definition of the word at point (or selection) using `</span><span class="doc"><span class="constant">lexic-search</span></span><span class="doc">'."</span>
  <span class="builtin">:override</span> #'+lookup/dictionary-definition
  (<span class="keyword">interactive</span>
   (list (<span class="keyword">or</span> (doom-thing-at-point-or-region 'word)
             (read-string <span class="string">"Look up in dictionary: "</span>))
         current-prefix-arg))
  (lexic-search identifier nil nil t))
<span class="comment-delimiter">;; </span><span class="comment">Dictionary:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Rebuild mail index while using mu4e][Rebuild mail index while using mu4e:1]]
</span>(<span class="keyword">after!</span> mu4e
  (<span class="keyword">defvar</span> <span class="variable-name">mu4e-reindex-request-file</span> <span class="string">"/tmp/mu_reindex_now"</span>
    <span class="doc">"Location of the reindex request, signaled by existance"</span>)
  (<span class="keyword">defvar</span> <span class="variable-name">mu4e-reindex-request-min-seperation</span> <span class="highlight-numbers-number">5.0</span>
    <span class="doc">"Don't refresh again until this many second have elapsed.
Prevents a series of redisplays from being called (when set to an appropriate value)"</span>)

  (<span class="keyword">defvar</span> <span class="variable-name">mu4e-reindex-request--file-watcher</span> nil)
  (<span class="keyword">defvar</span> <span class="variable-name">mu4e-reindex-request--file-just-deleted</span> nil)
  (<span class="keyword">defvar</span> <span class="variable-name">mu4e-reindex-request--last-time</span> <span class="highlight-numbers-number">0</span>)

  (<span class="keyword">defun</span> <span class="function-name">mu4e-reindex-request--add-watcher</span> ()
    (<span class="keyword">setq</span> mu4e-reindex-request--file-just-deleted nil)
    (<span class="keyword">setq</span> mu4e-reindex-request--file-watcher
          (file-notify-add-watch mu4e-reindex-request-file
                                 '(change)
                                 #'mu4e-file-reindex-request)))

  (<span class="keyword">defadvice!</span> mu4e-stop-watching-for-reindex-request ()
    <span class="builtin">:after</span> #'mu4e~proc-kill
    (<span class="keyword">if</span> mu4e-reindex-request--file-watcher
        (file-notify-rm-watch mu4e-reindex-request--file-watcher)))

  (<span class="keyword">defadvice!</span> mu4e-watch-for-reindex-request ()
    <span class="builtin">:after</span> #'mu4e~proc-start
    (mu4e-stop-watching-for-reindex-request)
    (<span class="keyword">when</span> (file-exists-p mu4e-reindex-request-file)
      (delete-file mu4e-reindex-request-file))
    (mu4e-reindex-request--add-watcher))

  (<span class="keyword">defun</span> <span class="function-name">mu4e-file-reindex-request</span> (event)
    <span class="doc">"Act based on the existance of `</span><span class="doc"><span class="constant">mu4e-reindex-request-file</span></span><span class="doc">'"</span>
    (<span class="keyword">if</span> mu4e-reindex-request--file-just-deleted
        (mu4e-reindex-request--add-watcher)
      (<span class="keyword">when</span> (equal (nth <span class="highlight-numbers-number">1</span> event) 'created)
        (delete-file mu4e-reindex-request-file)
        (<span class="keyword">setq</span> mu4e-reindex-request--file-just-deleted t)
        (mu4e-reindex-maybe t))))

  (<span class="keyword">defun</span> <span class="function-name">mu4e-reindex-maybe</span> (<span class="type">&amp;optional</span> new-request)
    <span class="doc">"Run `</span><span class="doc"><span class="constant">mu4e~proc-index</span></span><span class="doc">' if it's been more than
`</span><span class="doc"><span class="constant">mu4e-reindex-request-min-seperation</span></span><span class="doc">'seconds since the last request,"</span>
    (<span class="keyword">let</span> ((time-since-last-request (- (float-time)
                                      mu4e-reindex-request--last-time)))
      (<span class="keyword">when</span> new-request
        (<span class="keyword">setq</span> mu4e-reindex-request--last-time (float-time)))
      (<span class="keyword">if</span> (&gt; time-since-last-request mu4e-reindex-request-min-seperation)
          (mu4e~proc-index nil t)
        (<span class="keyword">when</span> new-request
          (run-at-time (* <span class="highlight-numbers-number">1.1</span> mu4e-reindex-request-min-seperation) nil
                       #'mu4e-reindex-maybe))))))
<span class="comment-delimiter">;; </span><span class="comment">Rebuild mail index while using mu4e:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Viewing Mail][Viewing Mail:1]]
</span>(<span class="keyword">after!</span> mu4e
  (<span class="keyword">setq</span> mu4e-headers-fields
        '((<span class="builtin">:flags</span> . <span class="highlight-numbers-number">6</span>)
          (<span class="builtin">:account-stripe</span> . <span class="highlight-numbers-number">2</span>)
          (<span class="builtin">:from-or-to</span> . <span class="highlight-numbers-number">25</span>)
          (<span class="builtin">:folder</span> . <span class="highlight-numbers-number">10</span>)
          (<span class="builtin">:recipnum</span> . <span class="highlight-numbers-number">2</span>)
          (<span class="builtin">:subject</span> . <span class="highlight-numbers-number">80</span>)
          (<span class="builtin">:human-date</span> . <span class="highlight-numbers-number">8</span>))
        +mu4e-min-header-frame-width <span class="highlight-numbers-number">142</span>
        mu4e-headers-date-format <span class="string">"%d/%m/%y"</span>
        mu4e-headers-time-format <span class="string">"&#226;&#167;&#150; %H:%M"</span>
        mu4e-headers-results-limit <span class="highlight-numbers-number">1000</span>
        mu4e-index-cleanup t)

  (add-to-list 'mu4e-bookmarks
               '(<span class="builtin">:name</span> <span class="string">"Yesterday's messages"</span> <span class="builtin">:query</span> <span class="string">"date:2d..1d"</span> <span class="builtin">:key</span> ?y) t)

  (<span class="keyword">defvar</span> <span class="variable-name">+mu4e-header--folder-colors</span> nil)
  (<span class="keyword">appendq!</span> mu4e-header-info-custom
            '((<span class="builtin">:folder</span> .
               (<span class="builtin">:name</span> <span class="string">"Folder"</span> <span class="builtin">:shortname</span> <span class="string">"Folder"</span> <span class="builtin">:help</span> <span class="string">"Lowest level folder"</span> <span class="builtin">:function</span>
                (<span class="keyword">lambda</span> (msg)
                  (+mu4e-colorize-str
                   (replace-regexp-in-string <span class="string">"\\`.*/"</span> <span class="string">""</span> (mu4e-message-field msg <span class="builtin">:maildir</span>))
                   '+mu4e-header--folder-colors)))))))
<span class="comment-delimiter">;; </span><span class="comment">Viewing Mail:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Viewing Mail][Viewing Mail:2]]
</span>(<span class="keyword">setq</span> mu4e-alert-icon <span class="string">"/usr/share/icons/Papirus/64x64/apps/evolution.svg"</span>)
<span class="comment-delimiter">;; </span><span class="comment">Viewing Mail:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Sending Mail][Sending Mail:1]]
</span>(<span class="keyword">after!</span> mu4e
  (<span class="keyword">setq</span> sendmail-program <span class="string">"/usr/bin/msmtp"</span>
        send-mail-function #'smtpmail-send-it
        message-sendmail-f-is-evil t
        message-sendmail-extra-arguments '(<span class="string">"--read-envelope-from"</span>)<span class="comment-delimiter">; </span><span class="comment">, "--read-recipients")
</span>        message-send-mail-function #'message-send-mail-with-sendmail))
<span class="comment-delimiter">;; </span><span class="comment">Sending Mail:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Sending Mail][Sending Mail:4]]
</span>(<span class="keyword">defun</span> <span class="function-name">mu4e-compose-from-mailto</span> (mailto-string)
  (<span class="keyword">require</span> '<span class="constant">mu4e</span>)
  (<span class="keyword">unless</span> mu4e~server-props (mu4e t) (sleep-for <span class="highlight-numbers-number">0.1</span>))
  (<span class="keyword">let*</span> ((mailto (rfc2368-parse-mailto-url mailto-string))
         (to (cdr (assoc <span class="string">"To"</span> mailto)))
         (subject (<span class="keyword">or</span> (cdr (assoc <span class="string">"Subject"</span> mailto)) <span class="string">""</span>))
         (body (cdr (assoc <span class="string">"Body"</span> mailto)))
         (org-msg-greeting-fmt (<span class="keyword">if</span> (assoc <span class="string">"Body"</span> mailto)
                                   (replace-regexp-in-string <span class="string">"%"</span> <span class="string">"%%"</span>
                                                             (cdr (assoc <span class="string">"Body"</span> mailto)))
                                 org-msg-greeting-fmt))
         (headers (-filter (<span class="keyword">lambda</span> (spec) (not (-contains-p '(<span class="string">"To"</span> <span class="string">"Subject"</span> <span class="string">"Body"</span>) (car spec)))) mailto)))
    (mu4e~compose-mail to subject headers)))
<span class="comment-delimiter">;; </span><span class="comment">Sending Mail:4 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Sending Mail][Sending Mail:5]]
</span>(<span class="keyword">defvar</span> <span class="variable-name">mu4e-from-name</span> <span class="string">"Timothy"</span>
  <span class="doc">"Name used in \"From:\" template."</span>)
(<span class="keyword">defadvice!</span> mu4e~draft-from-construct-renamed (orig-fn)
  <span class="doc">"Wrap `</span><span class="doc"><span class="constant">mu4e~draft-from-construct-renamed</span></span><span class="doc">' to change the name."</span>
  <span class="builtin">:around</span> #'mu4e~draft-from-construct
  (<span class="keyword">let</span> ((user-full-name mu4e-from-name))
    (funcall orig-fn)))
<span class="comment-delimiter">;; </span><span class="comment">Sending Mail:5 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Org Msg][Org Msg:1]]
</span>(<span class="keyword">setq</span> +org-msg-accent-color <span class="string">"#1a5fb4"</span>
      org-msg-greeting-fmt <span class="string">"\nHi %s,\n\n"</span>
      org-msg-signature <span class="string">"\n\n#+begin_signature\nAll the best,\\\\\n*Timothy*\n#+end_signature"</span>)
(<span class="keyword">map!</span> <span class="builtin">:map</span> org-msg-edit-mode-map
      <span class="builtin">:after</span> org-msg
      <span class="builtin">:n</span> <span class="string">"G"</span> #'org-msg-goto-body)
<span class="comment-delimiter">;; </span><span class="comment">Org Msg:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*File Templates][File Templates:1]]
</span>(set-file-template! <span class="string">"\\.tex$"</span> <span class="builtin">:trigger</span> <span class="string">"__"</span> <span class="builtin">:mode</span> 'latex-mode)
(set-file-template! <span class="string">"\\.org$"</span> <span class="builtin">:trigger</span> <span class="string">"__"</span> <span class="builtin">:mode</span> 'org-mode)
(set-file-template! <span class="string">"/LICEN[CS]E$"</span> <span class="builtin">:trigger</span> '+file-templates/insert-license)
<span class="comment-delimiter">;; </span><span class="comment">File Templates:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Plaintext][Plaintext:1]]
</span>(<span class="keyword">after!</span> text-mode
  (<span class="keyword">add-hook!</span> 'text-mode-hook
             <span class="comment-delimiter">;; </span><span class="comment">Apply ANSI color codes
</span>             (<span class="keyword">with-silent-modifications</span>
               (ansi-color-apply-on-region (point-min) (point-max)))))
<span class="comment-delimiter">;; </span><span class="comment">Plaintext:1 ends here
</span>
(<span class="keyword">after!</span> org
  (<span class="keyword">defvar</span> <span class="variable-name">org-ml-target-dir</span> <span class="string">"~/.emacs.d/.local/straight/repos/org-mode/"</span>)
  (<span class="keyword">defvar</span> <span class="variable-name">org-ml-max-age</span> <span class="highlight-numbers-number">600</span>
    <span class="doc">"Maximum permissible age in seconds."</span>)
  (<span class="keyword">defvar</span> <span class="variable-name">org-ml--cache-timestamp</span> <span class="highlight-numbers-number">0</span>)
  (<span class="keyword">defvar</span> <span class="variable-name">org-ml--cache</span> nil)
  
  (<span class="keyword">defun</span> <span class="function-name">org-ml-current-patches</span> ()
    <span class="doc">"Get the currently open patches, as a list of alists.
  Entries of the form (subject . id)."</span>
    (delq nil
          (mapcar
           (<span class="keyword">lambda</span> (entry)
             (<span class="keyword">unless</span> (plist-get entry <span class="builtin">:fixed</span>)
               (cons
                (format <span class="string">"%-8s  %s"</span>
                        (propertize
                         (replace-regexp-in-string <span class="string">"T.*"</span> <span class="string">""</span>
                                                   (plist-get entry <span class="builtin">:date</span>))
                         'face 'font-lock-doc-face)
                        (propertize
                         (replace-regexp-in-string <span class="string">"\\[</span><span class="string"><span class="constant">PATCH\\</span></span><span class="string">] ?"</span> <span class="string">""</span>
                                                   (plist-get entry <span class="builtin">:summary</span>))
                         'face 'font-lock-keyword-face))
                (plist-get entry <span class="builtin">:id</span>))))
           (<span class="keyword">with-current-buffer</span> (url-retrieve-synchronously <span class="string">"https://updates.orgmode.org/data/patches"</span>)
             (json-parse-buffer <span class="builtin">:object-type</span> 'plist)))))
  
  (<span class="keyword">defun</span> <span class="function-name">org-ml-select-patch-thread</span> ()
    <span class="doc">"Find and apply a proposed Org patch."</span>
    (<span class="keyword">interactive</span>)
    (<span class="keyword">let</span> ((current-workspace (+workspace-current))
          (patches (<span class="keyword">progn</span>
                     (<span class="keyword">when</span> (<span class="keyword">or</span> (not org-ml--cache)
                               (&gt; (- (float-time) org-ml--cache-timestamp)
                                  org-ml-max-age))
                       (<span class="keyword">setq</span> org-ml--cache (org-ml-current-patches)
                             org-ml--cache-timestamp (float-time)))
                     org-ml--cache))
          msg-id)
      (ivy-read <span class="string">"Thread: "</span>
                patches
                <span class="builtin">:action</span> (<span class="keyword">lambda</span> (m) (<span class="keyword">setq</span> msg-id (cdr m))))
      (+workspace-switch +mu4e-workspace-name)
      (mu4e-view-message-with-message-id msg-id)
      (add-to-list 'mu4e-view-actions
                   (cons <span class="string">"apply patch to org"</span> #'org-ml-transient-mu4e-action))))
  
  (<span class="keyword">defun</span> <span class="function-name">org-ml-transient-mu4e-action</span> (msg)
    (<span class="keyword">setq</span> mu4e-view-actions
          (delete (cons <span class="string">"apply patch to org"</span> #'org-ml-transient-mu4e-action)
                  mu4e-view-actions))
    (+workspace/other)
    (magit-status org-ml-target-dir)
    (<span class="keyword">with-current-buffer</span> (get-buffer-create <span class="string">"*Shell: Org apply patches*"</span>)
      (erase-buffer)
      (<span class="keyword">let</span> ((default-directory org-ml-target-dir))
        (shell-command
         (format <span class="string">"git am %s"</span>
                 (shell-quote-argument (mu4e-message-field msg <span class="builtin">:path</span>)))
         (current-buffer))
        (magit-refresh))
      (<span class="keyword">when</span> (string-match-p <span class="string">"Error</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">|</span></span><span class="string">failed"</span> (buffer-string))
        (+popup/buffer))))
  (<span class="keyword">setq</span> org-directory <span class="string">"~/.org"</span>                      <span class="comment-delimiter">; </span><span class="comment">let's put files here
</span>        org-use-property-inheritance t              <span class="comment-delimiter">; </span><span class="comment">it's convenient to have properties inherited
</span>        org-log-done 'time                          <span class="comment-delimiter">; </span><span class="comment">having the time a item is done sounds convininet
</span>        org-list-allow-alphabetical t               <span class="comment-delimiter">; </span><span class="comment">have a. A. a) A) list bullets
</span>        org-export-in-background t                  <span class="comment-delimiter">; </span><span class="comment">run export processes in external emacs process
</span>        org-catch-invisible-edits 'smart            <span class="comment-delimiter">; </span><span class="comment">try not to accidently do weird stuff in invisible regions
</span>        org-export-with-sub-superscripts '{}        <span class="comment-delimiter">; </span><span class="comment">don't treat lone _ / ^ as sub/superscripts, require _{} / ^{}
</span>        org-re-reveal-root <span class="string">"https://cdn.jsdelivr.net/npm/reveal.js"</span>)
  (<span class="keyword">setq</span> org-babel-default-header-args
        '((<span class="builtin">:session</span> . <span class="string">"none"</span>)
          (<span class="builtin">:results</span> . <span class="string">"replace"</span>)
          (<span class="builtin">:exports</span> . <span class="string">"code"</span>)
          (<span class="builtin">:cache</span> . <span class="string">"no"</span>)
          (<span class="builtin">:noweb</span> . <span class="string">"no"</span>)
          (<span class="builtin">:hlines</span> . <span class="string">"no"</span>)
          (<span class="builtin">:tangle</span> . <span class="string">"no"</span>)
          (<span class="builtin">:comments</span> . <span class="string">"link"</span>)))
  (remove-hook 'text-mode-hook #'visual-line-mode)
  (add-hook 'text-mode-hook #'auto-fill-mode)
  (<span class="keyword">map!</span> <span class="builtin">:map</span> evil-org-mode-map
        <span class="builtin">:after</span> evil-org
        <span class="builtin">:n</span> <span class="string">"g &lt;up&gt;"</span> #'org-backward-heading-same-level
        <span class="builtin">:n</span> <span class="string">"g &lt;down&gt;"</span> #'org-forward-heading-same-level
        <span class="builtin">:n</span> <span class="string">"g &lt;left&gt;"</span> #'org-up-element
        <span class="builtin">:n</span> <span class="string">"g &lt;right&gt;"</span> #'org-down-element)
  (<span class="keyword">evil-define-command</span> <span class="function-name">evil-buffer-org-new</span> (count file)
    <span class="doc">"Creates a new ORG buffer replacing the current window, optionally
     editing a certain FILE"</span>
    <span class="builtin">:repeat</span> nil
    (<span class="keyword">interactive</span> <span class="string">"P&lt;f&gt;"</span>)
    (<span class="keyword">if</span> file
        (evil-edit file)
      (<span class="keyword">let</span> ((buffer (generate-new-buffer <span class="string">"*new org*"</span>)))
        (set-window-buffer nil buffer)
        (<span class="keyword">with-current-buffer</span> buffer
          (org-mode)))))
  (<span class="keyword">map!</span> <span class="builtin">:leader</span>
        (<span class="builtin">:prefix</span> <span class="string">"b"</span>
         <span class="builtin">:desc</span> <span class="string">"New empty ORG buffer"</span> <span class="string">"o"</span> #'evil-buffer-org-new))
  (<span class="keyword">setq</span> org-list-demote-modify-bullet '((<span class="string">"+"</span> . <span class="string">"-"</span>) (<span class="string">"-"</span> . <span class="string">"+"</span>) (<span class="string">"*"</span> . <span class="string">"+"</span>) (<span class="string">"1."</span> . <span class="string">"a."</span>)))
  (<span class="keyword">use-package!</span> org-ref
    <span class="builtin">:after</span> org
    <span class="builtin">:config</span>
    (<span class="keyword">setq</span> org-ref-completion-library 'org-ref-ivy-cite))
  (add-hook 'org-mode-hook 'turn-on-org-cdlatex)
  (<span class="keyword">defadvice!</span> org-edit-latex-emv-after-insert ()
    <span class="builtin">:after</span> #'org-cdlatex-environment-indent
    (org-edit-latex-environment))
  (add-hook 'org-mode-hook 'turn-on-flyspell)
  (<span class="keyword">cl-defmacro</span> <span class="function-name">lsp-org-babel-enable</span> (lang)
    <span class="doc">"Support LANG in org source code block."</span>
    (<span class="keyword">setq</span> centaur-lsp 'lsp-mode)
    (<span class="warning-1">cl-check-type</span> lang stringp)
    (<span class="keyword">let*</span> ((edit-pre (intern (format <span class="string">"org-babel-edit-prep:%s"</span> lang)))
           (intern-pre (intern (format <span class="string">"lsp--%s"</span> (symbol-name edit-pre)))))
      `(<span class="keyword">progn</span>
         (<span class="keyword">defun</span> ,intern-pre (info)
           (<span class="keyword">let</span> ((file-name (<span class="keyword">-&gt;&gt;</span> info caddr (alist-get <span class="builtin">:file</span>))))
             (<span class="keyword">unless</span> file-name
               (<span class="keyword">setq</span> file-name (make-temp-file <span class="string">"babel-lsp-"</span>)))
             (<span class="keyword">setq</span> buffer-file-name file-name)
             (lsp-deferred)))
         (put ',intern-pre 'function-documentation
              (format <span class="string">"Enable lsp-mode in the buffer of org source block (%s)."</span>
                      (upcase ,lang)))
         (<span class="keyword">if</span> (fboundp ',edit-pre)
             (advice-add ',edit-pre <span class="builtin">:after</span> ',intern-pre)
           (<span class="keyword">progn</span>
             (<span class="keyword">defun</span> ,edit-pre (info)
               (,intern-pre info))
             (put ',edit-pre 'function-documentation
                  (format <span class="string">"Prepare local buffer environment for org source block (%s)."</span>
                          (upcase ,lang))))))))
  (<span class="keyword">defvar</span> <span class="variable-name">org-babel-lang-list</span>
    '(<span class="string">"go"</span> <span class="string">"python"</span> <span class="string">"ipython"</span> <span class="string">"bash"</span> <span class="string">"sh"</span>))
  (<span class="keyword">dolist</span> (lang org-babel-lang-list)
    (eval `(lsp-org-babel-enable ,lang)))
  (<span class="keyword">map!</span> <span class="builtin">:map</span> org-mode-map
        <span class="builtin">:localleader</span>
        <span class="builtin">:desc</span> <span class="string">"View exported file"</span> <span class="string">"v"</span> #'org-view-output-file)
  
  (<span class="keyword">defun</span> <span class="function-name">org-view-output-file</span> (<span class="type">&amp;optional</span> org-file-path)
    <span class="doc">"Visit buffer open on the first output file (if any) found, using `</span><span class="doc"><span class="constant">org-view-output-file-extensions</span></span><span class="doc">'"</span>
    (<span class="keyword">interactive</span>)
    (<span class="keyword">let*</span> ((org-file-path (<span class="keyword">or</span> org-file-path (buffer-file-name) <span class="string">""</span>))
           (dir (file-name-directory org-file-path))
           (basename (file-name-base org-file-path))
           (output-file nil))
      (<span class="keyword">dolist</span> (ext org-view-output-file-extensions)
        (<span class="keyword">unless</span> output-file
          (<span class="keyword">when</span> (file-exists-p
                 (concat dir basename <span class="string">"."</span> ext))
            (<span class="keyword">setq</span> output-file (concat dir basename <span class="string">"."</span> ext)))))
      (<span class="keyword">if</span> output-file
          (<span class="keyword">if</span> (member (file-name-extension output-file) org-view-external-file-extensions)
              (browse-url-xdg-open output-file)
            (pop-to-buffer (<span class="keyword">or</span> (find-buffer-visiting output-file)
                               (find-file-noselect output-file))))
        (message <span class="string">"No exported file found"</span>))))
  
  (<span class="keyword">defvar</span> <span class="variable-name">org-view-output-file-extensions</span> '(<span class="string">"pdf"</span> <span class="string">"md"</span> <span class="string">"rst"</span> <span class="string">"txt"</span> <span class="string">"tex"</span> <span class="string">"html"</span>)
    <span class="doc">"Search for output files with these extensions, in order, viewing the first that matches"</span>)
  (<span class="keyword">defvar</span> <span class="variable-name">org-view-external-file-extensions</span> '(<span class="string">"html"</span>)
    <span class="doc">"File formats that should be opened externally."</span>)
  (<span class="keyword">use-package!</span> org-super-agenda
    <span class="builtin">:commands</span> (org-super-agenda-mode))
  (<span class="keyword">after!</span> org-agenda
    (org-super-agenda-mode))
  
  (<span class="keyword">setq</span> org-agenda-skip-scheduled-if-done t
        org-agenda-skip-deadline-if-done t
        org-agenda-include-deadlines t
        org-agenda-block-separator nil
        org-agenda-tags-column <span class="highlight-numbers-number">100</span> <span class="comment-delimiter">;; </span><span class="comment">from testing this seems to be a good value
</span>        org-agenda-compact-blocks t)
  
  (<span class="keyword">setq</span> org-agenda-custom-commands
        '((<span class="string">"o"</span> <span class="string">"Overview"</span>
           ((agenda <span class="string">""</span> ((org-agenda-span 'day)
                        (org-super-agenda-groups
                         '((<span class="builtin">:name</span> <span class="string">"Today"</span>
                            <span class="builtin">:time-grid</span> t
                            <span class="builtin">:date</span> today
                            <span class="builtin">:todo</span> <span class="string">"TODAY"</span>
                            <span class="builtin">:scheduled</span> today
                            <span class="builtin">:order</span> <span class="highlight-numbers-number">1</span>)))))
            (alltodo <span class="string">""</span> ((org-agenda-overriding-header <span class="string">""</span>)
                         (org-super-agenda-groups
                          '((<span class="builtin">:name</span> <span class="string">"Next to do"</span>
                             <span class="builtin">:todo</span> <span class="string">"NEXT"</span>
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">1</span>)
                            (<span class="builtin">:name</span> <span class="string">"Important"</span>
                             <span class="builtin">:tag</span> <span class="string">"Important"</span>
                             <span class="builtin">:priority</span> <span class="string">"A"</span>
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">6</span>)
                            (<span class="builtin">:name</span> <span class="string">"Due Today"</span>
                             <span class="builtin">:deadline</span> today
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">2</span>)
                            (<span class="builtin">:name</span> <span class="string">"Due Soon"</span>
                             <span class="builtin">:deadline</span> future
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">8</span>)
                            (<span class="builtin">:name</span> <span class="string">"Overdue"</span>
                             <span class="builtin">:deadline</span> past
                             <span class="builtin">:face</span> error
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">7</span>)
                            (<span class="builtin">:name</span> <span class="string">"Assignments"</span>
                             <span class="builtin">:tag</span> <span class="string">"Assignment"</span>
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">10</span>)
                            (<span class="builtin">:name</span> <span class="string">"Issues"</span>
                             <span class="builtin">:tag</span> <span class="string">"Issue"</span>
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">12</span>)
                            (<span class="builtin">:name</span> <span class="string">"Emacs"</span>
                             <span class="builtin">:tag</span> <span class="string">"Emacs"</span>
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">13</span>)
                            (<span class="builtin">:name</span> <span class="string">"Projects"</span>
                             <span class="builtin">:tag</span> <span class="string">"Project"</span>
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">14</span>)
                            (<span class="builtin">:name</span> <span class="string">"Research"</span>
                             <span class="builtin">:tag</span> <span class="string">"Research"</span>
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">15</span>)
                            (<span class="builtin">:name</span> <span class="string">"To read"</span>
                             <span class="builtin">:tag</span> <span class="string">"Read"</span>
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">30</span>)
                            (<span class="builtin">:name</span> <span class="string">"Waiting"</span>
                             <span class="builtin">:todo</span> <span class="string">"WAITING"</span>
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">20</span>)
                            (<span class="builtin">:name</span> <span class="string">"University"</span>
                             <span class="builtin">:tag</span> <span class="string">"uni"</span>
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">32</span>)
                            (<span class="builtin">:name</span> <span class="string">"Trivial"</span>
                             <span class="builtin">:priority&lt;=</span> <span class="string">"E"</span>
                             <span class="builtin">:tag</span> (<span class="string">"Trivial"</span> <span class="string">"Unimportant"</span>)
                             <span class="builtin">:todo</span> (<span class="string">"SOMEDAY"</span> )
                             <span class="builtin">:order</span> <span class="highlight-numbers-number">90</span>)
                            (<span class="builtin">:discard</span> (<span class="builtin">:tag</span> (<span class="string">"Chore"</span> <span class="string">"Routine"</span> <span class="string">"Daily"</span>)))))))))))
  (<span class="keyword">use-package!</span> doct
    <span class="builtin">:commands</span> (doct))
  
  (<span class="keyword">after!</span> org-capture
    (<span class="keyword">defun</span> <span class="function-name">org-capture-select-template-prettier</span> (<span class="type">&amp;optional</span> keys)
      <span class="doc">"Select a capture template, in a prettier way than default
    Lisp programs can force the template by setting KEYS to a string."</span>
      (<span class="keyword">let</span> ((org-capture-templates
             (<span class="keyword">or</span> (org-contextualize-keys
                  (org-capture-upgrade-templates org-capture-templates)
                  org-capture-templates-contexts)
                 '((<span class="string">"t"</span> <span class="string">"Task"</span> entry (file+headline <span class="string">""</span> <span class="string">"Tasks"</span>)
                    <span class="string">"* </span><span class="bold"><span class="warning">TODO</span></span><span class="string"> %?\n  %u\n  %a"</span>)))))
        (<span class="keyword">if</span> keys
            (<span class="keyword">or</span> (assoc keys org-capture-templates)
                (<span class="warning-1">error</span> <span class="string">"No capture template referred to by \"%s\" keys"</span> keys))
          (org-mks org-capture-templates
                   <span class="string">"Select a capture template\n&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;"</span>
                   <span class="string">"Template key: "</span>
                   `((<span class="string">"q"</span> ,(concat (all-the-icons-octicon <span class="string">"stop"</span> <span class="builtin">:face</span> 'all-the-icons-red <span class="builtin">:v-adjust</span> <span class="highlight-numbers-number">0.01</span>) <span class="string">"\tAbort"</span>)))))))
    (advice-add 'org-capture-select-template <span class="builtin">:override</span> #'org-capture-select-template-prettier)
    
    (<span class="keyword">defun</span> <span class="function-name">org-mks-pretty</span> (table title <span class="type">&amp;optional</span> prompt specials)
      <span class="doc">"Select a member of an alist with multiple keys. Prettified.
    
    TABLE is the alist which should contain entries where the car is a string.
    There should be two types of entries.
    
    1. prefix descriptions like (\"a\" \"Description\")
       This indicates that `a' is a prefix key for multi-letter selection, and
       that there are entries following with keys like \"ab\", \"ax\"&#226;&#128;&#166;
    
    2. Select-able members must have more than two elements, with the first
       being the string of keys that lead to selecting it, and the second a
       short description string of the item.
    
    The command will then make a temporary buffer listing all entries
    that can be selected with a single key, and all the single key
    prefixes.  When you press the key for a single-letter entry, it is selected.
    When you press a prefix key, the commands (and maybe further prefixes)
    under this key will be shown and offered for selection.
    
    TITLE will be placed over the selection in the temporary buffer,
    PROMPT will be used when prompting for a key.  SPECIALS is an
    alist with (\"key\" \"description\") entries.  When one of these
    is selected, only the bare key is returned."</span>
      (<span class="keyword">save-window-excursion</span>
        (<span class="keyword">let</span> ((inhibit-quit t)
              (buffer (org-switch-to-buffer-other-window <span class="string">"*Org Select*"</span>))
              (prompt (<span class="keyword">or</span> prompt <span class="string">"Select: "</span>))
              case-fold-search
              current)
          (<span class="keyword">unwind-protect</span>
              (<span class="keyword">catch</span> '<span class="constant">exit</span>
                (<span class="keyword">while</span> t
                  (<span class="keyword">setq-local</span> evil-normal-state-cursor (list nil))
                  (erase-buffer)
                  (insert title <span class="string">"\n\n"</span>)
                  (<span class="keyword">let</span> ((des-keys nil)
                        (allowed-keys '(<span class="string">"\C-g"</span>))
                        (tab-alternatives '(<span class="string">"\s"</span> <span class="string">"\t"</span> <span class="string">"\r"</span>))
                        (cursor-type nil))
                    <span class="comment-delimiter">;; </span><span class="comment">Populate allowed keys and descriptions keys
</span>                    <span class="comment-delimiter">;; </span><span class="comment">available with CURRENT selector.
</span>                    (<span class="keyword">let</span> ((re (format <span class="string">"\\`%s</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">.</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">\\'"</span>
                                      (<span class="keyword">if</span> current (regexp-quote current) <span class="string">""</span>)))
                          (prefix (<span class="keyword">if</span> current (concat current <span class="string">" "</span>) <span class="string">""</span>)))
                      (<span class="keyword">dolist</span> (entry table)
                        (<span class="keyword">pcase</span> entry
                          <span class="comment-delimiter">;; </span><span class="comment">Description.
</span>                          (`(,(<span class="keyword">and</span> key (pred (string-match re))) ,desc)
                           (<span class="keyword">let</span> ((k (match-string <span class="highlight-numbers-number">1</span> key)))
                             (<span class="keyword">push</span> k des-keys)
                             <span class="comment-delimiter">;; </span><span class="comment">Keys ending in tab, space or RET are equivalent.
</span>                             (<span class="keyword">if</span> (member k tab-alternatives)
                                 (<span class="keyword">push</span> <span class="string">"\t"</span> allowed-keys)
                               (<span class="keyword">push</span> k allowed-keys))
                             (insert (propertize prefix 'face 'font-lock-comment-face) (propertize k 'face 'bold) (propertize <span class="string">"&#226;&#128;&#186;"</span> 'face 'font-lock-comment-face) <span class="string">"  "</span> desc <span class="string">"&#226;&#128;&#166;"</span> <span class="string">"\n"</span>)))
                          <span class="comment-delimiter">;; </span><span class="comment">Usable entry.
</span>                          (`(,(<span class="keyword">and</span> key (pred (string-match re))) ,desc . ,_)
                           (<span class="keyword">let</span> ((k (match-string <span class="highlight-numbers-number">1</span> key)))
                             (insert (propertize prefix 'face 'font-lock-comment-face) (propertize k 'face 'bold) <span class="string">"   "</span> desc <span class="string">"\n"</span>)
                             (<span class="keyword">push</span> k allowed-keys)))
                          (_ nil))))
                    <span class="comment-delimiter">;; </span><span class="comment">Insert special entries, if any.
</span>                    (<span class="keyword">when</span> specials
                      (insert <span class="string">"&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;\n"</span>)
                      (<span class="keyword">pcase-dolist</span> (`(,key ,description) specials)
                        (insert (format <span class="string">"%s   %s\n"</span> (propertize key 'face '(bold all-the-icons-red)) description))
                        (<span class="keyword">push</span> key allowed-keys)))
                    <span class="comment-delimiter">;; </span><span class="comment">Display UI and let user select an entry or
</span>                    <span class="comment-delimiter">;; </span><span class="comment">a sub-level prefix.
</span>                    (goto-char (point-min))
                    (<span class="keyword">unless</span> (pos-visible-in-window-p (point-max))
                      (org-fit-window-to-buffer))
                    (<span class="keyword">let</span> ((pressed (org--mks-read-key allowed-keys prompt)))
                      (<span class="keyword">setq</span> current (concat current pressed))
                      (<span class="keyword">cond</span>
                       ((equal pressed <span class="string">"\C-g"</span>) (<span class="warning-1">user-error</span> <span class="string">"Abort"</span>))
                       <span class="comment-delimiter">;; </span><span class="comment">Selection is a prefix: open a new menu.
</span>                       ((member pressed des-keys))
                       <span class="comment-delimiter">;; </span><span class="comment">Selection matches an association: return it.
</span>                       ((<span class="keyword">let</span> ((entry (assoc current table)))
                          (<span class="keyword">and</span> entry (<span class="keyword">throw</span> '<span class="constant">exit</span> entry))))
                       <span class="comment-delimiter">;; </span><span class="comment">Selection matches a special entry: return the
</span>                       <span class="comment-delimiter">;; </span><span class="comment">selection prefix.
</span>                       ((assoc current specials) (<span class="keyword">throw</span> '<span class="constant">exit</span> current))
                       (t (<span class="warning-1">error</span> <span class="string">"No entry available"</span>)))))))
            (<span class="keyword">when</span> buffer (kill-buffer buffer))))))
    (advice-add 'org-mks <span class="builtin">:override</span> #'org-mks-pretty)
    (<span class="keyword">setq</span> +org-capture-uni-units (<span class="keyword">condition-case</span> nil
                                     (split-string (f-read-text <span class="string">"~/.org/.uni-units"</span>))
                                   (<span class="warning-1">error</span> nil))
          +org-capture-recipies  <span class="string">"~/Desktop/TEC/Organisation/recipies.org"</span>)
  
    (<span class="keyword">defun</span> <span class="function-name">+doct-icon-declaration-to-icon</span> (declaration)
      <span class="doc">"Convert :icon declaration to icon"</span>
      (<span class="keyword">let</span> ((name (<span class="keyword">pop</span> declaration))
            (set  (intern (concat <span class="string">"all-the-icons-"</span> (plist-get declaration <span class="builtin">:set</span>))))
            (face (intern (concat <span class="string">"all-the-icons-"</span> (plist-get declaration <span class="builtin">:color</span>))))
            (v-adjust (<span class="keyword">or</span> (plist-get declaration <span class="builtin">:v-adjust</span>) <span class="highlight-numbers-number">0.01</span>)))
        (apply set `(,name <span class="builtin">:face</span> ,face <span class="builtin">:v-adjust</span> ,v-adjust))))
  
    (<span class="keyword">defun</span> <span class="function-name">+doct-iconify-capture-templates</span> (groups)
      <span class="doc">"Add declaration's :icon to each template group in GROUPS."</span>
      (<span class="keyword">let</span> ((templates (doct-flatten-lists-in groups)))
        (<span class="keyword">setq</span> doct-templates (mapcar (<span class="keyword">lambda</span> (template)
                                       (<span class="keyword">when-let*</span> ((props (nthcdr (<span class="keyword">if</span> (= (length template) <span class="highlight-numbers-number">4</span>) <span class="highlight-numbers-number">2</span> <span class="highlight-numbers-number">5</span>) template))
                                                   (spec (plist-get (plist-get props <span class="builtin">:doct</span>) <span class="builtin">:icon</span>)))
                                         (<span class="keyword">setf</span> (nth <span class="highlight-numbers-number">1</span> template) (concat (+doct-icon-declaration-to-icon spec)
                                                                        <span class="string">"\t"</span>
                                                                        (nth <span class="highlight-numbers-number">1</span> template))))
                                       template)
                                     templates))))
  
    (<span class="keyword">setq</span> doct-after-conversion-functions '(+doct-iconify-capture-templates))
  
    (<span class="keyword">defun</span> <span class="function-name">set-org-capture-templates</span> ()
      (<span class="keyword">setq</span> org-capture-templates
            (doct `((<span class="string">"Personal todo"</span> <span class="builtin">:keys</span> <span class="string">"t"</span>
                     <span class="builtin">:icon</span> (<span class="string">"checklist"</span> <span class="builtin">:set</span> <span class="string">"octicon"</span> <span class="builtin">:color</span> <span class="string">"green"</span>)
                     <span class="builtin">:file</span> +org-capture-todo-file
                     <span class="builtin">:prepend</span> t
                     <span class="builtin">:headline</span> <span class="string">"Inbox"</span>
                     <span class="builtin">:type</span> entry
                     <span class="builtin">:template</span> (<span class="string">"* </span><span class="bold"><span class="warning">TODO</span></span><span class="string"> %?"</span>
                                <span class="string">"%i %a"</span>)
                     )
                    (<span class="string">"Personal note"</span> <span class="builtin">:keys</span> <span class="string">"n"</span>
                     <span class="builtin">:icon</span> (<span class="string">"sticky-note-o"</span> <span class="builtin">:set</span> <span class="string">"faicon"</span> <span class="builtin">:color</span> <span class="string">"green"</span>)
                     <span class="builtin">:file</span> +org-capture-todo-file
                     <span class="builtin">:prepend</span> t
                     <span class="builtin">:headline</span> <span class="string">"Inbox"</span>
                     <span class="builtin">:type</span> entry
                     <span class="builtin">:template</span> (<span class="string">"* %?"</span>
                                <span class="string">"%i %a"</span>)
                     )
                    (<span class="string">"University"</span> <span class="builtin">:keys</span> <span class="string">"u"</span>
                     <span class="builtin">:icon</span> (<span class="string">"graduation-cap"</span> <span class="builtin">:set</span> <span class="string">"faicon"</span> <span class="builtin">:color</span> <span class="string">"purple"</span>)
                     <span class="builtin">:file</span> +org-capture-todo-file
                     <span class="builtin">:headline</span> <span class="string">"University"</span>
                     <span class="builtin">:unit-prompt</span> ,(format <span class="string">"%%^{Unit|%s}"</span> (string-join +org-capture-uni-units <span class="string">"|"</span>))
                     <span class="builtin">:prepend</span> t
                     <span class="builtin">:type</span> entry
                     <span class="builtin">:children</span> ((<span class="string">"Test"</span> <span class="builtin">:keys</span> <span class="string">"t"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"timer"</span> <span class="builtin">:set</span> <span class="string">"material"</span> <span class="builtin">:color</span> <span class="string">"red"</span>)
                                 <span class="builtin">:template</span> (<span class="string">"* </span><span class="bold"><span class="warning">TODO</span></span><span class="string"> [#C] %{unit-prompt} %? :uni:tests:"</span>
                                            <span class="string">"SCHEDULED: %^{Test date:}T"</span>
                                            <span class="string">"%i %a"</span>))
                                (<span class="string">"Assignment"</span> <span class="builtin">:keys</span> <span class="string">"a"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"library_books"</span> <span class="builtin">:set</span> <span class="string">"material"</span> <span class="builtin">:color</span> <span class="string">"orange"</span>)
                                 <span class="builtin">:template</span> (<span class="string">"* </span><span class="bold"><span class="warning">TODO</span></span><span class="string"> [#B] %{unit-prompt} %? :uni:assignments:"</span>
                                            <span class="string">"DEADLINE: %^{Due date:}T"</span>
                                            <span class="string">"%i %a"</span>))
                                (<span class="string">"Lecture"</span> <span class="builtin">:keys</span> <span class="string">"l"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"keynote"</span> <span class="builtin">:set</span> <span class="string">"fileicon"</span> <span class="builtin">:color</span> <span class="string">"orange"</span>)
                                 <span class="builtin">:template</span> (<span class="string">"* </span><span class="bold"><span class="warning">TODO</span></span><span class="string"> [#C] %{unit-prompt} %? :uni:lecture:"</span>
                                            <span class="string">"%i %a"</span>))
                                (<span class="string">"Miscellaneous task"</span> <span class="builtin">:keys</span> <span class="string">"u"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"list"</span> <span class="builtin">:set</span> <span class="string">"faicon"</span> <span class="builtin">:color</span> <span class="string">"yellow"</span>)
                                 <span class="builtin">:template</span> (<span class="string">"* </span><span class="bold"><span class="warning">TODO</span></span><span class="string"> [#D] %{unit-prompt} %? :uni:"</span>
                                            <span class="string">"%i %a"</span>))))
                    (<span class="string">"Email"</span> <span class="builtin">:keys</span> <span class="string">"e"</span>
                     <span class="builtin">:icon</span> (<span class="string">"envelope"</span> <span class="builtin">:set</span> <span class="string">"faicon"</span> <span class="builtin">:color</span> <span class="string">"blue"</span>)
                     <span class="builtin">:file</span> +org-capture-todo-file
                     <span class="builtin">:prepend</span> t
                     <span class="builtin">:headline</span> <span class="string">"Inbox"</span>
                     <span class="builtin">:type</span> entry
                     <span class="builtin">:template</span> (<span class="string">"* </span><span class="bold"><span class="warning">TODO</span></span><span class="string"> %^{type|reply to|contact} %\\3 %? :email:"</span>
                                <span class="string">"Send an email %^{urgancy|soon|ASAP|anon|at some point|eventually} to %^{recipiant}"</span>
                                <span class="string">"about %^{topic}"</span>
                                <span class="string">"%U %i %a"</span>))
                    (<span class="string">"Interesting"</span> <span class="builtin">:keys</span> <span class="string">"i"</span>
                     <span class="builtin">:icon</span> (<span class="string">"eye"</span> <span class="builtin">:set</span> <span class="string">"faicon"</span> <span class="builtin">:color</span> <span class="string">"lcyan"</span>)
                     <span class="builtin">:file</span> +org-capture-todo-file
                     <span class="builtin">:prepend</span> t
                     <span class="builtin">:headline</span> <span class="string">"Interesting"</span>
                     <span class="builtin">:type</span> entry
                     <span class="builtin">:template</span> (<span class="string">"* [ ] %{desc}%? :%{i-type}:"</span>
                                <span class="string">"%i %a"</span>)
                     <span class="builtin">:children</span> ((<span class="string">"Webpage"</span> <span class="builtin">:keys</span> <span class="string">"w"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"globe"</span> <span class="builtin">:set</span> <span class="string">"faicon"</span> <span class="builtin">:color</span> <span class="string">"green"</span>)
                                 <span class="builtin">:desc</span> <span class="string">"%(org-cliplink-capture) "</span>
                                 <span class="builtin">:i-type</span> <span class="string">"read:web"</span>
                                 )
                                (<span class="string">"Article"</span> <span class="builtin">:keys</span> <span class="string">"a"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"file-text"</span> <span class="builtin">:set</span> <span class="string">"octicon"</span> <span class="builtin">:color</span> <span class="string">"yellow"</span>)
                                 <span class="builtin">:desc</span> <span class="string">""</span>
                                 <span class="builtin">:i-type</span> <span class="string">"read:reaserch"</span>
                                 )
                                (<span class="string">"\tRecipie"</span> <span class="builtin">:keys</span> <span class="string">"r"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"spoon"</span> <span class="builtin">:set</span> <span class="string">"faicon"</span> <span class="builtin">:color</span> <span class="string">"dorange"</span>)
                                 <span class="builtin">:file</span> +org-capture-recipies
                                 <span class="builtin">:headline</span> <span class="string">"Unsorted"</span>
                                 <span class="builtin">:template</span> <span class="string">"%(org-chef-get-recipe-from-url)"</span>
                                 )
                                (<span class="string">"Information"</span> <span class="builtin">:keys</span> <span class="string">"i"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"info-circle"</span> <span class="builtin">:set</span> <span class="string">"faicon"</span> <span class="builtin">:color</span> <span class="string">"blue"</span>)
                                 <span class="builtin">:desc</span> <span class="string">""</span>
                                 <span class="builtin">:i-type</span> <span class="string">"read:info"</span>
                                 )
                                (<span class="string">"Idea"</span> <span class="builtin">:keys</span> <span class="string">"I"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"bubble_chart"</span> <span class="builtin">:set</span> <span class="string">"material"</span> <span class="builtin">:color</span> <span class="string">"silver"</span>)
                                 <span class="builtin">:desc</span> <span class="string">""</span>
                                 <span class="builtin">:i-type</span> <span class="string">"idea"</span>
                                 )))
                    (<span class="string">"Tasks"</span> <span class="builtin">:keys</span> <span class="string">"k"</span>
                     <span class="builtin">:icon</span> (<span class="string">"inbox"</span> <span class="builtin">:set</span> <span class="string">"octicon"</span> <span class="builtin">:color</span> <span class="string">"yellow"</span>)
                     <span class="builtin">:file</span> +org-capture-todo-file
                     <span class="builtin">:prepend</span> t
                     <span class="builtin">:headline</span> <span class="string">"Tasks"</span>
                     <span class="builtin">:type</span> entry
                     <span class="builtin">:template</span> (<span class="string">"* </span><span class="bold"><span class="warning">TODO</span></span><span class="string"> %? %^G%{extra}"</span>
                                <span class="string">"%i %a"</span>)
                     <span class="builtin">:children</span> ((<span class="string">"General Task"</span> <span class="builtin">:keys</span> <span class="string">"k"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"inbox"</span> <span class="builtin">:set</span> <span class="string">"octicon"</span> <span class="builtin">:color</span> <span class="string">"yellow"</span>)
                                 <span class="builtin">:extra</span> <span class="string">""</span>
                                 )
                                (<span class="string">"Task with deadline"</span> <span class="builtin">:keys</span> <span class="string">"d"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"timer"</span> <span class="builtin">:set</span> <span class="string">"material"</span> <span class="builtin">:color</span> <span class="string">"orange"</span> <span class="builtin">:v-adjust</span> <span class="highlight-numbers-number">-0.1</span>)
                                 <span class="builtin">:extra</span> <span class="string">"\nDEADLINE: %^{Deadline:}t"</span>
                                 )
                                (<span class="string">"Scheduled Task"</span> <span class="builtin">:keys</span> <span class="string">"s"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"calendar"</span> <span class="builtin">:set</span> <span class="string">"octicon"</span> <span class="builtin">:color</span> <span class="string">"orange"</span>)
                                 <span class="builtin">:extra</span> <span class="string">"\nSCHEDULED: %^{Start time:}t"</span>
                                 )
                                ))
                    (<span class="string">"Project"</span> <span class="builtin">:keys</span> <span class="string">"p"</span>
                     <span class="builtin">:icon</span> (<span class="string">"repo"</span> <span class="builtin">:set</span> <span class="string">"octicon"</span> <span class="builtin">:color</span> <span class="string">"silver"</span>)
                     <span class="builtin">:prepend</span> t
                     <span class="builtin">:type</span> entry
                     <span class="builtin">:headline</span> <span class="string">"Inbox"</span>
                     <span class="builtin">:template</span> (<span class="string">"* %{time-or-todo} %?"</span>
                                <span class="string">"%i"</span>
                                <span class="string">"%a"</span>)
                     <span class="builtin">:file</span> <span class="string">""</span>
                     <span class="builtin">:custom</span> (<span class="builtin">:time-or-todo</span> <span class="string">""</span>)
                     <span class="builtin">:children</span> ((<span class="string">"Project-local todo"</span> <span class="builtin">:keys</span> <span class="string">"t"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"checklist"</span> <span class="builtin">:set</span> <span class="string">"octicon"</span> <span class="builtin">:color</span> <span class="string">"green"</span>)
                                 <span class="builtin">:time-or-todo</span> <span class="string">"</span><span class="bold"><span class="warning">TODO</span></span><span class="string">"</span>
                                 <span class="builtin">:file</span> +org-capture-project-todo-file)
                                (<span class="string">"Project-local note"</span> <span class="builtin">:keys</span> <span class="string">"n"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"sticky-note"</span> <span class="builtin">:set</span> <span class="string">"faicon"</span> <span class="builtin">:color</span> <span class="string">"yellow"</span>)
                                 <span class="builtin">:time-or-todo</span> <span class="string">"%U"</span>
                                 <span class="builtin">:file</span> +org-capture-project-notes-file)
                                (<span class="string">"Project-local changelog"</span> <span class="builtin">:keys</span> <span class="string">"c"</span>
                                 <span class="builtin">:icon</span> (<span class="string">"list"</span> <span class="builtin">:set</span> <span class="string">"faicon"</span> <span class="builtin">:color</span> <span class="string">"blue"</span>)
                                 <span class="builtin">:time-or-todo</span> <span class="string">"%U"</span>
                                 <span class="builtin">:heading</span> <span class="string">"Unreleased"</span>
                                 <span class="builtin">:file</span> +org-capture-project-changelog-file))
                     )
                    (<span class="string">"\tCentralised project templates"</span>
                     <span class="builtin">:keys</span> <span class="string">"o"</span>
                     <span class="builtin">:type</span> entry
                     <span class="builtin">:prepend</span> t
                     <span class="builtin">:template</span> (<span class="string">"* %{time-or-todo} %?"</span>
                                <span class="string">"%i"</span>
                                <span class="string">"%a"</span>)
                     <span class="builtin">:children</span> ((<span class="string">"Project todo"</span>
                                 <span class="builtin">:keys</span> <span class="string">"t"</span>
                                 <span class="builtin">:prepend</span> nil
                                 <span class="builtin">:time-or-todo</span> <span class="string">"</span><span class="bold"><span class="warning">TODO</span></span><span class="string">"</span>
                                 <span class="builtin">:heading</span> <span class="string">"Tasks"</span>
                                 <span class="builtin">:file</span> +org-capture-central-project-todo-file)
                                (<span class="string">"Project note"</span>
                                 <span class="builtin">:keys</span> <span class="string">"n"</span>
                                 <span class="builtin">:time-or-todo</span> <span class="string">"%U"</span>
                                 <span class="builtin">:heading</span> <span class="string">"Notes"</span>
                                 <span class="builtin">:file</span> +org-capture-central-project-notes-file)
                                (<span class="string">"Project changelog"</span>
                                 <span class="builtin">:keys</span> <span class="string">"c"</span>
                                 <span class="builtin">:time-or-todo</span> <span class="string">"%U"</span>
                                 <span class="builtin">:heading</span> <span class="string">"Unreleased"</span>
                                 <span class="builtin">:file</span> +org-capture-central-project-changelog-file))
                     )))))
  
    (set-org-capture-templates)
    (<span class="keyword">unless</span> (display-graphic-p)
      (add-hook 'server-after-make-frame-hook
                (<span class="keyword">defun</span> <span class="function-name">org-capture-reinitialise-hook</span> ()
                  (<span class="keyword">when</span> (display-graphic-p)
                    (set-org-capture-templates)
                    (remove-hook 'server-after-make-frame-hook
                                 #'org-capture-reinitialise-hook))))))
  (<span class="keyword">defun</span> <span class="function-name">org-capture-select-template-prettier</span> (<span class="type">&amp;optional</span> keys)
    <span class="doc">"Select a capture template, in a prettier way than default
  Lisp programs can force the template by setting KEYS to a string."</span>
    (<span class="keyword">let</span> ((org-capture-templates
           (<span class="keyword">or</span> (org-contextualize-keys
                (org-capture-upgrade-templates org-capture-templates)
                org-capture-templates-contexts)
               '((<span class="string">"t"</span> <span class="string">"Task"</span> entry (file+headline <span class="string">""</span> <span class="string">"Tasks"</span>)
                  <span class="string">"* </span><span class="bold"><span class="warning">TODO</span></span><span class="string"> %?\n  %u\n  %a"</span>)))))
      (<span class="keyword">if</span> keys
          (<span class="keyword">or</span> (assoc keys org-capture-templates)
              (<span class="warning-1">error</span> <span class="string">"No capture template referred to by \"%s\" keys"</span> keys))
        (org-mks org-capture-templates
                 <span class="string">"Select a capture template\n&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;&#226;&#148;&#129;"</span>
                 <span class="string">"Template key: "</span>
                 `((<span class="string">"q"</span> ,(concat (all-the-icons-octicon <span class="string">"stop"</span> <span class="builtin">:face</span> 'all-the-icons-red <span class="builtin">:v-adjust</span> <span class="highlight-numbers-number">0.01</span>) <span class="string">"\tAbort"</span>)))))))
  (advice-add 'org-capture-select-template <span class="builtin">:override</span> #'org-capture-select-template-prettier)
  
  (<span class="keyword">defun</span> <span class="function-name">org-mks-pretty</span> (table title <span class="type">&amp;optional</span> prompt specials)
    <span class="doc">"Select a member of an alist with multiple keys. Prettified.
  
  TABLE is the alist which should contain entries where the car is a string.
  There should be two types of entries.
  
  1. prefix descriptions like (\"a\" \"Description\")
     This indicates that `a' is a prefix key for multi-letter selection, and
     that there are entries following with keys like \"ab\", \"ax\"&#226;&#128;&#166;
  
  2. Select-able members must have more than two elements, with the first
     being the string of keys that lead to selecting it, and the second a
     short description string of the item.
  
  The command will then make a temporary buffer listing all entries
  that can be selected with a single key, and all the single key
  prefixes.  When you press the key for a single-letter entry, it is selected.
  When you press a prefix key, the commands (and maybe further prefixes)
  under this key will be shown and offered for selection.
  
  TITLE will be placed over the selection in the temporary buffer,
  PROMPT will be used when prompting for a key.  SPECIALS is an
  alist with (\"key\" \"description\") entries.  When one of these
  is selected, only the bare key is returned."</span>
    (<span class="keyword">save-window-excursion</span>
      (<span class="keyword">let</span> ((inhibit-quit t)
            (buffer (org-switch-to-buffer-other-window <span class="string">"*Org Select*"</span>))
            (prompt (<span class="keyword">or</span> prompt <span class="string">"Select: "</span>))
            case-fold-search
            current)
        (<span class="keyword">unwind-protect</span>
            (<span class="keyword">catch</span> '<span class="constant">exit</span>
              (<span class="keyword">while</span> t
                (<span class="keyword">setq-local</span> evil-normal-state-cursor (list nil))
                (erase-buffer)
                (insert title <span class="string">"\n\n"</span>)
                (<span class="keyword">let</span> ((des-keys nil)
                      (allowed-keys '(<span class="string">"\C-g"</span>))
                      (tab-alternatives '(<span class="string">"\s"</span> <span class="string">"\t"</span> <span class="string">"\r"</span>))
                      (cursor-type nil))
                  <span class="comment-delimiter">;; </span><span class="comment">Populate allowed keys and descriptions keys
</span>                  <span class="comment-delimiter">;; </span><span class="comment">available with CURRENT selector.
</span>                  (<span class="keyword">let</span> ((re (format <span class="string">"\\`%s</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">.</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">\\'"</span>
                                    (<span class="keyword">if</span> current (regexp-quote current) <span class="string">""</span>)))
                        (prefix (<span class="keyword">if</span> current (concat current <span class="string">" "</span>) <span class="string">""</span>)))
                    (<span class="keyword">dolist</span> (entry table)
                      (<span class="keyword">pcase</span> entry
                        <span class="comment-delimiter">;; </span><span class="comment">Description.
</span>                        (`(,(<span class="keyword">and</span> key (pred (string-match re))) ,desc)
                         (<span class="keyword">let</span> ((k (match-string <span class="highlight-numbers-number">1</span> key)))
                           (<span class="keyword">push</span> k des-keys)
                           <span class="comment-delimiter">;; </span><span class="comment">Keys ending in tab, space or RET are equivalent.
</span>                           (<span class="keyword">if</span> (member k tab-alternatives)
                               (<span class="keyword">push</span> <span class="string">"\t"</span> allowed-keys)
                             (<span class="keyword">push</span> k allowed-keys))
                           (insert (propertize prefix 'face 'font-lock-comment-face) (propertize k 'face 'bold) (propertize <span class="string">"&#226;&#128;&#186;"</span> 'face 'font-lock-comment-face) <span class="string">"  "</span> desc <span class="string">"&#226;&#128;&#166;"</span> <span class="string">"\n"</span>)))
                        <span class="comment-delimiter">;; </span><span class="comment">Usable entry.
</span>                        (`(,(<span class="keyword">and</span> key (pred (string-match re))) ,desc . ,_)
                         (<span class="keyword">let</span> ((k (match-string <span class="highlight-numbers-number">1</span> key)))
                           (insert (propertize prefix 'face 'font-lock-comment-face) (propertize k 'face 'bold) <span class="string">"   "</span> desc <span class="string">"\n"</span>)
                           (<span class="keyword">push</span> k allowed-keys)))
                        (_ nil))))
                  <span class="comment-delimiter">;; </span><span class="comment">Insert special entries, if any.
</span>                  (<span class="keyword">when</span> specials
                    (insert <span class="string">"&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;&#226;&#148;&#128;\n"</span>)
                    (<span class="keyword">pcase-dolist</span> (`(,key ,description) specials)
                      (insert (format <span class="string">"%s   %s\n"</span> (propertize key 'face '(bold all-the-icons-red)) description))
                      (<span class="keyword">push</span> key allowed-keys)))
                  <span class="comment-delimiter">;; </span><span class="comment">Display UI and let user select an entry or
</span>                  <span class="comment-delimiter">;; </span><span class="comment">a sub-level prefix.
</span>                  (goto-char (point-min))
                  (<span class="keyword">unless</span> (pos-visible-in-window-p (point-max))
                    (org-fit-window-to-buffer))
                  (<span class="keyword">let</span> ((pressed (org--mks-read-key allowed-keys prompt)))
                    (<span class="keyword">setq</span> current (concat current pressed))
                    (<span class="keyword">cond</span>
                     ((equal pressed <span class="string">"\C-g"</span>) (<span class="warning-1">user-error</span> <span class="string">"Abort"</span>))
                     <span class="comment-delimiter">;; </span><span class="comment">Selection is a prefix: open a new menu.
</span>                     ((member pressed des-keys))
                     <span class="comment-delimiter">;; </span><span class="comment">Selection matches an association: return it.
</span>                     ((<span class="keyword">let</span> ((entry (assoc current table)))
                        (<span class="keyword">and</span> entry (<span class="keyword">throw</span> '<span class="constant">exit</span> entry))))
                     <span class="comment-delimiter">;; </span><span class="comment">Selection matches a special entry: return the
</span>                     <span class="comment-delimiter">;; </span><span class="comment">selection prefix.
</span>                     ((assoc current specials) (<span class="keyword">throw</span> '<span class="constant">exit</span> current))
                     (t (<span class="warning-1">error</span> <span class="string">"No entry available"</span>)))))))
          (<span class="keyword">when</span> buffer (kill-buffer buffer))))))
  (advice-add 'org-mks <span class="builtin">:override</span> #'org-mks-pretty)
  (<span class="keyword">setf</span> (alist-get 'height +org-capture-frame-parameters) <span class="highlight-numbers-number">15</span>)
  <span class="comment-delimiter">;; </span><span class="comment">(alist-get 'name +org-capture-frame-parameters) "&#226;&#157;&#150; Capture") ;; ATM hardcoded in other places, so changing breaks stuff
</span>  (<span class="keyword">setq</span> +org-capture-fn
        (<span class="keyword">lambda</span> ()
          (<span class="keyword">interactive</span>)
          (set-window-parameter nil 'mode-line-format 'none)
          (org-capture)))
  (<span class="keyword">after!</span> org-roam
    (<span class="keyword">setq</span> org-roam-graph-node-extra-config
          '((<span class="string">"shape"</span>      . <span class="string">"underline"</span>)
            (<span class="string">"style"</span>      . <span class="string">"rounded,filled"</span>)
            (<span class="string">"fillcolor"</span>  . <span class="string">"#EEEEEE"</span>)
            (<span class="string">"color"</span>      . <span class="string">"#C9C9C9"</span>)
            (<span class="string">"fontcolor"</span>  . <span class="string">"#111111"</span>)
            (<span class="string">"fontname"</span>   . <span class="string">"Overpass"</span>)))
  
    (<span class="keyword">setq</span> +org-roam-graph--html-template
          (replace-regexp-in-string <span class="string">"%</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[</span><span class="string"><span class="negation-char">^</span></span><span class="string">s]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">"</span> <span class="string">"%%\\1"</span>
                                    (f-read-text (concat doom-private-dir <span class="string">"misc/org-roam-template.html"</span>))))
  
    (<span class="keyword">defadvice!</span> +org-roam-graph--build-html (<span class="type">&amp;optional</span> node-query callback)
      <span class="doc">"Generate a graph showing the relations between nodes in NODE-QUERY. HTML style."</span>
      <span class="builtin">:override</span> #'org-roam-graph--build
      (<span class="keyword">unless</span> (stringp org-roam-graph-executable)
        (<span class="warning-1">user-error</span> <span class="string">"`</span><span class="string"><span class="constant">org-roam-graph-executable</span></span><span class="string">' is not a string"</span>))
      (<span class="keyword">unless</span> (executable-find org-roam-graph-executable)
        (<span class="warning-1">user-error</span> (concat <span class="string">"Cannot find executable %s to generate the graph.  "</span>
                            <span class="string">"Please adjust `</span><span class="string"><span class="constant">org-roam-graph-executable</span></span><span class="string">'"</span>)
                    org-roam-graph-executable))
      (<span class="keyword">let*</span> ((node-query (<span class="keyword">or</span> node-query
                             `[<span class="builtin">:select</span> [file titles] <span class="builtin">:from</span> titles
                               ,@(org-roam-graph--expand-matcher 'file t)]))
             (graph      (org-roam-graph--dot node-query))
             (temp-dot   (make-temp-file <span class="string">"graph."</span> nil <span class="string">".dot"</span> graph))
             (temp-graph (make-temp-file <span class="string">"graph."</span> nil <span class="string">".svg"</span>))
             (temp-html  (make-temp-file <span class="string">"graph."</span> nil <span class="string">".html"</span>)))
        (org-roam-message <span class="string">"building graph"</span>)
        (make-process
         <span class="builtin">:name</span> <span class="string">"*org-roam-graph--build-process*"</span>
         <span class="builtin">:buffer</span> <span class="string">"*org-roam-graph--build-process*"</span>
         <span class="builtin">:command</span> `(,org-roam-graph-executable ,temp-dot <span class="string">"-Tsvg"</span> <span class="string">"-o"</span> ,temp-graph)
         <span class="builtin">:sentinel</span> (<span class="keyword">progn</span>
                     (<span class="keyword">lambda</span> (process _event)
                       (<span class="keyword">when</span> (= <span class="highlight-numbers-number">0</span> (process-exit-status process))
                         (write-region (format +org-roam-graph--html-template (f-read-text temp-graph)) nil temp-html)
                         (<span class="keyword">when</span> callback
                           (funcall callback temp-html)))))))))
  (<span class="keyword">defadvice!</span> doom-modeline--buffer-file-name-roam-aware-a (orig-fun)
    <span class="builtin">:around</span> #'doom-modeline-buffer-file-name <span class="comment-delimiter">; </span><span class="comment">takes no args
</span>    (<span class="keyword">if</span> (s-contains-p org-roam-directory (<span class="keyword">or</span> buffer-file-name <span class="string">""</span>))
        (replace-regexp-in-string
         <span class="string">"</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(?:</span></span><span class="string">^</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">|</span></span><span class="string">.*/</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[0-9]\\{4\\}</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[0-9]\\{2\\}</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[0-9]\\{2\\}</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">[0-9]*-"</span>
         <span class="string">"&#240;&#159;&#162;&#148;(\\1-\\2-\\3) "</span>
         (subst-char-in-string ?_ ?  buffer-file-name))
      (funcall orig-fun)))
  (<span class="keyword">defvar</span> <span class="variable-name">org-reference-contraction-max-words</span> <span class="highlight-numbers-number">3</span>
    <span class="doc">"Maximum number of words in a reference reference."</span>)
  (<span class="keyword">defvar</span> <span class="variable-name">org-reference-contraction-max-length</span> <span class="highlight-numbers-number">35</span>
    <span class="doc">"Maximum length of resulting reference reference, including joining characters."</span>)
  (<span class="keyword">defvar</span> <span class="variable-name">org-reference-contraction-stripped-words</span>
    '(<span class="string">"the"</span> <span class="string">"on"</span> <span class="string">"in"</span> <span class="string">"off"</span> <span class="string">"a"</span> <span class="string">"for"</span> <span class="string">"by"</span> <span class="string">"of"</span> <span class="string">"and"</span> <span class="string">"is"</span> <span class="string">"to"</span>)
    <span class="doc">"Superfluous words to be removed from a reference."</span>)
  (<span class="keyword">defvar</span> <span class="variable-name">org-reference-contraction-joining-char</span> <span class="string">"-"</span>
    <span class="doc">"Character used to join words in the reference reference."</span>)
  
  (<span class="keyword">defun</span> <span class="function-name">org-reference-contraction-truncate-words</span> (words)
    <span class="doc">"Using `</span><span class="doc"><span class="constant">org-reference-contraction-max-length</span></span><span class="doc">' as the total character 'budget' for the WORDS
  and truncate individual words to conform to this budget.
  
  To arrive at a budget that accounts for words undershooting their requisite average length,
  the number of charachters in the budget freed by short words is distributed among the words
  exceeding the average length.  This adjusts the per-word budget to be the maximum feasable for
  this particular situation, rather than the universal maximum average.
  
  This budget-adjusted per-word maximum length is given by the mathematical expression below:
  
  max length = \\floor{ \\frac{total length - chars for seperators - \\sum_{word \\leq average length} length(word) }{num(words) &gt; average length} }"</span>
    <span class="comment-delimiter">;; </span><span class="comment">trucate each word to a max word length determined by
</span>    <span class="comment-delimiter">;;</span><span class="comment">
</span>    (<span class="keyword">let*</span> ((total-length-budget (- org-reference-contraction-max-length  <span class="comment-delimiter">; </span><span class="comment">how many non-separator chars we can use
</span>                                   (1- (length words))))
           (word-length-budget (/ total-length-budget                      <span class="comment-delimiter">; </span><span class="comment">max length of each word to keep within budget
</span>                                  org-reference-contraction-max-words))
           (num-overlong (-count (<span class="keyword">lambda</span> (word)                            <span class="comment-delimiter">; </span><span class="comment">how many words exceed that budget
</span>                                   (&gt; (length word) word-length-budget))
                                 words))
           (total-short-length (-sum (mapcar (<span class="keyword">lambda</span> (word)                <span class="comment-delimiter">; </span><span class="comment">total length of words under that budget
</span>                                               (<span class="keyword">if</span> (&lt;= (length word) word-length-budget)
                                                   (length word) <span class="highlight-numbers-number">0</span>))
                                             words)))
           (max-length (/ (- total-length-budget total-short-length)       <span class="comment-delimiter">; </span><span class="comment">max(max-length) that we can have to fit within the budget
</span>                          num-overlong)))
      (mapcar (<span class="keyword">lambda</span> (word)
                (<span class="keyword">if</span> (&lt;= (length word) max-length)
                    word
                  (substring word <span class="highlight-numbers-number">0</span> max-length)))
              words)))
  
  (<span class="keyword">defun</span> <span class="function-name">org-reference-contraction</span> (reference-string)
    <span class="doc">"Give a contracted form of REFERENCE-STRING that is only contains alphanumeric characters.
  Strips 'joining' words present in `</span><span class="doc"><span class="constant">org-reference-contraction-stripped-words</span></span><span class="doc">',
  and then limits the result to the first `</span><span class="doc"><span class="constant">org-reference-contraction-max-words</span></span><span class="doc">' words.
  If the total length is &gt; `</span><span class="doc"><span class="constant">org-reference-contraction-max-length</span></span><span class="doc">' then individual words are
  truncated to fit within the limit using `</span><span class="doc"><span class="constant">org-reference-contraction-truncate-words</span></span><span class="doc">'."</span>
    (<span class="keyword">let</span> ((reference-words
           (-filter (<span class="keyword">lambda</span> (word)
                      (not (member word org-reference-contraction-stripped-words)))
                    (split-string
                     (<span class="keyword">-&gt;&gt;</span> reference-string
                          downcase
                          (replace-regexp-in-string <span class="string">"\\[\\[[</span><span class="string"><span class="negation-char">^</span></span><span class="string">]]+\\]\\[</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[</span><span class="string"><span class="negation-char">^</span></span><span class="string">]]+</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">\\]\\]"</span> <span class="string">"\\1"</span>) <span class="comment-delimiter">; </span><span class="comment">get description from org-link
</span>                          (replace-regexp-in-string <span class="string">"[-/ ]+"</span> <span class="string">" "</span>) <span class="comment-delimiter">; </span><span class="comment">replace seperator-type chars with space
</span>                          (replace-regexp-in-string <span class="string">"[</span><span class="string"><span class="negation-char">^</span></span><span class="string">a-z0-9 ]"</span> <span class="string">""</span>) <span class="comment-delimiter">; </span><span class="comment">strip chars which need %-encoding in a uri
</span>                          ) <span class="string">" "</span>))))
      (<span class="keyword">when</span> (&gt; (length reference-words)
               org-reference-contraction-max-words)
        (<span class="keyword">setq</span> reference-words
              (cl-subseq reference-words <span class="highlight-numbers-number">0</span> org-reference-contraction-max-words)))
  
      (<span class="keyword">when</span> (&gt; (apply #'+ (1- (length reference-words))
                      (mapcar #'length reference-words))
               org-reference-contraction-max-length)
        (<span class="keyword">setq</span> reference-words (org-reference-contraction-truncate-words reference-words)))
  
      (string-join reference-words org-reference-contraction-joining-char)))
  (<span class="keyword">define-minor-mode</span> <span class="function-name">unpackaged/org-export-html-with-useful-ids-mode</span>
    <span class="doc">"Attempt to export Org as HTML with useful link IDs.
  Instead of random IDs like \"#orga1b2c3\", use heading titles,
  made unique when necessary."</span>
    <span class="builtin">:global</span> t
    (<span class="keyword">if</span> unpackaged/org-export-html-with-useful-ids-mode
        (advice-add #'org-export-get-reference <span class="builtin">:override</span> #'unpackaged/org-export-get-reference)
      (advice-remove #'org-export-get-reference #'unpackaged/org-export-get-reference)))
  (unpackaged/org-export-html-with-useful-ids-mode <span class="highlight-numbers-number">1</span>) <span class="comment-delimiter">; </span><span class="comment">ensure enabled, and advice run
</span>  
  (<span class="keyword">defun</span> <span class="function-name">unpackaged/org-export-get-reference</span> (datum info)
    <span class="doc">"Like `</span><span class="doc"><span class="constant">org-export-get-reference</span></span><span class="doc">', except uses heading titles instead of random numbers."</span>
    (<span class="keyword">let</span> ((cache (plist-get info <span class="builtin">:internal-references</span>)))
      (<span class="keyword">or</span> (car (rassq datum cache))
          (<span class="keyword">let*</span> ((crossrefs (plist-get info <span class="builtin">:crossrefs</span>))
                 (cells (org-export-search-cells datum))
                 <span class="comment-delimiter">;; </span><span class="comment">Preserve any pre-existing association between
</span>                 <span class="comment-delimiter">;; </span><span class="comment">a search cell and a reference, i.e., when some
</span>                 <span class="comment-delimiter">;; </span><span class="comment">previously published document referenced a location
</span>                 <span class="comment-delimiter">;; </span><span class="comment">within current file (see
</span>                 <span class="comment-delimiter">;; </span><span class="comment">`</span><span class="comment"><span class="constant">org-publish-resolve-external-link</span></span><span class="comment">').
</span>                 <span class="comment-delimiter">;;</span><span class="comment">
</span>                 <span class="comment-delimiter">;; </span><span class="comment">However, there is no guarantee that search cells are
</span>                 <span class="comment-delimiter">;; </span><span class="comment">unique, e.g., there might be duplicate custom ID or
</span>                 <span class="comment-delimiter">;; </span><span class="comment">two headings with the same title in the file.
</span>                 <span class="comment-delimiter">;;</span><span class="comment">
</span>                 <span class="comment-delimiter">;; </span><span class="comment">As a consequence, before re-using any reference to
</span>                 <span class="comment-delimiter">;; </span><span class="comment">an element or object, we check that it doesn't refer
</span>                 <span class="comment-delimiter">;; </span><span class="comment">to a previous element or object.
</span>                 (new (<span class="keyword">or</span> (cl-some
                           (<span class="keyword">lambda</span> (cell)
                             (<span class="keyword">let</span> ((stored (cdr (assoc cell crossrefs))))
                               (<span class="keyword">when</span> stored
                                 (<span class="keyword">let</span> ((old (org-export-format-reference stored)))
                                   (<span class="keyword">and</span> (not (assoc old cache)) stored)))))
                           cells)
                          (<span class="keyword">when</span> (org-element-property <span class="builtin">:raw-value</span> datum)
                            <span class="comment-delimiter">;; </span><span class="comment">Heading with a title
</span>                            (unpackaged/org-export-new-named-reference datum cache))
                          (<span class="keyword">when</span> (member (car datum) '(src-block table example fixed-width property-drawer))
                            <span class="comment-delimiter">;; </span><span class="comment">Nameable elements
</span>                            (unpackaged/org-export-new-named-reference datum cache))
                          <span class="comment-delimiter">;; </span><span class="bold"><span class="success">NOTE:</span></span><span class="comment"> This probably breaks some Org Export
</span>                          <span class="comment-delimiter">;; </span><span class="comment">feature, but if it does what I need, fine.
</span>                          (org-export-format-reference
                           (org-export-new-reference cache))))
                 (reference-string new))
            <span class="comment-delimiter">;; </span><span class="comment">Cache contains both data already associated to
</span>            <span class="comment-delimiter">;; </span><span class="comment">a reference and in-use internal references, so as to make
</span>            <span class="comment-delimiter">;; </span><span class="comment">unique references.
</span>            (<span class="keyword">dolist</span> (cell cells) (<span class="keyword">push</span> (cons cell new) cache))
            <span class="comment-delimiter">;; </span><span class="comment">Retain a direct association between reference string and
</span>            <span class="comment-delimiter">;; </span><span class="comment">DATUM since (1) not every object or element can be given
</span>            <span class="comment-delimiter">;; </span><span class="comment">a search cell (2) it permits quick lookup.
</span>            (<span class="keyword">push</span> (cons reference-string datum) cache)
            (plist-put info <span class="builtin">:internal-references</span> cache)
            reference-string))))
  
  (<span class="keyword">defun</span> <span class="function-name">unpackaged/org-export-new-named-reference</span> (datum cache)
    <span class="doc">"Return new reference for DATUM that is unique in CACHE."</span>
    (<span class="keyword">cl-macrolet</span> ((inc-suffixf (place)
                               `(<span class="keyword">progn</span>
                                  (string-match (<span class="keyword">rx</span> bos
                                                    (minimal-match (group (1+ anything)))
                                                    (optional <span class="string">"--"</span> (group (1+ digit)))
                                                    eos)
                                                ,place)
                                  <span class="comment-delimiter">;; </span><span class="bold"><span class="constant">HACK:</span></span><span class="comment"> `</span><span class="comment"><span class="constant">s1</span></span><span class="comment">' instead of a gensym.
</span>                                  (<span class="keyword">-let*</span> (((s1 suffix) (list (match-string <span class="highlight-numbers-number">1</span> ,place)
                                                             (match-string <span class="highlight-numbers-number">2</span> ,place)))
                                          (suffix (<span class="keyword">if</span> suffix
                                                      (string-to-number suffix)
                                                    <span class="highlight-numbers-number">0</span>)))
                                    (<span class="keyword">setf</span> ,place (format <span class="string">"%s--%s"</span> s1 (<span class="keyword">cl-incf</span> suffix)))))))
      (<span class="keyword">let*</span> ((headline-p (eq (car datum) 'headline))
             (title (<span class="keyword">if</span> headline-p
                        (org-element-property <span class="builtin">:raw-value</span> datum)
                      (<span class="keyword">or</span> (org-element-property <span class="builtin">:name</span> datum)
                          (concat (org-element-property <span class="builtin">:raw-value</span>
                                                        (org-element-property <span class="builtin">:parent</span>
                                                                              (org-element-property <span class="builtin">:parent</span> datum)))))))
             <span class="comment-delimiter">;; </span><span class="comment">get ascii-only form of title without needing percent-encoding
</span>             (ref (concat (org-reference-contraction (substring-no-properties title))
                          (<span class="keyword">unless</span> (<span class="keyword">or</span> headline-p (org-element-property <span class="builtin">:name</span> datum))
                            (concat <span class="string">","</span>
                                    (<span class="keyword">pcase</span> (car datum)
                                      ('src-block <span class="string">"code"</span>)
                                      ('example <span class="string">"example"</span>)
                                      ('fixed-width <span class="string">"mono"</span>)
                                      ('property-drawer <span class="string">"properties"</span>)
                                      (_ (symbol-name (car datum))))
                                    <span class="string">"--1"</span>))))
             (parent (<span class="keyword">when</span> headline-p (org-element-property <span class="builtin">:parent</span> datum))))
        (<span class="keyword">while</span> (<span class="keyword">--any</span> (equal ref (car it))
                      cache)
          <span class="comment-delimiter">;; </span><span class="comment">Title not unique: make it so.
</span>          (<span class="keyword">if</span> parent
              <span class="comment-delimiter">;; </span><span class="comment">Append ancestor title.
</span>              (<span class="keyword">setf</span> title (concat (org-element-property <span class="builtin">:raw-value</span> parent)
                                  <span class="string">"--"</span> title)
                    <span class="comment-delimiter">;; </span><span class="comment">get ascii-only form of title without needing percent-encoding
</span>                    ref (org-reference-contraction (substring-no-properties title))
                    parent (<span class="keyword">when</span> headline-p (org-element-property <span class="builtin">:parent</span> parent)))
            <span class="comment-delimiter">;; </span><span class="comment">No more ancestors: add and increment a number.
</span>            (inc-suffixf ref)))
        ref)))
  
  (add-hook 'org-load-hook #'unpackaged/org-export-html-with-useful-ids-mode)
  (<span class="keyword">defun</span> <span class="function-name">unpackaged/org-element-descendant-of</span> (type element)
    <span class="doc">"Return non-nil if ELEMENT is a descendant of TYPE.
  TYPE should be an element type, like `</span><span class="doc"><span class="constant">item</span></span><span class="doc">' or `</span><span class="doc"><span class="constant">paragraph</span></span><span class="doc">'.
  ELEMENT should be a list like that returned by `</span><span class="doc"><span class="constant">org-element-context</span></span><span class="doc">'."</span>
    <span class="comment-delimiter">;; </span><span class="comment">MAYBE: Use `</span><span class="comment"><span class="constant">org-element-lineage</span></span><span class="comment">'.
</span>    (<span class="keyword">when-let*</span> ((parent (org-element-property <span class="builtin">:parent</span> element)))
      (<span class="keyword">or</span> (eq type (car parent))
          (unpackaged/org-element-descendant-of type parent))))
  
  <span class="comment-delimiter">;;;</span><span class="comment">###autoload
</span>  (<span class="keyword">defun</span> <span class="function-name">unpackaged/org-return-dwim</span> (<span class="type">&amp;optional</span> default)
    <span class="doc">"A helpful replacement for `</span><span class="doc"><span class="constant">org-return-indent</span></span><span class="doc">'.  With prefix, call `</span><span class="doc"><span class="constant">org-return-indent</span></span><span class="doc">'.
  
  On headings, move point to position after entry content.  In
  lists, insert a new item or end the list, with checkbox if
  appropriate.  In tables, insert a new row or end the table."</span>
    <span class="comment-delimiter">;; </span><span class="comment">Inspired by John Kitchin: http://kitchingroup.cheme.cmu.edu/blog/2017/04/09/A-better-return-in-org-mode/
</span>    (<span class="keyword">interactive</span> <span class="string">"P"</span>)
    (<span class="keyword">if</span> default
        (org-return t)
      (<span class="keyword">cond</span>
       <span class="comment-delimiter">;; </span><span class="comment">Act depending on context around point.
</span>  
       <span class="comment-delimiter">;; </span><span class="bold"><span class="success">NOTE:</span></span><span class="comment"> I prefer RET to not follow links, but by uncommenting this block, links will be
</span>       <span class="comment-delimiter">;; </span><span class="comment">followed.
</span>  
       <span class="comment-delimiter">;; </span><span class="comment">((eq 'link (car (org-element-context)))
</span>       <span class="comment-delimiter">;;  </span><span class="comment">;; Link: Open it.
</span>       <span class="comment-delimiter">;;  </span><span class="comment">(org-open-at-point-global))
</span>  
       ((org-at-heading-p)
        <span class="comment-delimiter">;; </span><span class="comment">Heading: Move to position after entry content.
</span>        <span class="comment-delimiter">;; </span><span class="bold"><span class="success">NOTE:</span></span><span class="comment"> This is probably the most interesting feature of this function.
</span>        (<span class="keyword">let</span> ((heading-start (org-entry-beginning-position)))
          (goto-char (org-entry-end-position))
          (<span class="keyword">cond</span> ((<span class="keyword">and</span> (org-at-heading-p)
                      (= heading-start (org-entry-beginning-position)))
                 <span class="comment-delimiter">;; </span><span class="comment">Entry ends on its heading; add newline after
</span>                 (end-of-line)
                 (insert <span class="string">"\n\n"</span>))
                (t
                 <span class="comment-delimiter">;; </span><span class="comment">Entry ends after its heading; back up
</span>                 (forward-line <span class="highlight-numbers-number">-1</span>)
                 (end-of-line)
                 (<span class="keyword">when</span> (org-at-heading-p)
                   <span class="comment-delimiter">;; </span><span class="comment">At the same heading
</span>                   (forward-line)
                   (insert <span class="string">"\n"</span>)
                   (forward-line <span class="highlight-numbers-number">-1</span>))
                 <span class="comment-delimiter">;; </span><span class="bold"><span class="error">FIXME:</span></span><span class="comment"> looking-back is supposed to be called with more arguments.
</span>                 (<span class="keyword">while</span> (not (looking-back (<span class="keyword">rx</span> (repeat <span class="highlight-numbers-number">3</span> (seq (optional blank) <span class="string">"\n"</span>)))))
                   (insert <span class="string">"\n"</span>))
                 (forward-line <span class="highlight-numbers-number">-1</span>)))))
  
       ((org-at-item-checkbox-p)
        <span class="comment-delimiter">;; </span><span class="comment">Checkbox: Insert new item with checkbox.
</span>        (org-insert-todo-heading nil))
  
       ((org-in-item-p)
        <span class="comment-delimiter">;; </span><span class="comment">Plain list.  Yes, this gets a little complicated...
</span>        (<span class="keyword">let</span> ((context (org-element-context)))
          (<span class="keyword">if</span> (<span class="keyword">or</span> (eq 'plain-list (car context))  <span class="comment-delimiter">; </span><span class="comment">First item in list
</span>                  (<span class="keyword">and</span> (eq 'item (car context))
                       (not (eq (org-element-property <span class="builtin">:contents-begin</span> context)
                                (org-element-property <span class="builtin">:contents-end</span> context))))
                  (unpackaged/org-element-descendant-of 'item context))  <span class="comment-delimiter">; </span><span class="comment">Element in list item, e.g. a link
</span>              <span class="comment-delimiter">;; </span><span class="comment">Non-empty item: Add new item.
</span>              (org-insert-item)
            <span class="comment-delimiter">;; </span><span class="comment">Empty item: Close the list.
</span>            <span class="comment-delimiter">;; </span><span class="bold"><span class="warning">TODO:</span></span><span class="comment"> Do this with org functions rather than operating on the text. Can't seem to find the right function.
</span>            (delete-region (line-beginning-position) (line-end-position))
            (insert <span class="string">"\n"</span>))))
  
       ((<span class="keyword">when</span> (fboundp 'org-inlinetask-in-task-p)
          (org-inlinetask-in-task-p))
        <span class="comment-delimiter">;; </span><span class="comment">Inline task: Don't insert a new heading.
</span>        (org-return t))
  
       ((org-at-table-p)
        (<span class="keyword">cond</span> ((<span class="keyword">save-excursion</span>
                 (beginning-of-line)
                 <span class="comment-delimiter">;; </span><span class="comment">See `</span><span class="comment"><span class="constant">org-table-next-field</span></span><span class="comment">'.
</span>                 (<span class="keyword">cl-loop</span> with end = (line-end-position)
                          for cell = (org-element-table-cell-parser)
                          always (equal (org-element-property <span class="builtin">:contents-begin</span> cell)
                                        (org-element-property <span class="builtin">:contents-end</span> cell))
                          while (re-search-forward <span class="string">"|"</span> end t)))
               <span class="comment-delimiter">;; </span><span class="comment">Empty row: end the table.
</span>               (delete-region (line-beginning-position) (line-end-position))
               (org-return t))
              (t
               <span class="comment-delimiter">;; </span><span class="comment">Non-empty row: call `</span><span class="comment"><span class="constant">org-return-indent</span></span><span class="comment">'.
</span>               (org-return t))))
       (t
        <span class="comment-delimiter">;; </span><span class="comment">All other cases: call `</span><span class="comment"><span class="constant">org-return-indent</span></span><span class="comment">'.
</span>        (org-return t)))))
  
  (<span class="keyword">map!</span>
   <span class="builtin">:after</span> evil-org
   <span class="builtin">:map</span> evil-org-mode-map
   <span class="builtin">:i</span> [return] #'unpackaged/org-return-dwim)
  (<span class="keyword">defun</span> <span class="function-name">+yas/org-src-header-p</span> ()
    <span class="doc">"Determine whether `</span><span class="doc"><span class="constant">point</span></span><span class="doc">' is within a src-block header or header-args."</span>
    (<span class="keyword">pcase</span> (org-element-type (org-element-context))
      ('src-block (&lt; (point) <span class="comment-delimiter">; </span><span class="comment">before code part of the src-block
</span>                     (<span class="keyword">save-excursion</span> (goto-char (org-element-property <span class="builtin">:begin</span> (org-element-context)))
                                     (forward-line <span class="highlight-numbers-number">1</span>)
                                     (point))))
      ('inline-src-block (&lt; (point) <span class="comment-delimiter">; </span><span class="comment">before code part of the inline-src-block
</span>                            (<span class="keyword">save-excursion</span> (goto-char (org-element-property <span class="builtin">:begin</span> (org-element-context)))
                                            (search-forward <span class="string">"]{"</span>)
                                            (point))))
      ('keyword (string-match-p <span class="string">"^header-args"</span> (org-element-property <span class="builtin">:value</span> (org-element-context))))))
  (<span class="keyword">defun</span> <span class="function-name">+yas/org-prompt-header-arg</span> (arg question values)
    <span class="doc">"Prompt the user to set ARG header property to one of VALUES with QUESTION.
  The default value is identified and indicated. If either default is selected,
  or no selection is made: nil is returned."</span>
    (<span class="keyword">let*</span> ((src-block-p (not (looking-back <span class="string">"^#\\+property:[ \t]+header-args:.*"</span> (line-beginning-position))))
           (default
             (<span class="keyword">or</span>
              (cdr (assoc arg
                          (<span class="keyword">if</span> src-block-p
                              (nth <span class="highlight-numbers-number">2</span> (org-babel-get-src-block-info t))
                            (org-babel-merge-params
                             org-babel-default-header-args
                             (<span class="keyword">let</span> ((lang-headers
                                    (intern (concat <span class="string">"org-babel-default-header-args:"</span>
                                                    (+yas/org-src-lang)))))
                               (<span class="keyword">when</span> (boundp lang-headers) (eval lang-headers t)))))))
              <span class="string">""</span>))
           default-value)
      (<span class="keyword">setq</span> values (mapcar
                    (<span class="keyword">lambda</span> (value)
                      (<span class="keyword">if</span> ((string-match-p (regexp-quote value) default))
                          (<span class="keyword">setq</span> default-value
                                (concat value <span class="string">" "</span>
                                        (propertize <span class="string">"(default)"</span> 'face 'font-lock-doc-face)))
                        value))
                    values))
      (<span class="keyword">let</span> ((selection (ivy-read question values <span class="builtin">:preselect</span> default-value)))
        (<span class="keyword">unless</span> ((string-match-p <span class="string">"(default)$"</span> selection)
                 (string= <span class="string">""</span> selection))
          selection))))
  (<span class="keyword">defun</span> <span class="function-name">+yas/org-src-lang</span> ()
    <span class="doc">"Try to find the current language of the src/header at `</span><span class="doc"><span class="constant">point</span></span><span class="doc">'.
  Return nil otherwise."</span>
    (<span class="keyword">let</span> ((context (org-element-context)))
      (<span class="keyword">pcase</span> (org-element-type context)
        ('src-block (org-element-property <span class="builtin">:language</span> context))
        ('inline-src-block (org-element-property <span class="builtin">:language</span> context))
        ('keyword (<span class="keyword">when</span> (string-match <span class="string">"^header-args:</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[</span><span class="string"><span class="negation-char">^</span></span><span class="string"> ]+</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">"</span> (org-element-property <span class="builtin">:value</span> context))
                    (match-string <span class="highlight-numbers-number">1</span> (org-element-property <span class="builtin">:value</span> context)))))))
  
  (<span class="keyword">defun</span> <span class="function-name">+yas/org-last-src-lang</span> ()
    <span class="doc">"Return the language of the last src-block, if it exists."</span>
    (<span class="keyword">save-excursion</span>
      (beginning-of-line)
      (<span class="keyword">when</span> (re-search-backward <span class="string">"^[   ]*#\\+begin_src"</span> nil t)
        (org-element-property <span class="builtin">:language</span> (org-element-context)))))
  
  (<span class="keyword">defun</span> <span class="function-name">+yas/org-most-common-no-property-lang</span> ()
    <span class="doc">"Find the lang with the most source blocks that has no global header-args, else nil."</span>
    (<span class="keyword">let</span> (src-langs header-langs)
      (<span class="keyword">save-excursion</span>
        (goto-char (point-min))
        (<span class="keyword">while</span> (re-search-forward <span class="string">"^[   ]*#\\+begin_src"</span> nil t)
          (<span class="keyword">push</span> (+yas/org-src-lang) src-langs))
        (goto-char (point-min))
        (<span class="keyword">while</span> (re-search-forward <span class="string">"^[   ]*#\\+property: +header-args"</span> nil t)
          (<span class="keyword">push</span> (+yas/org-src-lang) header-langs)))
  
      (<span class="keyword">setq</span> src-langs
            (mapcar #'car
                    <span class="comment-delimiter">;; </span><span class="comment">sort alist by frequency (desc.)
</span>                    (sort
                     <span class="comment-delimiter">;; </span><span class="comment">generate alist with form (value . frequency)
</span>                     (<span class="keyword">cl-loop</span> for (n . m) in (seq-group-by #'identity src-langs)
                              collect (cons n (length m)))
                     (<span class="keyword">lambda</span> (a b) (&gt; (cdr a) (cdr b))))))
  
      (car (cl-set-difference src-langs header-langs <span class="builtin">:test</span> #'string=))))
  (<span class="keyword">defun</span> <span class="function-name">org-syntax-convert-case-to-lower</span> ()
    <span class="doc">"Convert all #+KEYWORDS to #+keywords."</span>
    (<span class="keyword">interactive</span>)
    (<span class="keyword">save-excursion</span>
      (goto-char (point-min))
      (<span class="keyword">let</span> ((count <span class="highlight-numbers-number">0</span>)
            (case-fold-search nil))
        (<span class="keyword">while</span> (re-search-forward <span class="string">"#\\+[A-Z_]+"</span> nil t)
          (replace-match (downcase (match-string <span class="highlight-numbers-number">0</span>)) t)
          (<span class="keyword">setq</span> count (1+ count)))
        (message <span class="string">"Replaced %d occurances"</span> count))))
  (org-link-set-parameters <span class="string">"xkcd"</span>
                           <span class="builtin">:image-data-fun</span> #'+org-xkcd-image-fn
                           <span class="builtin">:follow</span> #'+org-xkcd-open-fn
                           <span class="builtin">:export</span> #'+org-xkcd-export
                           <span class="builtin">:complete</span> #'+org-xkcd-complete)
  
  (<span class="keyword">defun</span> <span class="function-name">+org-xkcd-open-fn</span> (link)
    (+org-xkcd-image-fn nil link nil))
  
  (<span class="keyword">defun</span> <span class="function-name">+org-xkcd-image-fn</span> (protocol link description)
    <span class="doc">"Get image data for xkcd num LINK"</span>
    (<span class="keyword">let*</span> ((xkcd-info (+xkcd-fetch-info (string-to-number link)))
           (img (plist-get xkcd-info <span class="builtin">:img</span>))
           (alt (plist-get xkcd-info <span class="builtin">:alt</span>)))
      (message alt)
      (+org-image-file-data-fn protocol (xkcd-download img (string-to-number link)) description)))
  
  (<span class="keyword">defun</span> <span class="function-name">+org-xkcd-export</span> (num desc backend _com)
    <span class="doc">"Convert xkcd to html/LaTeX form"</span>
    (<span class="keyword">let*</span> ((xkcd-info (+xkcd-fetch-info (string-to-number num)))
           (img (plist-get xkcd-info <span class="builtin">:img</span>))
           (alt (plist-get xkcd-info <span class="builtin">:alt</span>))
           (title (plist-get xkcd-info <span class="builtin">:title</span>))
           (file (xkcd-download img (string-to-number num))))
      (<span class="keyword">cond</span> ((org-export-derived-backend-p backend 'html)
             (format <span class="string">"&lt;img class='invertible' src='%s' title=\"%s\" alt='%s'&gt;"</span> img (subst-char-in-string ?\" ?&#226;&#128;&#156; alt) title))
            ((org-export-derived-backend-p backend 'latex)
             (format <span class="string">"\\begin{figure}[!htb]
    \\centering
    \\includegraphics[scale=0.4]{%s}%s
  \\end{figure}"</span> file (<span class="keyword">if</span> (equal desc (format <span class="string">"xkcd:%s"</span> num)) <span class="string">""</span>
                        (format <span class="string">"\n  \\caption*{\\label{xkcd:%s} %s}"</span>
                                num
                                (<span class="keyword">or</span> desc
                                    (format <span class="string">"\\textbf{%s} %s"</span> title alt))))))
            (t (format <span class="string">"https://xkcd.com/%s"</span> num)))))
  
  (<span class="keyword">defun</span> <span class="function-name">+org-xkcd-complete</span> (<span class="type">&amp;optional</span> arg)
    <span class="doc">"Complete xkcd using `</span><span class="doc"><span class="constant">+xkcd-stored-info</span></span><span class="doc">'"</span>
    (format <span class="string">"xkcd:%d"</span> (+xkcd-select)))
  (<span class="keyword">after!</span> org
    (<span class="keyword">defvar</span> <span class="variable-name">org-music-player</span> 'mpris
      <span class="doc">"Music player type. Curretly only supports mpris."</span>)
    (<span class="keyword">defvar</span> <span class="variable-name">org-music-mpris-player</span> <span class="string">"Lollypop"</span>
      <span class="doc">"Name of the mpris player, used in the form org.gnome.MPRIS."</span>)
    (<span class="keyword">defvar</span> <span class="variable-name">org-music-track-search-method</span> 'beets
      <span class="doc">"Method to find the track file from the link."</span>)
    (<span class="keyword">defvar</span> <span class="variable-name">org-music-beets-db</span> <span class="string">"~/Music/library.db"</span>
      <span class="doc">"Location of the beets DB, for when using beets as the `</span><span class="doc"><span class="constant">org-music-track-search-method</span></span><span class="doc">'"</span>)
    (<span class="keyword">defvar</span> <span class="variable-name">org-music-folder</span> <span class="string">"~/Music/"</span>
      <span class="doc">"Location of your music folder, for when using file as the `</span><span class="doc"><span class="constant">org-music-track-search-method</span></span><span class="doc">'"</span>)
    (<span class="keyword">defvar</span> <span class="variable-name">org-music-recognised-extensions</span> '(<span class="string">"flac"</span> <span class="string">"mp4"</span> <span class="string">"m4a"</span> <span class="string">"aiff"</span> <span class="string">"wav"</span> <span class="string">"ogg"</span> <span class="string">"aiff"</span>)
      <span class="doc">"When searching for files in `</span><span class="doc"><span class="constant">org-music-track-search-method</span></span><span class="doc">', recognise these extensions as audio files."</span>)
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-get-link</span> (full <span class="type">&amp;optional</span> include-time)
      <span class="doc">"Generate link string for currently playing track, optionally including a time-stamp"</span>
      (<span class="keyword">pcase</span> org-music-player <span class="comment-delimiter">;; </span><span class="bold"><span class="success">NOTE</span></span><span class="comment"> this could do with better generalisation
</span>        ('mpris (<span class="keyword">let*</span> ((track-metadata
                        (org-music-mpris-get-property <span class="string">"Metadata"</span>))
                       (album-artist (caar (cadr (assoc <span class="string">"xesam:albumArtist"</span> track-metadata))))
                       (artist (<span class="keyword">if</span> (<span class="keyword">or</span> (equal album-artist <span class="string">""</span>)
                                       (s-contains-p <span class="string">"various"</span> album-artist t))
                                   (caar (cadr (assoc <span class="string">"xesam:artist"</span> track-metadata)))
                                 album-artist))
                       (track (car (cadr (assoc <span class="string">"xesam:title"</span> track-metadata))))
                       (start-time (<span class="keyword">when</span> include-time
                                     (/ (org-music-mpris-get-property <span class="string">"Position"</span>) <span class="highlight-numbers-number">1000000</span>))))
                  (<span class="keyword">if</span> full
                      (format <span class="string">"[[music:%s][%s by %s]]"</span> (org-music-format-link artist track start-time) track artist)
                    (org-music-format-link artist track start-time))))
        (_ (<span class="keyword">user-error!</span> <span class="string">"The specified music player: %s is not supported"</span> org-music-player))))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-format-link</span> (artist track <span class="type">&amp;optional</span> start-time end-time)
      (<span class="keyword">let</span> ((artist (replace-regexp-in-string <span class="string">":"</span> <span class="string">"\\:"</span> artist))
            (track (replace-regexp-in-string <span class="string">":"</span> <span class="string">"\\:"</span> track)))
        (concat artist <span class="string">":"</span> track
                (<span class="keyword">cond</span> ((<span class="keyword">and</span> start-time end-time)
                       (format <span class="string">"::%s-%s"</span>
                               (org-music-seconds-to-time start-time)
                               (org-music-seconds-to-time end-time)))
                      (start-time
                       (format <span class="string">"::%s"</span>
                               (org-music-seconds-to-time start-time)))))))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-parse-link</span> (link)
      (<span class="keyword">let*</span> ((link-dc (<span class="keyword">-&gt;&gt;</span> link
                           (replace-regexp-in-string <span class="string">"</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[</span><span class="string"><span class="negation-char">^</span></span><span class="string">\\\\]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">\\\\:"</span> <span class="string">"\\1#COLON#"</span>)
                           (replace-regexp-in-string <span class="string">"</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">::[a-z0-9]*[0-9]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">\\'"</span> <span class="string">"\\1s"</span>)))
             (link-components (mapcar (<span class="keyword">lambda</span> (lc) (replace-regexp-in-string <span class="string">"#COLON#"</span> <span class="string">":"</span> lc))
                                      (s-split <span class="string">":"</span> link-dc)))
             (artist (nth <span class="highlight-numbers-number">0</span> link-components))
             (track (nth <span class="highlight-numbers-number">1</span> link-components))
             (durations (<span class="keyword">when</span> (<span class="keyword">and</span> (&gt; (length link-components) <span class="highlight-numbers-number">3</span>)
                                   (equal (nth <span class="highlight-numbers-number">2</span> link-components) <span class="string">""</span>))
                          (s-split <span class="string">"-"</span> (nth <span class="highlight-numbers-number">3</span> link-components))))
             (start-time (<span class="keyword">when</span> durations
                           (org-music-time-to-seconds (car durations))))
             (end-time (<span class="keyword">when</span> (cdr durations)
                         (org-music-time-to-seconds (cadr durations)))))
        (list artist track start-time end-time)))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-seconds-to-time</span> (seconds)
      <span class="doc">"Convert a number of seconds to a nice human duration, e.g. 5m21s.
  This action is reversed by `</span><span class="doc"><span class="constant">org-music-time-to-seconds</span></span><span class="doc">'."</span>
      (<span class="keyword">if</span> (&lt; seconds <span class="highlight-numbers-number">60</span>)
          (format <span class="string">"%ss"</span> seconds)
        (<span class="keyword">if</span> (&lt; seconds <span class="highlight-numbers-number">3600</span>)
            (format <span class="string">"%sm%ss"</span> (/ seconds <span class="highlight-numbers-number">60</span>) (% seconds <span class="highlight-numbers-number">60</span>))
          (format <span class="string">"%sh%sm%ss"</span> (/ seconds <span class="highlight-numbers-number">3600</span>) (/ (% seconds <span class="highlight-numbers-number">3600</span>) <span class="highlight-numbers-number">60</span>) (% seconds <span class="highlight-numbers-number">60</span>)))))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-time-to-seconds</span> (time-str)
      <span class="doc">"Get the number of seconds in a string produced by `</span><span class="doc"><span class="constant">org-music-seconds-to-time</span></span><span class="doc">'."</span>
      (<span class="keyword">let*</span> ((time-components (reverse (s-split <span class="string">"[a-z]"</span> time-str)))
             (seconds (string-to-number (nth <span class="highlight-numbers-number">1</span> time-components)))
             (minutes (<span class="keyword">when</span> (&gt; (length time-components) <span class="highlight-numbers-number">2</span>)
                        (string-to-number (nth <span class="highlight-numbers-number">2</span> time-components))))
             (hours (<span class="keyword">when</span> (&gt; (length time-components) <span class="highlight-numbers-number">3</span>)
                      (string-to-number (nth <span class="highlight-numbers-number">3</span> time-components)))))
        (+ (* <span class="highlight-numbers-number">3600</span> (<span class="keyword">or</span> hours <span class="highlight-numbers-number">0</span>)) (* <span class="highlight-numbers-number">60</span> (<span class="keyword">or</span> minutes <span class="highlight-numbers-number">0</span>)) seconds)))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-play-track</span> (artist title <span class="type">&amp;optional</span> start-time end-time)
      <span class="doc">"Play the track specified by ARTIST and TITLE, optionally skipping to START-TIME in, stopping at END-TIME."</span>
      (<span class="keyword">if-let</span> ((file (org-music-find-track-file artist title)))
          (<span class="keyword">pcase</span> org-music-player
            ('mpris (org-music-mpris-play file start-time end-time))
            (_ (<span class="keyword">user-error!</span> <span class="string">"The specified music player: %s is not supported"</span> org-music-player)))
        (<span class="keyword">user-error!</span> <span class="string">"Could not find the track '%s' by '%s'"</span> title artist)))
  
    (<span class="keyword">add-transient-hook!</span> #'org-music-play-track
      (<span class="keyword">require</span> '<span class="constant">dbus</span>))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-mpris-play</span> (file <span class="type">&amp;optional</span> start-time end-time)
      (<span class="keyword">let</span> ((uri (url-encode-url (rng-file-name-uri file))))
        (org-music-mpris-call-method <span class="string">"OpenUri"</span> uri)
        (<span class="keyword">let</span> ((track-id (caadr (assoc <span class="string">"mpris:trackid"</span>
                                      (org-music-mpris-get-property <span class="string">"Metadata"</span>)))))
          (<span class="keyword">when</span> start-time
            (org-music-mpris-call-method <span class="string">"SetPosition"</span> <span class="builtin">:object-path</span> track-id
                                         <span class="builtin">:int64</span> (round (* start-time <span class="highlight-numbers-number">1000000</span>))))
          (<span class="keyword">when</span> end-time
            (org-music-mpris-stop-at-time uri end-time)))))
  
    (<span class="keyword">defun</span> <span class="function-name">orgb3-music-mpris-stop-at-time</span> (url end-time)
      <span class="doc">"Check that url is playing, and if it is stop it at END-TIME."</span>
      (<span class="keyword">when</span> (equal url (caadr (assoc <span class="string">"xesam:url"</span> (org-music-mpris-get-property <span class="string">"Metadata"</span>))))
        (<span class="keyword">let*</span> ((time-current (/ (/ (org-music-mpris-get-property <span class="string">"Position"</span>) <span class="highlight-numbers-number">10000</span>) <span class="highlight-numbers-number">100.0</span>))
               (time-delta (- end-time time-current)))
          (message <span class="string">"%s"</span> time-delta)
          (<span class="keyword">if</span> (&lt; time-delta <span class="highlight-numbers-number">0</span>)
              (org-music-mpris-call-method <span class="string">"Pause"</span>)
            (<span class="keyword">if</span> (&lt; time-delta <span class="highlight-numbers-number">6</span>)
                (run-at-time (max <span class="highlight-numbers-number">0.001</span> (* <span class="highlight-numbers-number">0.9</span> time-delta)) nil #'org-music-mpris-stop-at-time url end-time)
              (run-at-time <span class="highlight-numbers-number">5</span> nil #'org-music-mpris-stop-at-time url end-time))))))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-mpris-get-property</span> (property)
      <span class="doc">"Return the value of org.mpris.MediaPlayer2.Player.PROPERTY."</span>
      (dbus-get-property <span class="builtin">:session</span> (concat <span class="string">"org.gnome."</span> org-music-mpris-player)
                         <span class="string">"/org/mpris/MediaPlayer2"</span> <span class="string">"org.mpris.MediaPlayer2.Player"</span>
                         property))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-mpris-call-method</span> (property <span class="type">&amp;rest</span> args)
      <span class="doc">"Call org.mpris.MediaPlayer2.Player.PROPERTY with ARGS, returning the result."</span>
      (apply #'dbus-call-method <span class="builtin">:session</span> (concat <span class="string">"org.gnome."</span> org-music-mpris-player)
             <span class="string">"/org/mpris/MediaPlayer2"</span> <span class="string">"org.mpris.MediaPlayer2.Player"</span>
             property args))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-guess-mpris-player</span> ()
      (<span class="keyword">when-let</span> ((players
                  (-filter (<span class="keyword">lambda</span> (interface)
                             (s-contains-p <span class="string">"org.mpris.MediaPlayer2"</span> interface))
                           (dbus-call-method <span class="builtin">:session</span>
                                             dbus-service-dbus
                                             dbus-path-dbus
                                             dbus-interface-dbus
                                             <span class="string">"ListNames"</span>))))
        (replace-regexp-in-string <span class="string">"org\\.mpris\\.MediaPlayer2\\."</span> <span class="string">""</span> (car players))))
  
    (<span class="keyword">when</span> (eq org-music-player 'mpris)
      (<span class="keyword">unless</span> org-music-mpris-player
        (<span class="keyword">setq</span> org-music-mpris-player (org-music-guess-mpris-player))))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-find-track-file</span> (artist title)
      <span class="doc">"Try to find the file for TRACK by ARTIST, using `</span><span class="doc"><span class="constant">org-music-track-search-method</span></span><span class="doc">', returning nil if nothing could be found."</span>
      (<span class="keyword">pcase</span> org-music-track-search-method
        ('file (org-music-find-file artist title))
        ('beets (org-music-beets-find-file artist title))
        (_ (<span class="keyword">user-error!</span> <span class="string">"The specified music search method: %s is not supported"</span> org-music-track-search-method))))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-beets-find-file</span> (artist title)
      <span class="doc">"Find the file correspanding to a given artist and title."</span>
      (<span class="keyword">let*</span> ((artist-escaped (replace-regexp-in-string <span class="string">"\""</span> <span class="string">"\\\""</span> artist))
             (title-escaped (replace-regexp-in-string <span class="string">"\""</span> <span class="string">"\\\""</span> title))
             (file
              (<span class="keyword">or</span>
               (shell-command-to-string
                (format
                 <span class="string">"sqlite3 '%s' \"SELECT path FROM items WHERE albumartist IS '%s' AND title IS '%s' LIMIT 1 COLLATE NOCASE\""</span>
                 (expand-file-name org-music-beets-db) artist-escaped title-escaped))
               (shell-command-to-string
                (format
                 <span class="string">"sqlite3 '%s' \"SELECT path FROM items WHERE artist IS '%s' AND title IS '%s' LIMIT 1 COLLATE NOCASE\""</span>
                 (expand-file-name org-music-beets-db) artist-escaped title-escaped)))))
        (<span class="keyword">if</span> (&gt; (length file) <span class="highlight-numbers-number">0</span>)
            (substring file <span class="highlight-numbers-number">0</span> <span class="highlight-numbers-number">-1</span>)
          )))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-find-file</span> (artist title)
      <span class="doc">"Try to find a file in `</span><span class="doc"><span class="constant">org-music-folder</span></span><span class="doc">' which contains TITLE, looking first in ./ARTIST if possible."</span>
      (<span class="keyword">when-let*</span> ((music-folder (expand-file-name org-music-folder))
                  (search-folders (<span class="keyword">or</span>
                                   (-filter <span class="comment-delimiter">; </span><span class="comment">look for folders which contain ARTIST
</span>                                    (<span class="keyword">lambda</span> (file-or-folder)
                                      (<span class="keyword">and</span>
                                       (s-contains-p artist (file-name-base file-or-folder) t)
                                       (file-directory-p file-or-folder)))
                                    (directory-files music-folder t))
                                   (list music-folder)))
                  (extension-regex (format <span class="string">"\\.</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(?:</span></span><span class="string">%s</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">\\'"</span> (s-join <span class="string">"</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">|</span></span><span class="string">"</span> org-music-recognised-extensions)))
                  (tracks (-filter
                           (<span class="keyword">lambda</span> (file)
                             (s-contains-p title (file-name-base file) t))
                           (-flatten (mapcar (<span class="keyword">lambda</span> (dir)
                                               (directory-files-recursively dir extension-regex))
                                             search-folders)))))
        (<span class="keyword">when</span> (&gt; (length tracks) <span class="highlight-numbers-number">1</span>)
          (message <span class="string">"Warning: multiple matches for %s by %s found"</span> title artist))
        (car tracks))))
  (<span class="keyword">after!</span> org
    (org-link-set-parameters <span class="string">"music"</span>
                             <span class="builtin">:follow</span> #'org-music-open-fn
                             <span class="builtin">:export</span> #'org-music-export-text)
  
    (org-link-set-parameters <span class="string">"Music"</span> <span class="comment-delimiter">;; </span><span class="comment">like music, but visually fancier
</span>                             <span class="comment-delimiter">;; </span><span class="bold"><span class="error">FIXME</span></span><span class="comment"> this should work as far as I can tell
</span>                             <span class="comment-delimiter">;; </span><span class="comment">:image-data-fun #'org-music-image-fn
</span>                             <span class="builtin">:follow</span> #'org-music-open-fn
                             <span class="builtin">:export</span> #'org-music-fancy-export)
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-open-fn</span> (link)
      (apply #'org-music-play-track (org-music-parse-link link)))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-insert-current-track</span> (<span class="type">&amp;optional</span> include-time)
      <span class="doc">"Insert link to currest track, including a timestamp when the universal argument is supplied."</span>
      (<span class="keyword">interactive</span> <span class="string">"P"</span>)
      (pp include-time)
      (insert (org-music-get-link t include-time)))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-export-text</span> (path desc backend _com <span class="type">&amp;optional</span> newline)
      (<span class="keyword">let*</span> ((track-info (org-music-parse-link path))
             (artist (nth <span class="highlight-numbers-number">0</span> track-info))
             (track (nth <span class="highlight-numbers-number">1</span> track-info))
             (start-time (nth <span class="highlight-numbers-number">2</span> track-info))
             (end-time (nth <span class="highlight-numbers-number">3</span> track-info))
             (emphasise (<span class="keyword">cond</span> ((org-export-derived-backend-p backend 'html)
                               (<span class="keyword">lambda</span> (s) (format <span class="string">"&lt;span style=\"font-style: italic\"&gt;%s&lt;/span&gt;"</span> s)))
                              ((org-export-derived-backend-p backend 'latex)
                               (<span class="keyword">lambda</span> (s) (format <span class="string">"\\emph{%s}"</span> s)))
                              (t (<span class="keyword">lambda</span> (s) s)))))
        (<span class="keyword">or</span> desc
            (concat
             (<span class="keyword">cond</span> ((<span class="keyword">and</span> start-time end-time)
                    (format <span class="string">"%s to %s seconds of%s"</span> start-time end-time (<span class="keyword">or</span> newline <span class="string">" "</span>)))
                   (start-time
                    (format <span class="string">"%s seconds into%s"</span> start-time (<span class="keyword">or</span> newline <span class="string">" "</span>))))
             (funcall emphasise track)
             (<span class="keyword">or</span> newline <span class="string">" "</span>)
             <span class="string">"by "</span>
             artist))))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-cover-image</span> (track-file)
      <span class="doc">"Try to find a cover image for the track in the given location"</span>
      (car (-filter (<span class="keyword">lambda</span> (file)
                      (-contains-p '(<span class="string">"png"</span> <span class="string">"jpg"</span> <span class="string">"jpeg"</span>) (file-name-extension file)))
                    (directory-files (file-name-directory track-file) t <span class="string">"cover"</span>))))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-image-fn</span> (_protocol link _description)
      (<span class="keyword">when-let*</span> ((track-data (org-music-parse-link link))
                  (cover-file (org-music-cover-image
                               (org-music-find-track-file
                                (nth <span class="highlight-numbers-number">0</span> track-data) (nth <span class="highlight-numbers-number">1</span> track-data)))))
        (<span class="keyword">with-temp-buffer</span>
          (set-buffer-multibyte nil)
          (<span class="keyword">setq</span> buffer-file-coding-system 'binary)
          (insert-file-contents-literally cover-file)
          (buffer-substring-no-properties (point-min) (point-max)))))
  
    (<span class="keyword">defun</span> <span class="function-name">org-music-fancy-export</span> (path desc backend _com)
      (<span class="keyword">let*</span> ((track-data (org-music-parse-link path))
             (file (org-music-find-track-file
                    (nth <span class="highlight-numbers-number">0</span> track-data) (nth <span class="highlight-numbers-number">1</span> track-data)))
             (cover-img (org-music-cover-image file))
             (newline-str (<span class="keyword">cond</span> ((org-export-derived-backend-p backend 'html) <span class="string">"&lt;br&gt;"</span>)
                                ((org-export-derived-backend-p backend 'latex) <span class="string">"\\newline "</span>)
                                (t <span class="string">" "</span>)))
             (text (org-music-export-text path nil backend nil newline-str)))
        (<span class="keyword">cond</span> ((org-export-derived-backend-p backend 'html)
               (format <span class="string">"&lt;div class='music-track'&gt;
      &lt;img src='%s'&gt; &lt;span&gt;%s&lt;/span&gt;
  &lt;/div&gt;"</span> cover-img text)
               )
              ((org-export-derived-backend-p backend 'latex)
               (format <span class="string">"\\begin{tabular}{@{\\hspace{0.3\\columnwidth}}r@{\\hspace{0.1\\columnwidth}}p{0.4\\columnwidth}}
    \\includegraphics[height=6em]{%s} &amp; \\vspace{-0.12\\columnwidth}%s
  \\end{tabular}"</span> cover-img text))
              (t text)))))
  (org-link-set-parameters <span class="string">"yt"</span> <span class="builtin">:export</span> #'+org-export-yt)
  (<span class="keyword">defun</span> <span class="function-name">+org-export-yt</span> (path desc backend _com)
    (<span class="keyword">cond</span> ((org-export-derived-backend-p backend 'html)
           (format <span class="string">"&lt;iframe width='440' \
  height='335' \
  src='https://www.youtube.com/embed/%s' \
  frameborder='0' \
  allowfullscreen&gt;%s&lt;/iframe&gt;"</span> path (<span class="keyword">or</span> <span class="string">""</span> desc)))
          ((org-export-derived-backend-p backend 'latex)
           (format <span class="string">"\\href{https://youtu.be/%s}{%s}"</span> path (<span class="keyword">or</span> desc <span class="string">"youtube"</span>)))
          (t (format <span class="string">"https://youtu.be/%s"</span> path))))
  (<span class="keyword">add-hook!</span> 'org-mode-hook #'+org-pretty-mode #'mixed-pitch-mode)
  (<span class="keyword">setq</span> global-org-pretty-table-mode t)
  (<span class="keyword">custom-set-faces!</span>
    '(outline-1 <span class="builtin">:weight</span> extra-bold <span class="builtin">:height</span> <span class="highlight-numbers-number">1.25</span>)
    '(outline-2 <span class="builtin">:weight</span> bold <span class="builtin">:height</span> <span class="highlight-numbers-number">1.15</span>)
    '(outline-3 <span class="builtin">:weight</span> bold <span class="builtin">:height</span> <span class="highlight-numbers-number">1.12</span>)
    '(outline-4 <span class="builtin">:weight</span> semi-bold <span class="builtin">:height</span> <span class="highlight-numbers-number">1.09</span>)
    '(outline-5 <span class="builtin">:weight</span> semi-bold <span class="builtin">:height</span> <span class="highlight-numbers-number">1.06</span>)
    '(outline-6 <span class="builtin">:weight</span> semi-bold <span class="builtin">:height</span> <span class="highlight-numbers-number">1.03</span>)
    '(outline-8 <span class="builtin">:weight</span> semi-bold)
    '(outline-9 <span class="builtin">:weight</span> semi-bold))
  (<span class="keyword">custom-set-faces!</span>
    '(org-document-title <span class="builtin">:height</span> <span class="highlight-numbers-number">1.2</span>))
  (<span class="keyword">setq</span> org-agenda-deadline-faces
        '((<span class="highlight-numbers-number">1.001</span> . error)
          (<span class="highlight-numbers-number">1.0</span> . org-warning)
          (<span class="highlight-numbers-number">0.5</span> . org-upcoming-deadline)
          (<span class="highlight-numbers-number">0.0</span> . org-upcoming-distant-deadline)))
  (<span class="keyword">setq</span> org-fontify-quote-and-verse-blocks t)
  (<span class="keyword">use-package!</span> org-appear
    <span class="builtin">:hook</span> (org-mode . org-appear-mode)
    <span class="builtin">:config</span>
    (<span class="keyword">setq</span> org-appear-autoemphasis t
          org-appear-autosubmarkers t
          org-appear-autolinks nil)
    <span class="comment-delimiter">;; </span><span class="comment">for proper first-time setup, `</span><span class="comment"><span class="constant">org-appear--set-fragments</span></span><span class="comment">'
</span>    <span class="comment-delimiter">;; </span><span class="comment">needs to be run after other hooks have acted.
</span>    (run-at-time nil nil #'org-appear--set-fragments))
  <span class="comment-delimiter">;; </span><span class="comment">(use-package org-pretty-tags
</span>  <span class="comment-delimiter">;; </span><span class="comment">:config
</span>  <span class="comment-delimiter">;;  </span><span class="comment">(setq org-pretty-tags-surrogate-strings
</span>  <span class="comment-delimiter">;;        </span><span class="comment">`(("uni"        . ,(all-the-icons-faicon   "graduation-cap" :face 'all-the-icons-purple  :v-adjust 0.01))
</span>  <span class="comment-delimiter">;;          </span><span class="comment">("ucc"        . ,(all-the-icons-material "computer"       :face 'all-the-icons-silver  :v-adjust 0.01))
</span>  <span class="comment-delimiter">;;          </span><span class="comment">("assignment" . ,(all-the-icons-material "library_books"  :face 'all-the-icons-orange  :v-adjust 0.01))
</span>  <span class="comment-delimiter">;;          </span><span class="comment">("test"       . ,(all-the-icons-material "timer"          :face 'all-the-icons-red     :v-adjust 0.01))
</span>  <span class="comment-delimiter">;;          </span><span class="comment">("lecture"    . ,(all-the-icons-fileicon "keynote"        :face 'all-the-icons-orange  :v-adjust 0.01))
</span>  <span class="comment-delimiter">;;          </span><span class="comment">("email"      . ,(all-the-icons-faicon   "envelope"       :face 'all-the-icons-blue    :v-adjust 0.01))
</span>  <span class="comment-delimiter">;;          </span><span class="comment">("read"       . ,(all-the-icons-octicon  "book"           :face 'all-the-icons-lblue   :v-adjust 0.01))
</span>  <span class="comment-delimiter">;;          </span><span class="comment">("article"    . ,(all-the-icons-octicon  "file-text"      :face 'all-the-icons-yellow  :v-adjust 0.01))
</span>  <span class="comment-delimiter">;;          </span><span class="comment">("web"        . ,(all-the-icons-faicon   "globe"          :face 'all-the-icons-green   :v-adjust 0.01))
</span>  <span class="comment-delimiter">;;          </span><span class="comment">("info"       . ,(all-the-icons-faicon   "info-circle"    :face 'all-the-icons-blue    :v-adjust 0.01))
</span>  <span class="comment-delimiter">;;          </span><span class="comment">("issue"      . ,(all-the-icons-faicon   "bug"            :face 'all-the-icons-red     :v-adjust 0.01))
</span>  <span class="comment-delimiter">;;          </span><span class="comment">("someday"    . ,(all-the-icons-faicon   "calendar-o"     :face 'all-the-icons-cyan    :v-adjust 0.01))
</span>  <span class="comment-delimiter">;;          </span><span class="comment">("idea"       . ,(all-the-icons-octicon  "light-bulb"     :face 'all-the-icons-yellow  :v-adjust 0.01))
</span>  <span class="comment-delimiter">;;          </span><span class="comment">("emacs"      . ,(all-the-icons-fileicon "emacs"          :face 'all-the-icons-lpurple :v-adjust 0.01))))
</span>  <span class="comment-delimiter">;;  </span><span class="comment">(org-pretty-tags-global-mode))
</span>  
  (<span class="keyword">after!</span> org-superstar
    (<span class="keyword">setq</span> org-superstar-headline-bullets-list '(<span class="string">"&#226;&#151;&#137;"</span> <span class="string">"&#226;&#151;&#139;"</span> <span class="string">"&#226;&#156;&#184;"</span> <span class="string">"&#226;&#156;&#191;"</span> <span class="string">"&#226;&#156;&#164;"</span> <span class="string">"&#226;&#156;&#156;"</span> <span class="string">"&#226;&#151;&#134;"</span> <span class="string">"&#226;&#150;&#182;"</span>)
          <span class="comment-delimiter">;; </span><span class="comment">org-superstar-headline-bullets-list '("&#226;&#133;&#160;" "&#226;&#133;&#161;" "&#226;&#133;&#162;" "&#226;&#133;&#163;" "&#226;&#133;&#164;" "&#226;&#133;&#165;" "&#226;&#133;&#166;" "&#226;&#133;&#167;" "&#226;&#133;&#168;" "&#226;&#133;&#169;")
</span>          org-superstar-prettify-item-bullets t ))
  
  (<span class="keyword">setq</span> org-ellipsis <span class="string">" &#226;&#150;&#190; "</span>
        org-hide-leading-stars t
        org-priority-highest ?A
        org-priority-lowest ?E
        org-priority-faces
        '((?A . 'all-the-icons-red)
          (?B . 'all-the-icons-orange)
          (?C . 'all-the-icons-yellow)
          (?D . 'all-the-icons-green)
          (?E . 'all-the-icons-blue)))
  (<span class="keyword">appendq!</span> +ligatures-extra-symbols
            `(<span class="builtin">:checkbox</span>      <span class="string">"&#226;&#152;&#144;"</span>
              <span class="builtin">:pending</span>       <span class="string">"&#226;&#151;&#188;"</span>
              <span class="builtin">:checkedbox</span>    <span class="string">"&#226;&#152;&#145;"</span>
              <span class="builtin">:list_property</span> <span class="string">"&#226;&#136;&#183;"</span>
              <span class="builtin">:em_dash</span>       <span class="string">"&#226;&#128;&#148;"</span>
              <span class="builtin">:ellipses</span>      <span class="string">"&#226;&#128;&#166;"</span>
              <span class="builtin">:title</span>         <span class="string">"&#240;&#157;&#153;&#143;"</span>
              <span class="builtin">:subtitle</span>      <span class="string">"&#240;&#157;&#153;&#169;"</span>
              <span class="builtin">:author</span>        <span class="string">"&#240;&#157;&#152;&#188;"</span>
              <span class="builtin">:date</span>          <span class="string">"&#240;&#157;&#152;&#191;"</span>
              <span class="builtin">:property</span>      <span class="string">"&#226;&#152;&#184;"</span>
              <span class="builtin">:options</span>       <span class="string">"&#226;&#140;&#165;"</span>
              <span class="builtin">:latex_class</span>   <span class="string">"&#240;&#159;&#132;&#178;"</span>
              <span class="builtin">:latex_header</span>  <span class="string">"&#226;&#135;&#165;"</span>
              <span class="builtin">:beamer_header</span> <span class="string">"&#226;&#134;&#160;"</span>
              <span class="builtin">:attr_latex</span>    <span class="string">"&#240;&#159;&#132;&#155;"</span>
              <span class="builtin">:attr_html</span>     <span class="string">"&#240;&#159;&#132;&#151;"</span>
              <span class="builtin">:begin_quote</span>   <span class="string">"&#226;&#157;&#174;"</span>
              <span class="builtin">:end_quote</span>     <span class="string">"&#226;&#157;&#175;"</span>
              <span class="builtin">:caption</span>       <span class="string">"&#226;&#152;&#176;"</span>
              <span class="builtin">:header</span>        <span class="string">"&#226;&#128;&#186;"</span>
              <span class="builtin">:results</span>       <span class="string">"&#240;&#159;&#160;&#182;"</span>
              <span class="builtin">:begin_export</span>  <span class="string">"&#226;&#143;&#169;"</span>
              <span class="builtin">:end_export</span>    <span class="string">"&#226;&#143;&#170;"</span>
              <span class="builtin">:properties</span>    <span class="string">"&#226;&#154;&#153;"</span>
              <span class="builtin">:end</span>           <span class="string">"&#226;&#136;&#142;"</span>
              <span class="builtin">:priority_a</span>   ,(propertize <span class="string">"&#226;&#154;&#145;"</span> 'face 'all-the-icons-red)
              <span class="builtin">:priority_b</span>   ,(propertize <span class="string">"&#226;&#172;&#134;"</span> 'face 'all-the-icons-orange)
              <span class="builtin">:priority_c</span>   ,(propertize <span class="string">"&#226;&#150;&#160;"</span> 'face 'all-the-icons-yellow)
              <span class="builtin">:priority_d</span>   ,(propertize <span class="string">"&#226;&#172;&#135;"</span> 'face 'all-the-icons-green)
              <span class="builtin">:priority_e</span>   ,(propertize <span class="string">"&#226;&#157;&#147;"</span> 'face 'all-the-icons-blue)))
  (set-ligatures! 'org-mode
    <span class="builtin">:merge</span> t
    <span class="builtin">:checkbox</span>      <span class="string">"[ ]"</span>
    <span class="builtin">:pending</span>       <span class="string">"[-]"</span>
    <span class="builtin">:checkedbox</span>    <span class="string">"[X]"</span>
    <span class="builtin">:list_property</span> <span class="string">"::"</span>
    <span class="builtin">:em_dash</span>       <span class="string">"---"</span>
    <span class="builtin">:ellipsis</span>      <span class="string">"..."</span>
    <span class="builtin">:title</span>         <span class="string">"#+title:"</span>
    <span class="builtin">:subtitle</span>      <span class="string">"#+subtitle:"</span>
    <span class="builtin">:author</span>        <span class="string">"#+author:"</span>
    <span class="builtin">:date</span>          <span class="string">"#+date:"</span>
    <span class="builtin">:property</span>      <span class="string">"#+property:"</span>
    <span class="builtin">:options</span>       <span class="string">"#+options:"</span>
    <span class="builtin">:latex_class</span>   <span class="string">"#+latex_class:"</span>
    <span class="builtin">:latex_header</span>  <span class="string">"#+latex_header:"</span>
    <span class="builtin">:beamer_header</span> <span class="string">"#+beamer_header:"</span>
    <span class="builtin">:attr_latex</span>    <span class="string">"#+attr_latex:"</span>
    <span class="builtin">:attr_html</span>     <span class="string">"#+attr_latex:"</span>
    <span class="builtin">:begin_quote</span>   <span class="string">"#+begin_quote"</span>
    <span class="builtin">:end_quote</span>     <span class="string">"#+end_quote"</span>
    <span class="builtin">:caption</span>       <span class="string">"#+caption:"</span>
    <span class="builtin">:header</span>        <span class="string">"#+header:"</span>
    <span class="builtin">:begin_export</span>  <span class="string">"#+begin_export"</span>
    <span class="builtin">:end_export</span>    <span class="string">"#+end_export"</span>
    <span class="builtin">:results</span>       <span class="string">"#+RESULTS:"</span>
    <span class="builtin">:property</span>      <span class="string">":PROPERTIES:"</span>
    <span class="builtin">:end</span>           <span class="string">":END:"</span>
    <span class="builtin">:priority_a</span>    <span class="string">"[#A]"</span>
    <span class="builtin">:priority_b</span>    <span class="string">"[#B]"</span>
    <span class="builtin">:priority_c</span>    <span class="string">"[#C]"</span>
    <span class="builtin">:priority_d</span>    <span class="string">"[#D]"</span>
    <span class="builtin">:priority_e</span>    <span class="string">"[#E]"</span>)
  (plist-put +ligatures-extra-symbols <span class="builtin">:name</span> <span class="string">"&#226;&#129;&#141;"</span>)
  (<span class="keyword">setq</span> org-highlight-latex-and-related '(native script entities))
  (<span class="keyword">use-package!</span> org-fragtog
    <span class="builtin">:hook</span> (org-mode . org-fragtog-mode))
  (<span class="keyword">setq</span> org-format-latex-header <span class="string">"\\documentclass{article}
  \\usepackage[usenames]{color}
  
  \\usepackage[T1]{fontenc}
  
  \\usepackage{booktabs}
  
  \\pagestyle{empty}             % do not remove
  % The settings below are copied from fullpage.sty
  \\setlength{\\textwidth}{\\paperwidth}
  \\addtolength{\\textwidth}{-3cm}
  \\setlength{\\oddsidemargin}{1.5cm}
  \\addtolength{\\oddsidemargin}{-2.54cm}
  \\setlength{\\evensidemargin}{\\oddsidemargin}
  \\setlength{\\textheight}{\\paperheight}
  \\addtolength{\\textheight}{-\\headheight}
  \\addtolength{\\textheight}{-\\headsep}
  \\addtolength{\\textheight}{-\\footskip}
  \\addtolength{\\textheight}{-3cm}
  \\setlength{\\topmargin}{1.5cm}
  \\addtolength{\\topmargin}{-2.54cm}
  % my custom stuff
  \\usepackage[nofont,plaindd]{bmc-maths}
  \\usepackage{arev}
  "</span>)
  <span class="comment-delimiter">;; </span><span class="comment">make background of fragments transparent
</span>  <span class="comment-delimiter">;; </span><span class="comment">(let ((dvipng--plist (alist-get 'dvipng org-preview-latex-process-alist)))
</span>  <span class="comment-delimiter">;;   </span><span class="comment">(plist-put dvipng--plist :use-xcolor t)
</span>  <span class="comment-delimiter">;;   </span><span class="comment">(plist-put dvipng--plist :image-converter '("dvipng -D %D -bg 'transparent' -T tight -o %O %f")))
</span>  (<span class="keyword">add-hook!</span> 'doom-load-theme-hook
    (<span class="keyword">defun</span> <span class="function-name">+org-refresh-latex-background</span> ()
      (<span class="keyword">plist-put!</span> org-format-latex-options
                  <span class="builtin">:background</span>
                  (face-attribute (<span class="keyword">or</span> (cadr (assq 'default face-remapping-alist))
                                      'default)
                                  <span class="builtin">:background</span> nil t))))
  (add-to-list 'org-latex-regexps '(<span class="string">"\\ce"</span> <span class="string">"^\\\\ce{</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(?:</span></span><span class="string">[</span><span class="string"><span class="negation-char">^</span></span><span class="string">\000{}]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">|</span></span><span class="string">{[</span><span class="string"><span class="negation-char">^</span></span><span class="string">\000}]+?}</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">}"</span> <span class="highlight-numbers-number">0</span> nil))
  (<span class="keyword">defun</span> <span class="function-name">scimax-org-latex-fragment-justify</span> (justification)
    <span class="doc">"Justify the latex fragment at point with JUSTIFICATION.
  JUSTIFICATION is a symbol for 'left, 'center or 'right."</span>
    (<span class="keyword">interactive</span>
     (list (intern-soft
            (completing-read <span class="string">"Justification (left): "</span> '(left center right)
                             nil t nil nil 'left))))
    (<span class="keyword">let*</span> ((ov (ov-at))
           (beg (ov-beg ov))
           (end (ov-end ov))
           (shift (- beg (line-beginning-position)))
           (img (overlay-get ov 'display))
           (img (<span class="keyword">and</span> (<span class="keyword">and</span> img (consp img) (eq (car img) 'image)
                          (image-type-available-p (plist-get (cdr img) <span class="builtin">:type</span>)))
                     img))
           space-left offset)
      (<span class="keyword">when</span> (<span class="keyword">and</span> img
                 <span class="comment-delimiter">;; </span><span class="comment">This means the equation is at the start of the line
</span>                 (= beg (line-beginning-position))
                 (<span class="keyword">or</span>
                  (string= <span class="string">""</span> (s-trim (buffer-substring end (line-end-position))))
                  (eq 'latex-environment (car (org-element-context)))))
        (<span class="keyword">setq</span> space-left (- (window-max-chars-per-line) (car (image-size img)))
              offset (floor (<span class="keyword">cond</span>
                             ((eq justification 'center)
                              (- (/ space-left <span class="highlight-numbers-number">2</span>) shift))
                             ((eq justification 'right)
                              (- space-left shift))
                             (t
                              <span class="highlight-numbers-number">0</span>))))
        (<span class="keyword">when</span> (&gt;= offset <span class="highlight-numbers-number">0</span>)
          (overlay-put ov 'before-string (make-string offset ?\ ))))))
  
  (<span class="keyword">defun</span> <span class="function-name">scimax-org-latex-fragment-justify-advice</span> (beg end image imagetype)
    <span class="doc">"After advice function to justify fragments."</span>
    (scimax-org-latex-fragment-justify (<span class="keyword">or</span> (plist-get org-format-latex-options <span class="builtin">:justify</span>) 'left)))
  
  
  (<span class="keyword">defun</span> <span class="function-name">scimax-toggle-latex-fragment-justification</span> ()
    <span class="doc">"Toggle if LaTeX fragment justification options can be used."</span>
    (<span class="keyword">interactive</span>)
    (<span class="keyword">if</span> (not (get 'scimax-org-latex-fragment-justify-advice 'enabled))
        (<span class="keyword">progn</span>
          (advice-add 'org--format-latex-make-overlay <span class="builtin">:after</span> 'scimax-org-latex-fragment-justify-advice)
          (put 'scimax-org-latex-fragment-justify-advice 'enabled t)
          (message <span class="string">"Latex fragment justification enabled"</span>))
      (advice-remove 'org--format-latex-make-overlay 'scimax-org-latex-fragment-justify-advice)
      (put 'scimax-org-latex-fragment-justify-advice 'enabled nil)
      (message <span class="string">"Latex fragment justification disabled"</span>)))
  <span class="comment-delimiter">;; </span><span class="comment">Numbered equations all have (1) as the number for fragments with vanilla
</span>  <span class="comment-delimiter">;; </span><span class="comment">org-mode. This code injects the correct numbers into the previews so they
</span>  <span class="comment-delimiter">;; </span><span class="comment">look good.
</span>  (<span class="keyword">defun</span> <span class="function-name">scimax-org-renumber-environment</span> (orig-func <span class="type">&amp;rest</span> args)
    <span class="doc">"A function to inject numbers in LaTeX fragment previews."</span>
    (<span class="keyword">let</span> ((results '())
          (counter <span class="highlight-numbers-number">-1</span>)
          (numberp))
      (<span class="keyword">setq</span> results (<span class="keyword">cl-loop</span> for (begin . env) in
                             (org-element-map (org-element-parse-buffer) 'latex-environment
                               (<span class="keyword">lambda</span> (env)
                                 (cons
                                  (org-element-property <span class="builtin">:begin</span> env)
                                  (org-element-property <span class="builtin">:value</span> env))))
                             collect
                             (<span class="keyword">cond</span>
                              ((<span class="keyword">and</span> (string-match <span class="string">"\\\\begin{equation}"</span> env)
                                    (not (string-match <span class="string">"\\\\tag{"</span> env)))
                               (<span class="keyword">incf</span> counter)
                               (cons begin counter))
                              ((string-match <span class="string">"\\\\begin{align}"</span> env)
                               (<span class="keyword">prog2</span>
                                   (<span class="keyword">incf</span> counter)
                                   (cons begin counter)
                                 (<span class="keyword">with-temp-buffer</span>
                                   (insert env)
                                   (goto-char (point-min))
                                   <span class="comment-delimiter">;; </span><span class="comment">\\ is used for a new line. Each one leads to a number
</span>                                   (<span class="keyword">incf</span> counter (count-matches <span class="string">"\\\\$"</span>))
                                   <span class="comment-delimiter">;; </span><span class="comment">unless there are nonumbers.
</span>                                   (goto-char (point-min))
                                   (<span class="keyword">decf</span> counter (count-matches <span class="string">"\\nonumber"</span>)))))
                              (t
                               (cons begin nil)))))
  
      (<span class="keyword">when</span> (<span class="keyword">setq</span> numberp (cdr (assoc (point) results)))
        (<span class="keyword">setf</span> (car args)
              (concat
               (format <span class="string">"\\setcounter{equation}{%s}\n"</span> numberp)
               (car args)))))
  
    (apply orig-func args))
  
  
  (<span class="keyword">defun</span> <span class="function-name">scimax-toggle-latex-equation-numbering</span> ()
    <span class="doc">"Toggle whether LaTeX fragments are numbered."</span>
    (<span class="keyword">interactive</span>)
    (<span class="keyword">if</span> (not (get 'scimax-org-renumber-environment 'enabled))
        (<span class="keyword">progn</span>
          (advice-add 'org-create-formula-image <span class="builtin">:around</span> #'scimax-org-renumber-environment)
          (put 'scimax-org-renumber-environment 'enabled t)
          (message <span class="string">"Latex numbering enabled"</span>))
      (advice-remove 'org-create-formula-image #'scimax-org-renumber-environment)
      (put 'scimax-org-renumber-environment 'enabled nil)
      (message <span class="string">"Latex numbering disabled."</span>)))
  
  (advice-add 'org-create-formula-image <span class="builtin">:around</span> #'scimax-org-renumber-environment)
  (put 'scimax-org-renumber-environment 'enabled t)
  (<span class="keyword">after!</span> org-plot
    (<span class="keyword">defun</span> <span class="function-name">org-plot/generate-theme</span> (_type)
      <span class="doc">"Use the current Doom theme colours to generate a GnuPlot preamble."</span>
      (format <span class="string">"
  fgt = \"textcolor rgb '%s'\" # foreground text
  fgat = \"textcolor rgb '%s'\" # foreground alt text
  fgl = \"linecolor rgb '%s'\" # foreground line
  fgal = \"linecolor rgb '%s'\" # foreground alt line
  
  # foreground colors
  set border lc rgb '%s'
  # change text colors of  tics
  set xtics @fgt
  set ytics @fgt
  # change text colors of labels
  set title @fgt
  set xlabel @fgt
  set ylabel @fgt
  # change a text color of key
  set key @fgt
  
  # line styles
  set linetype 1 lw 2 lc rgb '%s' # red
  set linetype 2 lw 2 lc rgb '%s' # blue
  set linetype 3 lw 2 lc rgb '%s' # green
  set linetype 4 lw 2 lc rgb '%s' # magenta
  set linetype 5 lw 2 lc rgb '%s' # orange
  set linetype 6 lw 2 lc rgb '%s' # yellow
  set linetype 7 lw 2 lc rgb '%s' # teal
  set linetype 8 lw 2 lc rgb '%s' # violet
  
  # palette
  set palette maxcolors 8
  set palette defined ( 0 '%s',\
  1 '%s',\
  2 '%s',\
  3 '%s',\
  4 '%s',\
  5 '%s',\
  6 '%s',\
  7 '%s' )
  "</span>
              (doom-color 'fg)
              (doom-color 'fg-alt)
              (doom-color 'fg)
              (doom-color 'fg-alt)
              (doom-color 'fg)
              <span class="comment-delimiter">;; </span><span class="comment">colours
</span>              (doom-color 'red)
              (doom-color 'blue)
              (doom-color 'green)
              (doom-color 'magenta)
              (doom-color 'orange)
              (doom-color 'yellow)
              (doom-color 'teal)
              (doom-color 'violet)
              <span class="comment-delimiter">;; </span><span class="comment">duplicated
</span>              (doom-color 'red)
              (doom-color 'blue)
              (doom-color 'green)
              (doom-color 'magenta)
              (doom-color 'orange)
              (doom-color 'yellow)
              (doom-color 'teal)
              (doom-color 'violet)
              ))
    (<span class="keyword">defun</span> <span class="function-name">org-plot/gnuplot-term-properties</span> (_type)
      (format <span class="string">"background rgb '%s' size 1050,650"</span>
              (doom-color 'bg)))
    (<span class="keyword">setq</span> org-plot/gnuplot-script-preamble #'org-plot/generate-theme)
    (<span class="keyword">setq</span> org-plot/gnuplot-term-extra #'org-plot/gnuplot-term-properties))
  (<span class="keyword">setq</span> org-export-headline-levels <span class="highlight-numbers-number">5</span>) <span class="comment-delimiter">; </span><span class="comment">I like nesting
</span>  (<span class="keyword">require</span> '<span class="constant">ox-extra</span>)
  (ox-extras-activate '(ignore-headlines))
  (<span class="keyword">after!</span> ox-html
    (<span class="keyword">define-minor-mode</span> <span class="function-name">org-fancy-html-export-mode</span>
      <span class="doc">"Toggle my fabulous org export tweaks. While this mode itself does a little bit,
    the vast majority of the change in behaviour comes from switch statements in:
     - `</span><span class="doc"><span class="constant">org-html-template-fancier</span></span><span class="doc">'
     - `</span><span class="doc"><span class="constant">org-html--build-meta-info-extended</span></span><span class="doc">'
     - `</span><span class="doc"><span class="constant">org-html-src-block-collapsable</span></span><span class="doc">'
     - `</span><span class="doc"><span class="constant">org-html-block-collapsable</span></span><span class="doc">'
     - `</span><span class="doc"><span class="constant">org-html-table-wrapped</span></span><span class="doc">'
     - `</span><span class="doc"><span class="constant">org-html--format-toc-headline-colapseable</span></span><span class="doc">'
     - `</span><span class="doc"><span class="constant">org-html--toc-text-stripped-leaves</span></span><span class="doc">'
     - `</span><span class="doc"><span class="constant">org-export-html-headline-anchor</span></span><span class="doc">'"</span>
      <span class="builtin">:global</span> t
      <span class="builtin">:init-value</span> t
      (<span class="keyword">if</span> org-fancy-html-export-mode
          (<span class="keyword">setq</span> org-html-style-default org-html-style-fancy
                org-html-meta-tags #'org-html-meta-tags-fancy
                org-html-checkbox-type 'html-span)
        (<span class="keyword">setq</span> org-html-style-default org-html-style-plain
              org-html-meta-tags #'org-html-meta-tags-default
              org-html-checkbox-type 'html)))
    (<span class="keyword">defadvice!</span> org-html-template-fancier (orig-fn contents info)
      <span class="doc">"Return complete document string after HTML conversion.
    CONTENTS is the transcoded contents string.  INFO is a plist
    holding export options. Adds a few extra things to the body
    compared to the default implementation."</span>
      <span class="builtin">:around</span> #'org-html-template
      (<span class="keyword">if</span> (<span class="keyword">or</span> (not org-fancy-html-export-mode) (<span class="keyword">bound-and-true-p</span> org-msg-export-in-progress))
          (funcall orig-fn contents info)
        (concat
         (<span class="keyword">when</span> (<span class="keyword">and</span> (not (org-html-html5-p info)) (org-html-xhtml-p info))
           (<span class="keyword">let*</span> ((xml-declaration (plist-get info <span class="builtin">:html-xml-declaration</span>))
                  (decl (<span class="keyword">or</span> (<span class="keyword">and</span> (stringp xml-declaration) xml-declaration)
                            (cdr (assoc (plist-get info <span class="builtin">:html-extension</span>)
                                        xml-declaration))
                            (cdr (assoc <span class="string">"html"</span> xml-declaration))
                            <span class="string">""</span>)))
             (<span class="keyword">when</span> (not (<span class="keyword">or</span> (not decl) (string= <span class="string">""</span> decl)))
               (format <span class="string">"%s\n"</span>
                       (format decl
                               (<span class="keyword">or</span> (<span class="keyword">and</span> org-html-coding-system
                                        (fboundp 'coding-system-get)
                                        (coding-system-get org-html-coding-system 'mime-charset))
                                   <span class="string">"iso-8859-1"</span>))))))
         (org-html-doctype info)
         <span class="string">"\n"</span>
         (concat <span class="string">"&lt;html"</span>
                 (<span class="keyword">cond</span> ((org-html-xhtml-p info)
                        (format
                         <span class="string">" xmlns=\"http://www.w3.org/1999/xhtml\" lang=\"%s\" xml:lang=\"%s\""</span>
                         (plist-get info <span class="builtin">:language</span>) (plist-get info <span class="builtin">:language</span>)))
                       ((org-html-html5-p info)
                        (format <span class="string">" lang=\"%s\""</span> (plist-get info <span class="builtin">:language</span>))))
                 <span class="string">"&gt;\n"</span>)
         <span class="string">"&lt;head&gt;\n"</span>
         (org-html--build-meta-info info)
         (org-html--build-head info)
         (org-html--build-mathjax-config info)
         <span class="string">"&lt;/head&gt;\n"</span>
         <span class="string">"&lt;body&gt;\n&lt;input type='checkbox' id='theme-switch'&gt;&lt;div id='page'&gt;&lt;label id='switch-label' for='theme-switch'&gt;&lt;/label&gt;"</span>
         (<span class="keyword">let</span> ((link-up (org-trim (plist-get info <span class="builtin">:html-link-up</span>)))
               (link-home (org-trim (plist-get info <span class="builtin">:html-link-home</span>))))
           (<span class="keyword">unless</span> (<span class="keyword">and</span> (string= link-up <span class="string">""</span>) (string= link-home <span class="string">""</span>))
             (format (plist-get info <span class="builtin">:html-home/up-format</span>)
                     (<span class="keyword">or</span> link-up link-home)
                     (<span class="keyword">or</span> link-home link-up))))
         <span class="comment-delimiter">;; </span><span class="comment">Preamble.
</span>         (org-html--build-pre/postamble 'preamble info)
         <span class="comment-delimiter">;; </span><span class="comment">Document contents.
</span>         (<span class="keyword">let</span> ((div (assq 'content (plist-get info <span class="builtin">:html-divs</span>))))
           (format <span class="string">"&lt;%s id=\"%s\"&gt;\n"</span> (nth <span class="highlight-numbers-number">1</span> div) (nth <span class="highlight-numbers-number">2</span> div)))
         <span class="comment-delimiter">;; </span><span class="comment">Document title.
</span>         (<span class="keyword">when</span> (plist-get info <span class="builtin">:with-title</span>)
           (<span class="keyword">let</span> ((title (<span class="keyword">and</span> (plist-get info <span class="builtin">:with-title</span>)
                             (plist-get info <span class="builtin">:title</span>)))
                 (subtitle (plist-get info <span class="builtin">:subtitle</span>))
                 (html5-fancy (org-html--html5-fancy-p info)))
             (<span class="keyword">when</span> title
               (format
                <span class="string">"&lt;div class='page-header'&gt;&lt;div class='page-meta'&gt;%s, %s&lt;/div&gt;&lt;h1 class=\"title\"&gt;%s%s&lt;/h1&gt;&lt;/div&gt;\n"</span>
                (org-export-data (plist-get info <span class="builtin">:date</span>) info)
                (org-export-data (plist-get info <span class="builtin">:author</span>) info)
                (org-export-data title info)
                (<span class="keyword">if</span> subtitle
                    (format
                     (<span class="keyword">if</span> html5-fancy
                         <span class="string">"&lt;p class=\"subtitle\"&gt;%s&lt;/p&gt;\n"</span>
                       (concat <span class="string">"\n"</span> (org-html-close-tag <span class="string">"br"</span> nil info) <span class="string">"\n"</span>
                               <span class="string">"&lt;span class=\"subtitle\"&gt;%s&lt;/span&gt;\n"</span>))
                     (org-export-data subtitle info))
                  <span class="string">""</span>)))))
         contents
         (format <span class="string">"&lt;/%s&gt;\n"</span> (nth <span class="highlight-numbers-number">1</span> (assq 'content (plist-get info <span class="builtin">:html-divs</span>))))
         <span class="comment-delimiter">;; </span><span class="comment">Postamble.
</span>         (org-html--build-pre/postamble 'postamble info)
         <span class="comment-delimiter">;; </span><span class="comment">Possibly use the Klipse library live code blocks.
</span>         (<span class="keyword">when</span> (plist-get info <span class="builtin">:html-klipsify-src</span>)
           (concat <span class="string">"&lt;script&gt;"</span> (plist-get info <span class="builtin">:html-klipse-selection-script</span>)
                   <span class="string">"&lt;/script&gt;&lt;script src=\""</span>
                   org-html-klipse-js
                   <span class="string">"\"&gt;&lt;/script&gt;&lt;link rel=\"stylesheet\" type=\"text/css\" href=\""</span>
                   org-html-klipse-css <span class="string">"\"/&gt;"</span>))
         <span class="comment-delimiter">;; </span><span class="comment">Closing document.
</span>         <span class="string">"&lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;"</span>)))
    (<span class="keyword">defadvice!</span> org-html-toc-linked (depth info <span class="type">&amp;optional</span> scope)
      <span class="doc">"Build a table of contents.
    
    Just like `</span><span class="doc"><span class="constant">org-html-toc</span></span><span class="doc">', except the header is a link to \"#\".
    
    DEPTH is an integer specifying the depth of the table.  INFO is
    a plist used as a communication channel.  Optional argument SCOPE
    is an element defining the scope of the table.  Return the table
    of contents as a string, or nil if it is empty."</span>
      <span class="builtin">:override</span> #'org-html-toc
      (<span class="keyword">let</span> ((toc-entries
         (mapcar (<span class="keyword">lambda</span> (headline)
               (cons (org-html--format-toc-headline headline info)
                 (org-export-get-relative-level headline info)))
             (org-export-collect-headlines info depth scope))))
        (<span class="keyword">when</span> toc-entries
          (<span class="keyword">let</span> ((toc (concat <span class="string">"&lt;div id=\"text-table-of-contents\"&gt;"</span>
                 (org-html--toc-text toc-entries)
                 <span class="string">"&lt;/div&gt;\n"</span>)))
        (<span class="keyword">if</span> scope toc
          (<span class="keyword">let</span> ((outer-tag (<span class="keyword">if</span> (org-html--html5-fancy-p info)
                       <span class="string">"nav"</span>
                     <span class="string">"div"</span>)))
            (concat (format <span class="string">"&lt;%s id=\"table-of-contents\"&gt;\n"</span> outer-tag)
                (<span class="keyword">let</span> ((top-level (plist-get info <span class="builtin">:html-toplevel-hlevel</span>)))
                  (format <span class="string">"&lt;h%d&gt;&lt;a href=\"#\" style=\"color:inherit; text-decoration: none;\"&gt;%s&lt;/a&gt;&lt;/h%d&gt;\n"</span>
                      top-level
                      (org-html--translate <span class="string">"Table of Contents"</span> info)
                      top-level))
                toc
                (format <span class="string">"&lt;/%s&gt;\n"</span> outer-tag))))))))
    (<span class="keyword">defun</span> <span class="function-name">org-html-meta-tags-fancy</span> (info)
      <span class="doc">"Use the INFO plist to construct the meta tags, as described in `</span><span class="doc"><span class="constant">org-html-meta-tags</span></span><span class="doc">'."</span>
      (<span class="keyword">let</span> ((title (org-html-plain-text
                    (org-element-interpret-data (plist-get info <span class="builtin">:title</span>)) info))
            (author (<span class="keyword">and</span> (plist-get info <span class="builtin">:with-author</span>)
                         (<span class="keyword">let</span> ((auth (plist-get info <span class="builtin">:author</span>)))
                           <span class="comment-delimiter">;; </span><span class="comment">Return raw Org syntax.
</span>                           (<span class="keyword">and</span> auth (org-html-plain-text
                                      (org-element-interpret-data auth) info))))))
        (list
         (<span class="keyword">when</span> (org-string-nw-p author)
           (list <span class="string">"name"</span> <span class="string">"author"</span> author))
         (<span class="keyword">when</span> (org-string-nw-p (plist-get info <span class="builtin">:description</span>))
           (list <span class="string">"name"</span> <span class="string">"description"</span>
                 (plist-get info <span class="builtin">:description</span>)))
         '(<span class="string">"name"</span> <span class="string">"generator"</span> <span class="string">"org mode"</span>)
         '(<span class="string">"name"</span> <span class="string">"theme-color"</span> <span class="string">"#77aa99"</span>)
         '(<span class="string">"property"</span> <span class="string">"og:type"</span> <span class="string">"article"</span>)
         (list <span class="string">"property"</span> <span class="string">"og:title"</span> title)
         (<span class="keyword">let</span> ((subtitle (org-export-data (plist-get info <span class="builtin">:subtitle</span>) info)))
           (<span class="keyword">when</span> (org-string-nw-p subtitle)
             (list <span class="string">"property"</span> <span class="string">"og:description"</span> subtitle)))
         '(<span class="string">"property"</span> <span class="string">"og:image"</span> <span class="string">"https://tecosaur.com/resources/org/nib.png"</span>)
         '(<span class="string">"property"</span> <span class="string">"og:image:type"</span> <span class="string">"image/png"</span>)
         '(<span class="string">"property"</span> <span class="string">"og:image:width"</span> <span class="string">"200"</span>)
         '(<span class="string">"property"</span> <span class="string">"og:image:height"</span> <span class="string">"200"</span>)
         '(<span class="string">"property"</span> <span class="string">"og:image:alt"</span> <span class="string">"Green fountain pen nib"</span>)
         (<span class="keyword">when</span> (org-string-nw-p author)
           (list <span class="string">"property"</span> <span class="string">"og:article:author:first_name"</span> (car (s-split-up-to <span class="string">" "</span> author <span class="highlight-numbers-number">2</span>))))
         (<span class="keyword">when</span> (<span class="keyword">and</span> (org-string-nw-p author) (s-contains-p <span class="string">" "</span> author))
           (list <span class="string">"property"</span> <span class="string">"og:article:author:last_name"</span> (cadr (s-split-up-to <span class="string">" "</span> author <span class="highlight-numbers-number">2</span>))))
         (list <span class="string">"property"</span> <span class="string">"og:article:published_time"</span> (format-time-string <span class="string">"%FT%T%z"</span>)))))
    
    (<span class="keyword">unless</span> (functionp #'org-html-meta-tags-default)
      (<span class="keyword">defalias</span> '<span class="function-name">org-html-meta-tags-default</span> #'ignore))
    (<span class="keyword">setq</span> org-html-meta-tags #'org-html-meta-tags-fancy)
    (<span class="keyword">setq</span> org-html-style-plain org-html-style-default
          org-html-htmlize-output-type 'css
          org-html-doctype <span class="string">"html5"</span>
          org-html-html5-fancy t)
    
    (<span class="keyword">defun</span> <span class="function-name">org-html-reload-fancy-style</span> ()
      (<span class="keyword">interactive</span>)
      (<span class="keyword">setq</span> org-html-style-fancy
            (concat (f-read-text (expand-file-name <span class="string">"misc/org-export-header.html"</span> doom-private-dir))
                    <span class="string">"&lt;script&gt;\n"</span>
                    (f-read-text (expand-file-name <span class="string">"misc/org-css/main.js"</span> doom-private-dir))
                    <span class="string">"&lt;/script&gt;\n&lt;style&gt;\n"</span>
                    (f-read-text (expand-file-name <span class="string">"misc/org-css/main.css"</span> doom-private-dir))
                    <span class="string">"&lt;/style&gt;"</span>))
      (<span class="keyword">when</span> org-fancy-html-export-mode
        (<span class="keyword">setq</span> org-html-style-default org-html-style-fancy)))
    (org-html-reload-fancy-style)
    (<span class="keyword">defvar</span> <span class="variable-name">org-html-export-collapsed</span> nil)
    (eval '(cl-pushnew '(<span class="builtin">:collapsed</span> <span class="string">"COLLAPSED"</span> <span class="string">"collapsed"</span> org-html-export-collapsed t)
                       (org-export-backend-options (org-export-get-backend 'html))))
    (add-to-list 'org-default-properties <span class="string">"EXPORT_COLLAPSED"</span>)
    (<span class="keyword">defadvice!</span> org-html-src-block-collapsable (orig-fn src-block contents info)
      <span class="doc">"Wrap the usual &lt;pre&gt; block in a &lt;details&gt;"</span>
      <span class="builtin">:around</span> #'org-html-src-block
      (<span class="keyword">if</span> (<span class="keyword">or</span> (not org-fancy-html-export-mode) (<span class="keyword">bound-and-true-p</span> org-msg-export-in-progress))
          (funcall orig-fn src-block contents info)
        (<span class="keyword">let*</span> ((properties (cadr src-block))
               (lang (mode-name-to-lang-name
                      (plist-get properties <span class="builtin">:language</span>)))
               (name (plist-get properties <span class="builtin">:name</span>))
               (ref (org-export-get-reference src-block info))
               (collapsed-p (member (<span class="keyword">or</span> (org-export-read-attribute <span class="builtin">:attr_html</span> src-block <span class="builtin">:collapsed</span>)
                                        (plist-get info <span class="builtin">:collapsed</span>))
                                    '(<span class="string">"y"</span> <span class="string">"yes"</span> <span class="string">"t"</span> t <span class="string">"true"</span> <span class="string">"all"</span>))))
          (format
           <span class="string">"&lt;details id='%s' class='code'%s&gt;&lt;summary%s&gt;%s&lt;/summary&gt;
    &lt;div class='gutter'&gt;
    &lt;a href='#%s'&gt;#&lt;/a&gt;
    &lt;button title='Copy to clipboard' onclick='copyPreToClipbord(this)'&gt;&#226;&#142;&#152;&lt;/button&gt;\
    &lt;/div&gt;
    %s
    &lt;/details&gt;"</span>
           ref
           (<span class="keyword">if</span> collapsed-p <span class="string">""</span> <span class="string">" open"</span>)
           (<span class="keyword">if</span> name <span class="string">" class='named'"</span> <span class="string">""</span>)
           (<span class="keyword">if</span> (not name) (concat <span class="string">"&lt;span class='lang'&gt;"</span> lang <span class="string">"&lt;/span&gt;"</span>)
             (format <span class="string">"&lt;span class='name'&gt;%s&lt;/span&gt;&lt;span class='lang'&gt;%s&lt;/span&gt;"</span> name lang))
           ref
           (<span class="keyword">if</span> name
               (replace-regexp-in-string (format <span class="string">"&lt;pre</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string"> class=\"[</span><span class="string"><span class="negation-char">^</span></span><span class="string">\"]+\"</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">? id=\"%s\"&gt;"</span> ref) <span class="string">"&lt;pre\\1&gt;"</span>
                                         (funcall orig-fn src-block contents info))
             (funcall orig-fn src-block contents info))))))
    
    (<span class="keyword">defun</span> <span class="function-name">mode-name-to-lang-name</span> (mode)
      (<span class="keyword">or</span> (cadr (assoc mode
                       '((<span class="string">"asymptote"</span> <span class="string">"Asymptote"</span>)
                         (<span class="string">"awk"</span> <span class="string">"Awk"</span>)
                         (<span class="string">"C"</span> <span class="string">"C"</span>)
                         (<span class="string">"clojure"</span> <span class="string">"Clojure"</span>)
                         (<span class="string">"css"</span> <span class="string">"CSS"</span>)
                         (<span class="string">"D"</span> <span class="string">"D"</span>)
                         (<span class="string">"ditaa"</span> <span class="string">"ditaa"</span>)
                         (<span class="string">"dot"</span> <span class="string">"Graphviz"</span>)
                         (<span class="string">"calc"</span> <span class="string">"Emacs Calc"</span>)
                         (<span class="string">"emacs-lisp"</span> <span class="string">"Emacs Lisp"</span>)
                         (<span class="string">"fortran"</span> <span class="string">"Fortran"</span>)
                         (<span class="string">"gnuplot"</span> <span class="string">"gnuplot"</span>)
                         (<span class="string">"haskell"</span> <span class="string">"Haskell"</span>)
                         (<span class="string">"hledger"</span> <span class="string">"hledger"</span>)
                         (<span class="string">"java"</span> <span class="string">"Java"</span>)
                         (<span class="string">"js"</span> <span class="string">"Javascript"</span>)
                         (<span class="string">"latex"</span> <span class="string">"LaTeX"</span>)
                         (<span class="string">"ledger"</span> <span class="string">"Ledger"</span>)
                         (<span class="string">"lisp"</span> <span class="string">"Lisp"</span>)
                         (<span class="string">"lilypond"</span> <span class="string">"Lilypond"</span>)
                         (<span class="string">"lua"</span> <span class="string">"Lua"</span>)
                         (<span class="string">"matlab"</span> <span class="string">"MATLAB"</span>)
                         (<span class="string">"mscgen"</span> <span class="string">"Mscgen"</span>)
                         (<span class="string">"ocaml"</span> <span class="string">"Objective Caml"</span>)
                         (<span class="string">"octave"</span> <span class="string">"Octave"</span>)
                         (<span class="string">"org"</span> <span class="string">"Org mode"</span>)
                         (<span class="string">"oz"</span> <span class="string">"OZ"</span>)
                         (<span class="string">"plantuml"</span> <span class="string">"Plantuml"</span>)
                         (<span class="string">"processing"</span> <span class="string">"Processing.js"</span>)
                         (<span class="string">"python"</span> <span class="string">"Python"</span>)
                         (<span class="string">"R"</span> <span class="string">"R"</span>)
                         (<span class="string">"ruby"</span> <span class="string">"Ruby"</span>)
                         (<span class="string">"sass"</span> <span class="string">"Sass"</span>)
                         (<span class="string">"scheme"</span> <span class="string">"Scheme"</span>)
                         (<span class="string">"screen"</span> <span class="string">"Gnu Screen"</span>)
                         (<span class="string">"sed"</span> <span class="string">"Sed"</span>)
                         (<span class="string">"sh"</span> <span class="string">"shell"</span>)
                         (<span class="string">"sql"</span> <span class="string">"SQL"</span>)
                         (<span class="string">"sqlite"</span> <span class="string">"SQLite"</span>)
                         (<span class="string">"forth"</span> <span class="string">"Forth"</span>)
                         (<span class="string">"io"</span> <span class="string">"IO"</span>)
                         (<span class="string">"J"</span> <span class="string">"J"</span>)
                         (<span class="string">"makefile"</span> <span class="string">"Makefile"</span>)
                         (<span class="string">"maxima"</span> <span class="string">"Maxima"</span>)
                         (<span class="string">"perl"</span> <span class="string">"Perl"</span>)
                         (<span class="string">"picolisp"</span> <span class="string">"Pico Lisp"</span>)
                         (<span class="string">"scala"</span> <span class="string">"Scala"</span>)
                         (<span class="string">"shell"</span> <span class="string">"Shell Script"</span>)
                         (<span class="string">"ebnf2ps"</span> <span class="string">"ebfn2ps"</span>)
                         (<span class="string">"cpp"</span> <span class="string">"C++"</span>)
                         (<span class="string">"abc"</span> <span class="string">"ABC"</span>)
                         (<span class="string">"coq"</span> <span class="string">"Coq"</span>)
                         (<span class="string">"groovy"</span> <span class="string">"Groovy"</span>)
                         (<span class="string">"bash"</span> <span class="string">"bash"</span>)
                         (<span class="string">"csh"</span> <span class="string">"csh"</span>)
                         (<span class="string">"ash"</span> <span class="string">"ash"</span>)
                         (<span class="string">"dash"</span> <span class="string">"dash"</span>)
                         (<span class="string">"ksh"</span> <span class="string">"ksh"</span>)
                         (<span class="string">"mksh"</span> <span class="string">"mksh"</span>)
                         (<span class="string">"posh"</span> <span class="string">"posh"</span>)
                         (<span class="string">"ada"</span> <span class="string">"Ada"</span>)
                         (<span class="string">"asm"</span> <span class="string">"Assembler"</span>)
                         (<span class="string">"caml"</span> <span class="string">"Caml"</span>)
                         (<span class="string">"delphi"</span> <span class="string">"Delphi"</span>)
                         (<span class="string">"html"</span> <span class="string">"HTML"</span>)
                         (<span class="string">"idl"</span> <span class="string">"IDL"</span>)
                         (<span class="string">"mercury"</span> <span class="string">"Mercury"</span>)
                         (<span class="string">"metapost"</span> <span class="string">"MetaPost"</span>)
                         (<span class="string">"modula-2"</span> <span class="string">"Modula-2"</span>)
                         (<span class="string">"pascal"</span> <span class="string">"Pascal"</span>)
                         (<span class="string">"ps"</span> <span class="string">"PostScript"</span>)
                         (<span class="string">"prolog"</span> <span class="string">"Prolog"</span>)
                         (<span class="string">"simula"</span> <span class="string">"Simula"</span>)
                         (<span class="string">"tcl"</span> <span class="string">"tcl"</span>)
                         (<span class="string">"tex"</span> <span class="string">"LaTeX"</span>)
                         (<span class="string">"plain-tex"</span> <span class="string">"TeX"</span>)
                         (<span class="string">"verilog"</span> <span class="string">"Verilog"</span>)
                         (<span class="string">"vhdl"</span> <span class="string">"VHDL"</span>)
                         (<span class="string">"xml"</span> <span class="string">"XML"</span>)
                         (<span class="string">"nxml"</span> <span class="string">"XML"</span>)
                         (<span class="string">"conf"</span> <span class="string">"Configuration File"</span>))))
          mode))
    (<span class="keyword">defun</span> <span class="function-name">org-html-block-collapsable</span> (orig-fn block contents info)
      <span class="doc">"Wrap the usual block in a &lt;details&gt;"</span>
      (<span class="keyword">if</span> (<span class="keyword">or</span> (not org-fancy-html-export-mode) (<span class="keyword">bound-and-true-p</span> org-msg-export-in-progress))
          (funcall orig-fn block contents info)
        (<span class="keyword">let</span> ((ref (org-export-get-reference block info))
              (type (<span class="keyword">pcase</span> (car block)
                      ('property-drawer <span class="string">"Properties"</span>)))
              (collapsed-default (<span class="keyword">pcase</span> (car block)
                                   ('property-drawer t)
                                   (_ nil)))
              (collapsed-value (org-export-read-attribute <span class="builtin">:attr_html</span> block <span class="builtin">:collapsed</span>))
              (collapsed-p (<span class="keyword">or</span> (member (org-export-read-attribute <span class="builtin">:attr_html</span> block <span class="builtin">:collapsed</span>)
                                       '(<span class="string">"y"</span> <span class="string">"yes"</span> <span class="string">"t"</span> t <span class="string">"true"</span>))
                               (member (plist-get info <span class="builtin">:collapsed</span>) '(<span class="string">"all"</span>)))))
          (format
           <span class="string">"&lt;details id='%s' class='code'%s&gt;
    &lt;summary%s&gt;%s&lt;/summary&gt;
    &lt;div class='gutter'&gt;\
    &lt;a href='#%s'&gt;#&lt;/a&gt;
    &lt;button title='Copy to clipboard' onclick='copyPreToClipbord(this)'&gt;&#226;&#142;&#152;&lt;/button&gt;\
    &lt;/div&gt;
    %s\n
    &lt;/details&gt;"</span>
           ref
           (<span class="keyword">if</span> (<span class="keyword">or</span> collapsed-p collapsed-default) <span class="string">""</span> <span class="string">" open"</span>)
           (<span class="keyword">if</span> type <span class="string">" class='named'"</span> <span class="string">""</span>)
           (<span class="keyword">if</span> type (format <span class="string">"&lt;span class='type'&gt;%s&lt;/span&gt;"</span> type) <span class="string">""</span>)
           ref
           (funcall orig-fn block contents info)))))
    
    (advice-add 'org-html-example-block   <span class="builtin">:around</span> #'org-html-block-collapsable)
    (advice-add 'org-html-fixed-width     <span class="builtin">:around</span> #'org-html-block-collapsable)
    (advice-add 'org-html-property-drawer <span class="builtin">:around</span> #'org-html-block-collapsable)
    (add-hook 'htmlize-before-hook #'highlight-numbers--turn-on)
    (<span class="keyword">defadvice!</span> org-html-table-wrapped (orig-fn table contents info)
      <span class="doc">"Wrap the usual &lt;table&gt; in a &lt;div&gt;"</span>
      <span class="builtin">:around</span> #'org-html-table
      (<span class="keyword">if</span> (<span class="keyword">or</span> (not org-fancy-html-export-mode) (<span class="keyword">bound-and-true-p</span> org-msg-export-in-progress))
          (funcall orig-fn table contents info)
        (<span class="keyword">let*</span> ((name (plist-get (cadr table) <span class="builtin">:name</span>))
               (ref (org-export-get-reference table info)))
          (format <span class="string">"&lt;div id='%s' class='table'&gt;
    &lt;div class='gutter'&gt;&lt;a href='#%s'&gt;#&lt;/a&gt;&lt;/div&gt;
    &lt;div class='tabular'&gt;
    %s
    &lt;/div&gt;\
    &lt;/div&gt;"</span>
                  ref ref
                  (<span class="keyword">if</span> name
                      (replace-regexp-in-string (format <span class="string">"&lt;table id=\"%s\""</span> ref) <span class="string">"&lt;table"</span>
                                                (funcall orig-fn table contents info))
                    (funcall orig-fn table contents info))))))
    (<span class="keyword">defadvice!</span> org-html--format-toc-headline-colapseable (orig-fn headline info)
      <span class="doc">"Add a label and checkbox to `</span><span class="doc"><span class="constant">org-html--format-toc-headline</span></span><span class="doc">'s usual output,
    to allow the TOC to be a collapseable tree."</span>
      <span class="builtin">:around</span> #'org-html--format-toc-headline
      (<span class="keyword">if</span> (<span class="keyword">or</span> (not org-fancy-html-export-mode) (<span class="keyword">bound-and-true-p</span> org-msg-export-in-progress))
          (funcall orig-fn headline info)
        (<span class="keyword">let</span> ((id (<span class="keyword">or</span> (org-element-property <span class="builtin">:CUSTOM_ID</span> headline)
                      (org-export-get-reference headline info))))
          (format <span class="string">"&lt;input type='checkbox' id='toc--%s'/&gt;&lt;label for='toc--%s'&gt;%s&lt;/label&gt;"</span>
                  id id (funcall orig-fn headline info)))))
    (<span class="keyword">defadvice!</span> org-html--toc-text-stripped-leaves (orig-fn toc-entries)
      <span class="doc">"Remove label"</span>
      <span class="builtin">:around</span> #'org-html--toc-text
      (<span class="keyword">if</span> (<span class="keyword">or</span> (not org-fancy-html-export-mode) (<span class="keyword">bound-and-true-p</span> org-msg-export-in-progress))
          (funcall orig-fn toc-entries)
        (replace-regexp-in-string <span class="string">"&lt;input [</span><span class="string"><span class="negation-char">^</span></span><span class="string">&gt;]+&gt;&lt;label [</span><span class="string"><span class="negation-char">^</span></span><span class="string">&gt;]+&gt;</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">.+?</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">&lt;/label&gt;&lt;/li&gt;"</span> <span class="string">"\\1&lt;/li&gt;"</span>
                                  (funcall orig-fn toc-entries))))
    (<span class="keyword">setq</span> org-html-text-markup-alist
          '((bold . <span class="string">"&lt;b&gt;%s&lt;/b&gt;"</span>)
            (code . <span class="string">"&lt;code&gt;%s&lt;/code&gt;"</span>)
            (italic . <span class="string">"&lt;i&gt;%s&lt;/i&gt;"</span>)
            (strike-through . <span class="string">"&lt;del&gt;%s&lt;/del&gt;"</span>)
            (underline . <span class="string">"&lt;span class=\"underline\"&gt;%s&lt;/span&gt;"</span>)
            (verbatim . <span class="string">"&lt;kbd&gt;%s&lt;/kbd&gt;"</span>)))
    (<span class="keyword">appendq!</span> org-html-checkbox-types
              '((html-span
                 (on . <span class="string">"&lt;span class='checkbox'&gt;&lt;/span&gt;"</span>)
                 (off . <span class="string">"&lt;span class='checkbox'&gt;&lt;/span&gt;"</span>)
                 (trans . <span class="string">"&lt;span class='checkbox'&gt;&lt;/span&gt;"</span>))))
    (<span class="keyword">setq</span> org-html-checkbox-type 'html-span)
    (<span class="keyword">defun</span> <span class="function-name">org-export-html-headline-anchor</span> (text backend info)
      (<span class="keyword">when</span> (<span class="keyword">and</span> (org-export-derived-backend-p backend 'html)
                 org-fancy-html-export-mode)
        (<span class="keyword">unless</span> (<span class="keyword">bound-and-true-p</span> org-msg-export-in-progress)
          (replace-regexp-in-string
           <span class="string">"&lt;h</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[0-9]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string"> id=\"</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[a-z0-9-]+</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">\"&gt;</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">.*[</span><span class="string"><span class="negation-char">^</span></span><span class="string"> ]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">&lt;\\/h[0-9]&gt;"</span> <span class="comment-delimiter">; </span><span class="comment">this is quite restrictive, but due to `</span><span class="comment"><span class="constant">org-reference-contraction</span></span><span class="comment">' I can do this
</span>           <span class="string">"&lt;h\\1 id=\"\\2\"&gt;\\3&lt;a aria-hidden=\"true\" href=\"#\\2\"&gt;#&lt;/a&gt; &lt;/h\\1&gt;"</span>
           text))))
    
    (add-to-list 'org-export-filter-headline-functions
                 'org-export-html-headline-anchor)
    <span class="comment-delimiter">;; </span><span class="comment">(setq-default org-html-with-latex `dvisvgm)
</span>    (<span class="keyword">setq</span> org-html-mathjax-options
          '((path <span class="string">"https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"</span> )
            (scale <span class="string">"1"</span>)
            (autonumber <span class="string">"ams"</span>)
            (multlinewidth <span class="string">"85%"</span>)
            (tagindent <span class="string">".8em"</span>)
            (tagside <span class="string">"right"</span>)))
    
    (<span class="keyword">setq</span> org-html-mathjax-template
          <span class="string">"&lt;script&gt;
    MathJax = {
      chtml: {
        scale: %SCALE
      },
      svg: {
        scale: %SCALE,
        fontCache: \"global\"
      },
      tex: {
        tags: \"%AUTONUMBER\",
        multlineWidth: \"%MULTLINEWIDTH\",
        tagSide: \"%TAGSIDE\",
        tagIndent: \"%TAGINDENT\"
      }
    };
    &lt;/script&gt;
    &lt;script id=\"MathJax-script\" async
            src=\"%PATH\"&gt;&lt;/script&gt;"</span>)
  )
  <span class="comment-delimiter">;; </span><span class="comment">org-latex-compilers = ("pdflatex" "xelatex" "lualatex"), which are the possible values for %latex
</span>  (<span class="keyword">setq</span> org-latex-pdf-process '(<span class="string">"latexmk -%latex -shell-escape -interaction=nonstopmode -f -pdf -output-directory=%o %f"</span>))
  (<span class="keyword">defun</span> <span class="function-name">org-export-filter-text-acronym</span> (text backend _info)
    <span class="doc">"Wrap suspected acronyms in acronyms-specific formatting.
  Treat sequences of 2+ capital letters (optionally succeeded by \"s\") as an acronym.
  Ignore if preceeded by \";\" (for manual prevention) or \"\\\" (for LaTeX commands). "</span>
    (<span class="keyword">let</span> ((base-backend
           (<span class="keyword">cond</span>
            ((org-export-derived-backend-p backend 'latex) 'latex)
            <span class="comment-delimiter">;; </span><span class="comment">Markdown is derived from HTML, but we don't want to format it
</span>            ((org-export-derived-backend-p backend 'md) nil)
            ((org-export-derived-backend-p backend 'html) 'html)))
          (case-fold-search nil))
      (<span class="keyword">when</span> base-backend
        (replace-regexp-in-string
         <span class="string">"[;\\\\]?\\b[A-Z][A-Z]+s?[</span><span class="string"><span class="negation-char">^</span></span><span class="string">A-Z]"</span>
         (<span class="keyword">lambda</span> (all-caps-str)
           <span class="comment-delimiter">;; </span><span class="comment">only format as acronym if str doesn't start with ";" or "\" (for LaTeX commands)
</span>           (<span class="keyword">cond</span> ((equal (aref all-caps-str <span class="highlight-numbers-number">0</span>) ?\;) (substring all-caps-str <span class="highlight-numbers-number">1</span>))
                 ((equal (aref all-caps-str <span class="highlight-numbers-number">0</span>) ?\\) all-caps-str)
                 (t (<span class="keyword">let*</span> ((trailing-s (<span class="keyword">when</span> (equal (aref all-caps-str (- (length all-caps-str) <span class="highlight-numbers-number">2</span>)) ?s)
                                         (<span class="keyword">pcase</span> base-backend
                                           ('latex <span class="string">"\\protect\\scalebox{.91}[.84]{s}"</span>)
                                           ('html <span class="string">"&lt;small&gt;s&lt;/small&gt;"</span>))))
                           (acr (substring all-caps-str <span class="highlight-numbers-number">0</span> (<span class="keyword">if</span> trailing-s <span class="highlight-numbers-number">-2</span> <span class="highlight-numbers-number">-1</span>)))
                           (final-char (substring all-caps-str <span class="highlight-numbers-number">-1</span>)))
                      (<span class="keyword">pcase</span> base-backend
                        ('latex (concat <span class="string">"\\textls*[70]{\\textsc{"</span> (s-downcase acr) <span class="string">"}"</span> trailing-s <span class="string">"}"</span> final-char))
                        ('html (concat <span class="string">"&lt;span class='acr'&gt;"</span> acr <span class="string">"&lt;/span&gt;"</span> trailing-s final-char)))))))
         text t t))))
  
  (add-to-list 'org-export-filter-plain-text-functions
               #'org-export-filter-text-acronym)
  
  <span class="comment-delimiter">;; </span><span class="comment">We won't use `</span><span class="comment"><span class="constant">org-export-filter-headline-functions</span></span><span class="comment">' because it
</span>  <span class="comment-delimiter">;; </span><span class="comment">passes (and formats) the entire section contents. That's no good.
</span>  
  (<span class="keyword">defun</span> <span class="function-name">org-html-format-headline-acronymised</span> (todo todo-type priority text tags info)
    <span class="doc">"Like `</span><span class="doc"><span class="constant">org-html-format-headline-default-function</span></span><span class="doc">', but with acronym formatting."</span>
    (org-html-format-headline-default-function
     todo todo-type priority (org-export-filter-text-acronym text 'html info) tags info))
  (<span class="keyword">setq</span> org-html-format-headline-function #'org-html-format-headline-acronymised)
  
  (<span class="keyword">defun</span> <span class="function-name">org-latex-format-headline-acronymised</span> (todo todo-type priority text tags info)
    <span class="doc">"Like `</span><span class="doc"><span class="constant">org-latex-format-headline-default-function</span></span><span class="doc">', but with acronym formatting."</span>
    (org-latex-format-headline-default-function
     todo todo-type priority (org-export-filter-text-acronym text 'latex info) tags info))
  (<span class="keyword">setq</span> org-latex-format-headline-function #'org-latex-format-headline-acronymised)
  (<span class="keyword">defun</span> <span class="function-name">+org-export-latex-fancy-item-checkboxes</span> (text backend info)
    (<span class="keyword">when</span> (org-export-derived-backend-p backend 'latex)
      (replace-regexp-in-string
       <span class="string">"\\\\item\\[{$\\\\</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">\\w+</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">$}\\]"</span>
       (<span class="keyword">lambda</span> (fullmatch)
         (concat <span class="string">"\\\\item["</span> (<span class="keyword">pcase</span> (substring fullmatch <span class="highlight-numbers-number">9</span> <span class="highlight-numbers-number">-3</span>) <span class="comment-delimiter">; </span><span class="comment">content of capture group
</span>                               (<span class="string">"square"</span>   <span class="string">"\\\\ifdefined\\\\checkboxUnchecked\\\\checkboxUnchecked\\\\else$\\\\square$\\\\fi"</span>    )
                               (<span class="string">"boxminus"</span> <span class="string">"\\\\ifdefined\\\\checkboxTransitive\\\\checkboxTransitive\\\\else$\\\\boxminus$\\\\fi"</span>)
                               (<span class="string">"boxtimes"</span> <span class="string">"\\\\ifdefined\\\\checkboxChecked\\\\checkboxChecked\\\\else$\\\\boxtimes$\\\\fi"</span>      )
                               (_ (substring fullmatch <span class="highlight-numbers-number">9</span> <span class="highlight-numbers-number">-3</span>))) <span class="string">"]"</span>))
       text)))
  
  (add-to-list 'org-export-filter-item-functions
               '+org-export-latex-fancy-item-checkboxes)
  (<span class="keyword">after!</span> ox-latex
    (add-to-list 'org-latex-classes
                 '(<span class="string">"fancy-article"</span>
                   <span class="string">"\\documentclass{scrartcl}\n
  \\usepackage[T1]{fontenc}\n\
  \\usepackage[osf,largesc,helvratio=0.9]{newpxtext}\n\
  \\usepackage[scale=0.9]{sourcecodepro}\n\
  \\usepackage{bmc-maths}\n\
  
  \\usepackage[activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=true,factor=2000]{microtype}\n\
  \\usepackage{xcolor}\n\
  \\usepackage{booktabs}
  
  \\usepackage{subcaption}
  \\usepackage[hypcap=true]{caption}
  \\setkomafont{caption}{\\sffamily\\small}
  \\setkomafont{captionlabel}{\\upshape\\bfseries}
  \\captionsetup{justification=raggedright,singlelinecheck=true}
  \\setcapindent{0pt}
  
  \\setlength{\\parskip}{\\baselineskip}\n\
  \\setlength{\\parindent}{0pt}\n\
  
  \\AtBeginEnvironment{quote}{\\itshape}
  
  \\usepackage{pifont}
  \\newcommand{\\checkboxUnchecked}{$\\square$}
  \\newcommand{\\checkboxTransitive}{\\rlap{\\raisebox{-0.1ex}{\\hspace{0.35ex}\\Large\\textbf -}}$\\square$}
  \\newcommand{\\checkboxChecked}{\\rlap{\\raisebox{0.2ex}{\\hspace{0.35ex}\\scriptsize \\ding{52}}}$\\square$}
  
  % args = #1 Name, #2 Colour, #3 Ding, #4 Label
  \\newcommand{\\defsimplebox}[4]{%
    \\definecolor{#1}{HTML}{#2}
    \\newenvironment{#1}
    {%
      \\par \\vspace{-0.7\\baselineskip}%
      \\textcolor{#1}{#3} \\textcolor{#1}{\\textbf{#4}}%
      \\vspace{-0.8\\baselineskip}
      \\begin{addmargin}[1em]{1em}
    }{%
      \\end{addmargin}
      \\vspace{-0.5\\baselineskip}
    }%
  }
  \\defsimplebox{warning}{e66100}{\\ding{68}}{Warning}
  \\defsimplebox{info}{3584e4}{\\ding{68}}{Information}
  \\defsimplebox{success}{26a269}{\\ding{68}}{\\vspace{-\\baselineskip}}
  \\defsimplebox{error}{c01c28}{\\ding{68}}{Important}
  "</span>
                   (<span class="string">"\\section{%s}"</span> . <span class="string">"\\section*{%s}"</span>)
                   (<span class="string">"\\subsection{%s}"</span> . <span class="string">"\\subsection*{%s}"</span>)
                   (<span class="string">"\\subsubsection{%s}"</span> . <span class="string">"\\subsubsection*{%s}"</span>)
                   (<span class="string">"\\paragraph{%s}"</span> . <span class="string">"\\paragraph*{%s}"</span>)
                   (<span class="string">"\\subparagraph{%s}"</span> . <span class="string">"\\subparagraph*{%s}"</span>)))
    (add-to-list 'org-latex-classes
                 '(<span class="string">"blank"</span>
                   <span class="string">"[NO-DEFAULT-PACKAGES]
                 [NO-PACKAGES]
                 [EXTRA]"</span>
                   (<span class="string">"\\section{%s}"</span> . <span class="string">"\\section*{%s}"</span>)
                   (<span class="string">"\\subsection{%s}"</span> . <span class="string">"\\subsection*{%s}"</span>)
                   (<span class="string">"\\subsubsection{%s}"</span> . <span class="string">"\\subsubsection*{%s}"</span>)
                   (<span class="string">"\\paragraph{%s}"</span> . <span class="string">"\\paragraph*{%s}"</span>)
                   (<span class="string">"\\subparagraph{%s}"</span> . <span class="string">"\\subparagraph*{%s}"</span>)))
    (add-to-list 'org-latex-classes
                 '(<span class="string">"bmc-article"</span>
                   <span class="string">"\\documentclass[article,code,maths]{bmc}
                 [NO-DEFAULT-PACKAGES]
                 [NO-PACKAGES]
                 [EXTRA]"</span>
                   (<span class="string">"\\section{%s}"</span> . <span class="string">"\\section*{%s}"</span>)
                   (<span class="string">"\\subsection{%s}"</span> . <span class="string">"\\subsection*{%s}"</span>)
                   (<span class="string">"\\subsubsection{%s}"</span> . <span class="string">"\\subsubsection*{%s}"</span>)
                   (<span class="string">"\\paragraph{%s}"</span> . <span class="string">"\\paragraph*{%s}"</span>)
                   (<span class="string">"\\subparagraph{%s}"</span> . <span class="string">"\\subparagraph*{%s}"</span>)))
    (add-to-list 'org-latex-classes
                 '(<span class="string">"bmc"</span>
                   <span class="string">"\\documentclass[code,maths]{bmc}
                 [NO-DEFAULT-PACKAGES]
                 [NO-PACKAGES]
                 [EXTRA]"</span>
                   (<span class="string">"\\chapter{%s}"</span> . <span class="string">"\\chapter*{%s}"</span>)
                   (<span class="string">"\\section{%s}"</span> . <span class="string">"\\section*{%s}"</span>)
                   (<span class="string">"\\subsection{%s}"</span> . <span class="string">"\\subsection*{%s}"</span>)
                   (<span class="string">"\\subsubsection{%s}"</span> . <span class="string">"\\subsubsection*{%s}"</span>)
                   (<span class="string">"\\paragraph{%s}"</span> . <span class="string">"\\paragraph*{%s}"</span>)
                   (<span class="string">"\\subparagraph{%s}"</span> . <span class="string">"\\subparagraph*{%s}"</span>))))
  
  (<span class="keyword">setq</span> org-latex-default-class <span class="string">"fancy-article"</span>
        org-latex-tables-booktabs t
        org-latex-hyperref-template <span class="string">"
  \\colorlet{greenyblue}{blue!70!green}
  \\colorlet{blueygreen}{blue!40!green}
  \\providecolor{link}{named}{greenyblue}
  \\providecolor{cite}{named}{blueygreen}
  \\hypersetup{
    pdfauthor={%a},
    pdftitle={%t},
    pdfkeywords={%k},
    pdfsubject={%d},
    pdfcreator={%c},
    pdflang={%L},
    breaklinks=true,
    colorlinks=true,
    linkcolor=,
    urlcolor=link,
    citecolor=cite\n}
  \\urlstyle{same}
  "</span>)
  (<span class="keyword">defvar</span> <span class="variable-name">org-latex-universal-preamble</span> <span class="string">"
  \\usepackage[main,include]{embedall}
  \\IfFileExists{./\\jobname.org}{\\embedfile[desc=The original file]{\\jobname.org}}{}
  "</span>
    <span class="doc">"Preamble to be included in every export."</span>)
  
  (<span class="keyword">defvar</span> <span class="variable-name">org-latex-conditional-preambles</span>
    `((t . org-latex-universal-preamble)
      (<span class="string">"\\[\\[</span><span class="string"><span class="constant">file:.*\\.svg\\</span></span><span class="string">]\\]"</span> . <span class="string">"\\usepackage{svg}"</span>))
    <span class="doc">"Snippets which are conditionally included in the preamble of a LaTeX export.
  
  Alist where when the car results in a non-nil value, the cdr is inserted in
  the preamble.  The car may be a:
  - string, which is used as a regex search in the buffer
  - symbol, the value of which used
  - function, the result of the function is used
  
  The cdr may be a:
  - string, which is inserted without processing
  - symbol, the value of which is inserted
  - function, the result of which is inserted"</span>)
  
  (<span class="keyword">defadvice!</span> org-latex-header-smart-preamble (orig-fn tpl def-pkg pkg snippets-p <span class="type">&amp;optional</span> extra)
    <span class="doc">"Dynamically insert preamble content based on `</span><span class="doc"><span class="constant">org-latex-conditional-preambles</span></span><span class="doc">'."</span>
    <span class="builtin">:around</span> #'org-splice-latex-header
    (<span class="keyword">let</span> ((header (funcall orig-fn tpl def-pkg pkg snippets-p extra)))
      (<span class="keyword">if</span> snippets-p header
        (concat header
                (mapconcat (<span class="keyword">lambda</span> (term-preamble)
                             (<span class="keyword">when</span> (<span class="keyword">pcase</span> (car term-preamble)
                                     ((pred stringp) (<span class="keyword">save-excursion</span>
                                                         (goto-char (point-min))
                                                         (search-forward-regexp (car term-preamble) nil t)))
                                     ((pred functionp) (funcall (car term-preamble)))
                                     ((pred symbolp) (symbol-value (car term-preamble)))
                                     (_ (<span class="warning-1">user-error</span> <span class="string">"org-latex-conditional-preambles key %s unable to be used"</span> (car term-preamble))))
                               (<span class="keyword">pcase</span> (cdr term-preamble)
                                 ((pred stringp) (cdr term-preamble))
                                 ((pred functionp) (funcall (cdr term-preamble)))
                                 ((pred symbolp) (symbol-value (cdr term-preamble)))
                                 (_ (<span class="warning-1">user-error</span> <span class="string">"org-latex-conditional-preambles value %s unable to be used"</span> (cdr term-preamble))))))
                           org-latex-conditional-preambles
                           <span class="string">"\n"</span>)))))
  (<span class="keyword">setq</span> org-latex-listings 'engraved) <span class="comment-delimiter">; </span><span class="bold"><span class="success">NOTE</span></span><span class="comment"> non-standard value
</span>  (<span class="keyword">defadvice!</span> org-latex-src-block-engraved (orig-fn src-block contents info)
    <span class="doc">"Like `</span><span class="doc"><span class="constant">org-latex-src-block</span></span><span class="doc">', but supporting an engraved backend"</span>
    <span class="builtin">:around</span> #'org-latex-src-block
    (<span class="keyword">if</span> (eq 'engraved (plist-get info <span class="builtin">:latex-listings</span>))
        (org-latex-scr-block--engraved src-block contents info)
      (funcall orig-fn src-block contents info)))
  
  (<span class="keyword">defadvice!</span> org-latex-inline-src-block-engraved (orig-fn inline-src-block contents info)
    <span class="doc">"Like `</span><span class="doc"><span class="constant">org-latex-inline-src-block</span></span><span class="doc">', but supporting an engraved backend"</span>
    <span class="builtin">:around</span> #'org-latex-inline-src-block
    (<span class="keyword">if</span> (eq 'engraved (plist-get info <span class="builtin">:latex-listings</span>))
        (org-latex-inline-scr-block--engraved inline-src-block contents info)
      (funcall orig-fn src-block contents info)))
  
  (<span class="keyword">setq</span> org-latex-engraved-code-preamble <span class="string">"
  \\usepackage{fvextra}
  \\fvset{
    commandchars=\\\\\\{\\},
    highlightcolor=white!95!black!80!blue,
    breaklines=true,
    breaksymbol=\\color{white!60!black}\\tiny\\ensuremath{\\hookrightarrow}}
  \\renewcommand\\theFancyVerbLine{\\footnotesize\\color{black!40!white}\\arabic{FancyVerbLine}}
  
  % </span><span class="bold"><span class="warning">TODO</span></span><span class="string"> have code boxes keep line vertical alignment
  \\usepackage[breakable,xparse]{tcolorbox}
  \\DeclareTColorBox[]{Code}{o}%
  {colback=white!97!black, colframe=white!94!black,
    fontupper=\\color{EFD}\\footnotesize,
    IfNoValueTF={#1}%
    {boxsep=2pt, arc=2.5pt, outer arc=2.5pt,
      boxrule=0.5pt, left=2pt}%
    {boxsep=2.5pt, arc=0pt, outer arc=0pt,
      boxrule=0pt, leftrule=1.5pt, left=0.5pt},
    right=2pt, top=1pt, bottom=0.5pt,
    breakable}
  "</span>)
  
  (add-to-list 'org-latex-conditional-preambles '(<span class="string">"#\\+BEGIN_SRC</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">|</span></span><span class="string">#\\+begin_src"</span> . org-latex-engraved-code-preamble) t)
  (add-to-list 'org-latex-conditional-preambles '(<span class="string">"#\\+BEGIN_SRC</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">|</span></span><span class="string">#\\+begin_src"</span> . engrave-faces-latex-gen-preamble) t)
  
  (<span class="keyword">defun</span> <span class="function-name">org-latex-scr-block--engraved</span> (src-block contents info)
    (<span class="keyword">let*</span> ((lang (org-element-property <span class="builtin">:language</span> src-block))
           (attributes (org-export-read-attribute <span class="builtin">:attr_latex</span> src-block))
           (float (plist-get attributes <span class="builtin">:float</span>))
           (num-start (org-export-get-loc src-block info))
           (retain-labels (org-element-property <span class="builtin">:retain-labels</span> src-block))
           (caption (org-element-property <span class="builtin">:caption</span> src-block))
           (caption-above-p (org-latex--caption-above-p src-block info))
           (caption-str (org-latex--caption/label-string src-block info))
           (placement (<span class="keyword">or</span> (org-unbracket-string <span class="string">"["</span> <span class="string">"]"</span> (plist-get attributes <span class="builtin">:placement</span>))
                          (plist-get info <span class="builtin">:latex-default-figure-position</span>)))
           (float-env
            (<span class="keyword">cond</span>
             ((string= <span class="string">"multicolumn"</span> float)
              (format <span class="string">"\\begin{listing*}[%s]\n%s%%s\n%s\\end{listing*}"</span>
                      placement
                      (<span class="keyword">if</span> caption-above-p caption-str <span class="string">""</span>)
                      (<span class="keyword">if</span> caption-above-p <span class="string">""</span> caption-str)))
             (caption
              (format <span class="string">"\\begin{listing}[%s]\n%s%%s\n%s\\end{listing}"</span>
                      placement
                      (<span class="keyword">if</span> caption-above-p caption-str <span class="string">""</span>)
                      (<span class="keyword">if</span> caption-above-p <span class="string">""</span> caption-str)))
             ((string= <span class="string">"t"</span> float)
              (concat (format <span class="string">"\\begin{listing}[%s]\n"</span>
                              placement)
                      <span class="string">"%s\n\\end{listing}"</span>))
             (t <span class="string">"%s"</span>)))
           (options (plist-get info <span class="builtin">:latex-minted-options</span>))
           (content-buffer
            (<span class="keyword">with-temp-buffer</span>
              (insert
               (<span class="keyword">let*</span> ((code-info (org-export-unravel-code src-block))
                      (max-width
                       (apply 'max
                              (mapcar 'length
                                      (org-split-string (car code-info)
                                                        <span class="string">"\n"</span>)))))
                 (org-export-format-code
                  (car code-info)
                  (<span class="keyword">lambda</span> (loc _num ref)
                    (concat
                     loc
                     (<span class="keyword">when</span> ref
                       <span class="comment-delimiter">;; </span><span class="comment">Ensure references are flushed to the right,
</span>                       <span class="comment-delimiter">;; </span><span class="comment">separated with 6 spaces from the widest line
</span>                       <span class="comment-delimiter">;; </span><span class="comment">of code.
</span>                       (concat (make-string (+ (- max-width (length loc)) <span class="highlight-numbers-number">6</span>)
                                            ?\s)
                               (format <span class="string">"(%s)"</span> ref)))))
                  nil (<span class="keyword">and</span> retain-labels (cdr code-info)))))
              (funcall (org-src-get-lang-mode lang))
              (engrave-faces-latex-buffer)))
           (content
            (<span class="keyword">with-current-buffer</span> content-buffer
              (buffer-string)))
           (body
            (format
             <span class="string">"\\begin{Code}\n\\begin{Verbatim}[%s]\n%s\\end{Verbatim}\n\\end{Code}"</span>
             <span class="comment-delimiter">;; </span><span class="comment">Options.
</span>             (concat
              (org-latex--make-option-string
               (<span class="keyword">if</span> (<span class="keyword">or</span> (not num-start) (assoc <span class="string">"linenos"</span> options))
                   options
                 (append
                  `((<span class="string">"linenos"</span>)
                    (<span class="string">"firstnumber"</span> ,(number-to-string (1+ num-start))))
                  options)))
              (<span class="keyword">let</span> ((local-options (plist-get attributes <span class="builtin">:options</span>)))
                (<span class="keyword">and</span> local-options (concat <span class="string">","</span> local-options))))
             content)))
      (kill-buffer content-buffer)
      <span class="comment-delimiter">;; </span><span class="comment">Return value.
</span>      (format float-env body)))
  
  (<span class="keyword">defun</span> <span class="function-name">org-latex-inline-scr-block--engraved</span> (inline-src-block _contents info)
    (<span class="keyword">let</span> ((options (org-latex--make-option-string
                    (plist-get info <span class="builtin">:latex-minted-options</span>)))
          code-buffer code)
      (<span class="keyword">setq</span> code-buffer
            (<span class="keyword">with-temp-buffer</span>
              (insert (org-element-property <span class="builtin">:value</span> inline-src-block))
              (funcall (org-src-get-lang-mode
                        (org-element-property <span class="builtin">:language</span> inline-src-block)))
              (engrave-faces-latex-buffer)))
      (<span class="keyword">setq</span> code (<span class="keyword">with-current-buffer</span> code-buffer
                   (buffer-string)))
      (kill-buffer code-buffer)
      (format <span class="string">"\\Verb%s{%s}"</span>
              (<span class="keyword">if</span> (string= options <span class="string">""</span>) <span class="string">""</span>
                (format <span class="string">"[%s]"</span> options))
              code)))
  (<span class="keyword">defadvice!</span> org-latex-example-block-engraved (orig-fn example-block contents info)
    <span class="doc">"Like `</span><span class="doc"><span class="constant">org-latex-example-block</span></span><span class="doc">', but supporting an engraved backend"</span>
    <span class="builtin">:around</span> #'org-latex-example-block
    (<span class="keyword">let</span> ((output-block (funcall orig-fn example-block contents info)))
      (<span class="keyword">if</span> (eq 'engraved (plist-get info <span class="builtin">:latex-listings</span>))
          (format <span class="string">"\\begin{Code}[alt]\n%s\n\\end{Code}"</span> output-block)
        output-block)))
  (<span class="keyword">defun</span> <span class="function-name">+org-latex-replace-non-ascii-chars</span> (text backend info)
    <span class="doc">"Replace non-ascii chars with \\char\"XYZ forms."</span>
    (<span class="keyword">when</span> (<span class="keyword">and</span> (org-export-derived-backend-p backend 'latex)
               (string= (plist-get info <span class="builtin">:latex-compiler</span>) <span class="string">"pdflatex"</span>))
      (replace-regexp-in-string <span class="string">"[</span><span class="string"><span class="negation-char">^</span></span><span class="string">[:ascii:]]"</span> <span class="string">"&#194;&#191;"</span> text)))
  
  (add-to-list 'org-export-filter-final-output-functions #'+org-latex-replace-non-ascii-chars)
  (<span class="keyword">defadvice!</span> +org-latex-link (orig-fn link desc info)
    <span class="doc">"Acts as `</span><span class="doc"><span class="constant">org-latex-link</span></span><span class="doc">', but supports remote images."</span>
    <span class="builtin">:around</span> #'org-latex-link
    (<span class="keyword">setq</span> o-link link
          o-desc desc
          o-info info)
    (<span class="keyword">if</span> (<span class="keyword">and</span> (member (plist-get (cadr link) <span class="builtin">:type</span>) '(<span class="string">"http"</span> <span class="string">"https"</span>))
             (member (file-name-extension (plist-get (cadr link) <span class="builtin">:path</span>))
                     '(<span class="string">"png"</span> <span class="string">"jpg"</span> <span class="string">"jpeg"</span> <span class="string">"pdf"</span> <span class="string">"svg"</span>)))
        (org-latex-link--remote link desc info)
      (funcall orig-fn link desc info)))
  
  (<span class="keyword">defun</span> <span class="function-name">org-latex-link--remote</span> (link _desc info)
    (<span class="keyword">let*</span> ((url (plist-get (cadr link) <span class="builtin">:raw-link</span>))
           (ext (file-name-extension url))
           (target (format <span class="string">"%s%s.%s"</span>
                           (temporary-file-directory)
                           (replace-regexp-in-string <span class="string">"[./]"</span> <span class="string">"-"</span>
                                                     (file-name-sans-extension (substring (plist-get (cadr link) <span class="builtin">:path</span>) <span class="highlight-numbers-number">2</span>)))
                           ext)))
      (<span class="keyword">unless</span> (file-exists-p target)
        (url-copy-file url target))
      (setcdr link (<span class="keyword">--&gt;</span> (cadr link)
                     (plist-put it <span class="builtin">:type</span> <span class="string">"file"</span>)
                     (plist-put it <span class="builtin">:path</span> target)
                     (plist-put it <span class="builtin">:raw-link</span> (concat <span class="string">"file:"</span> target))
                     (list it)))
      (concat <span class="string">"% fetched from "</span> url <span class="string">"\n"</span>
              (org-latex--inline-image link info))))
  (<span class="keyword">after!</span> ox
    (<span class="keyword">defvar</span> <span class="variable-name">ox-chameleon-base-class</span> <span class="string">"fancy-article"</span>
      <span class="doc">"The base class that chameleon builds on"</span>)
  
    (<span class="keyword">defvar</span> <span class="variable-name">ox-chameleon--p</span> nil
      <span class="doc">"Used to indicate whether the current export is trying to blend in. Set just before being accessed."</span>)
  
    <span class="comment-delimiter">;; </span><span class="comment">(setf (alist-get :filter-latex-class
</span>    <span class="comment-delimiter">;;                  </span><span class="comment">(org-export-backend-filters
</span>    <span class="comment-delimiter">;;                   </span><span class="comment">(org-export-get-backend 'latex)))
</span>    <span class="comment-delimiter">;;       </span><span class="comment">'ox-chameleon-latex-class-detector-filter)
</span>  
    <span class="comment-delimiter">;; </span><span class="comment">(defun ox-chameleon-latex-class-detector-filter (info backend)
</span>    <span class="comment-delimiter">;;   </span><span class="comment">""
</span>    <span class="comment-delimiter">;;   </span><span class="comment">(setq ox-chameleon--p (when (equal (plist-get info :latex-class)
</span>    <span class="comment-delimiter">;;                                      </span><span class="comment">"chameleon")
</span>    <span class="comment-delimiter">;;                           </span><span class="comment">(plist-put info :latex-class ox-chameleon-base-class)
</span>    <span class="comment-delimiter">;;                           </span><span class="comment">t)))
</span>  
    <span class="comment-delimiter">;; </span><span class="bold"><span class="warning">TODO</span></span><span class="comment"> make this less hacky. One ideas was as follows
</span>    <span class="comment-delimiter">;; </span><span class="comment">(map-put (org-export-backend-filters (org-export-get-backend 'latex))
</span>    <span class="comment-delimiter">;;           </span><span class="comment">:filter-latex-class 'ox-chameleon-latex-class-detector-filter))
</span>    <span class="comment-delimiter">;; </span><span class="comment">Never seemed to execute though
</span>    (<span class="keyword">defadvice!</span> ox-chameleon-org-latex-detect (orig-fun info)
      <span class="builtin">:around</span> #'org-export-install-filters
      (<span class="keyword">setq</span> ox-chameleon--p (<span class="keyword">when</span> (equal (plist-get info <span class="builtin">:latex-class</span>)
                                         <span class="string">"chameleon"</span>)
                              (plist-put info <span class="builtin">:latex-class</span> ox-chameleon-base-class)
                              t))
      (funcall orig-fun info))
  
    (<span class="keyword">defadvice!</span> ox-chameleon-org-latex-export (orig-fn info <span class="type">&amp;optional</span> template snippet?)
      <span class="builtin">:around</span> #'org-latex-make-preamble
      (funcall orig-fn info)
      (<span class="keyword">if</span> (not ox-chameleon--p)
          (funcall orig-fn info template snippet?)
        (concat (funcall orig-fn info template snippet?)
                (ox-chameleon-generate-colourings))))
  
    (<span class="keyword">defun</span> <span class="function-name">ox-chameleon-generate-colourings</span> ()
      (apply #'format
             <span class="string">"%% make document follow Emacs theme
  \\definecolor{bg}{HTML}{%s}
  \\definecolor{fg}{HTML}{%s}
  
  \\definecolor{red}{HTML}{%s}
  \\definecolor{orange}{HTML}{%s}
  \\definecolor{green}{HTML}{%s}
  \\definecolor{teal}{HTML}{%s}
  \\definecolor{yellow}{HTML}{%s}
  \\definecolor{blue}{HTML}{%s}
  \\definecolor{dark-blue}{HTML}{%s}
  \\definecolor{magenta}{HTML}{%s}
  \\definecolor{violet}{HTML}{%s}
  \\definecolor{cyan}{HTML}{%s}
  \\definecolor{dark-cyan}{HTML}{%s}
  
  \\definecolor{level1}{HTML}{%s}
  \\definecolor{level2}{HTML}{%s}
  \\definecolor{level3}{HTML}{%s}
  \\definecolor{level4}{HTML}{%s}
  \\definecolor{level5}{HTML}{%s}
  \\definecolor{level6}{HTML}{%s}
  \\definecolor{level7}{HTML}{%s}
  \\definecolor{level8}{HTML}{%s}
  
  \\definecolor{link}{HTML}{%s}
  \\definecolor{cite}{HTML}{%s}
  \\definecolor{itemlabel}{HTML}{%s}
  \\definecolor{code}{HTML}{%s}
  \\definecolor{verbatim}{HTML}{%s}
  
  \\pagecolor{bg}
  \\color{fg}
  
  \\addtokomafont{section}{\\color{level1}}
  \\newkomafont{sectionprefix}{\\color{level1}}
  \\addtokomafont{subsection}{\\color{level2}}
  \\newkomafont{subsectionprefix}{\\color{level2}}
  \\addtokomafont{subsubsection}{\\color{level3}}
  \\newkomafont{subsubsectionprefix}{\\color{level3}}
  \\addtokomafont{paragraph}{\\color{level4}}
  \\newkomafont{paragraphprefix}{\\color{level4}}
  \\addtokomafont{subparagraph}{\\color{level5}}
  \\newkomafont{subparagraphprefix}{\\color{level5}}
  
  \\renewcommand{\\labelitemi}{\\textcolor{itemlabel}{\\textbullet}}
  \\renewcommand{\\labelitemii}{\\textcolor{itemlabel}{\\normalfont\\bfseries \\textendash}}
  \\renewcommand{\\labelitemiii}{\\textcolor{itemlabel}{\\textasteriskcentered}}
  \\renewcommand{\\labelitemiv}{\\textcolor{itemlabel}{\\textperiodcentered}}
  
  \\renewcommand{\\labelenumi}{\\textcolor{itemlabel}{\\theenumi.}}
  \\renewcommand{\\labelenumii}{\\textcolor{itemlabel}{(\\theenumii)}}
  \\renewcommand{\\labelenumiii}{\\textcolor{itemlabel}{\\theenumiii.}}
  \\renewcommand{\\labelenumiv}{\\textcolor{itemlabel}{\\theenumiv.}}
  
  \\DeclareTextFontCommand{\\texttt}{\\color{code}\\ttfamily}
  \\makeatletter
  \\def\\verbatim@font{\\color{verbatim}\\normalfont\\ttfamily}
  \\makeatother
  %% end customisations
  "</span>
             (mapcar (doom-rpartial #'substring <span class="highlight-numbers-number">1</span>)
                     (list
                      (face-attribute 'solaire-default-face <span class="builtin">:background</span>)
                      (face-attribute 'default <span class="builtin">:foreground</span>)
                      <span class="comment-delimiter">;;</span><span class="comment">
</span>                      (doom-color 'red)
                      (doom-color 'orange)
                      (doom-color 'green)
                      (doom-color 'teal)
                      (doom-color 'yellow)
                      (doom-color 'blue)
                      (doom-color 'dark-blue)
                      (doom-color 'magenta)
                      (doom-color 'violet)
                      (doom-color 'cyan)
                      (doom-color 'dark-cyan)
                      <span class="comment-delimiter">;;</span><span class="comment">
</span>                      (face-attribute 'outline-1 <span class="builtin">:foreground</span>)
                      (face-attribute 'outline-2 <span class="builtin">:foreground</span>)
                      (face-attribute 'outline-3 <span class="builtin">:foreground</span>)
                      (face-attribute 'outline-4 <span class="builtin">:foreground</span>)
                      (face-attribute 'outline-5 <span class="builtin">:foreground</span>)
                      (face-attribute 'outline-6 <span class="builtin">:foreground</span>)
                      (face-attribute 'outline-7 <span class="builtin">:foreground</span>)
                      (face-attribute 'outline-8 <span class="builtin">:foreground</span>)
                      <span class="comment-delimiter">;;</span><span class="comment">
</span>                      (face-attribute 'link <span class="builtin">:foreground</span>)
                      (<span class="keyword">or</span> (face-attribute 'org-ref-cite-face <span class="builtin">:foreground</span>) (doom-color 'yellow))
                      (face-attribute 'org-list-dt <span class="builtin">:foreground</span>)
                      (face-attribute 'org-code <span class="builtin">:foreground</span>)
                      (face-attribute 'org-verbatim <span class="builtin">:foreground</span>)
                      ))))
    )
  (<span class="keyword">setq</span> org-latex-text-markup-alist
        '((bold . <span class="string">"\\textbf{%s}"</span>)
          (code . protectedtexttt)
          (italic . <span class="string">"\\emph{%s}"</span>)
          (strike-through . <span class="string">"\\sout{%s}"</span>)
          (underline . <span class="string">"\\uline{%s}"</span>)
          (verbatim . verb)))
  (<span class="keyword">setq</span> org-beamer-theme <span class="string">"[progressbar=foot]metropolis"</span>)
  
  (<span class="keyword">setq</span> org-beamer-frame-level <span class="highlight-numbers-number">2</span>)
  (<span class="keyword">defadvice!</span> org-md-plain-text-unicode-a (orig-fn text info)
    <span class="doc">"Locally rebind `</span><span class="doc"><span class="constant">org-html-special-string-regexps</span></span><span class="doc">'"</span>
    <span class="builtin">:around</span> #'org-md-plain-text
    (<span class="keyword">let</span> ((org-html-special-string-regexps
           '((<span class="string">"\\\\-"</span> . <span class="string">"-"</span>)
             (<span class="string">"---</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[</span><span class="string"><span class="negation-char">^</span></span><span class="string">-]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">"</span> . <span class="string">"&#226;&#128;&#148;\\1"</span>)
             (<span class="string">"--</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">[</span><span class="string"><span class="negation-char">^</span></span><span class="string">-]</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">)</span></span><span class="string">"</span> . <span class="string">"&#226;&#128;&#147;\\1"</span>)
             (<span class="string">"\\.\\.\\."</span> . <span class="string">"&#226;&#128;&#166;"</span>))))
      (funcall orig-fn text (plist-put info <span class="builtin">:with-smart-quotes</span> nil))))
  (<span class="keyword">after!</span> ox-md
    (<span class="keyword">defun</span> <span class="function-name">org-md-latex-fragment</span> (latex-fragment _contents info)
      <span class="doc">"Transcode a LATEX-FRAGMENT object from Org to Markdown."</span>
      (<span class="keyword">let</span> ((frag (org-element-property <span class="builtin">:value</span> latex-fragment)))
        (<span class="keyword">cond</span>
         ((string-match-p <span class="string">"^\\\\("</span> frag)
          (concat <span class="string">"$"</span> (substring frag <span class="highlight-numbers-number">2</span> <span class="highlight-numbers-number">-2</span>) <span class="string">"$"</span>))
         ((string-match-p <span class="string">"^\\\\\\["</span> frag)
          (concat <span class="string">"$$"</span> (substring frag <span class="highlight-numbers-number">2</span> <span class="highlight-numbers-number">-2</span>) <span class="string">"$$"</span>))
         (t (message <span class="string">"unrecognised fragment: %s"</span> frag)
            frag))))
  
    (<span class="keyword">defun</span> <span class="function-name">org-md-latex-environment</span> (latex-environment contents info)
      <span class="doc">"Transcode a LATEX-ENVIRONMENT object from Org to Markdown."</span>
      (concat <span class="string">"$$\n"</span>
              (org-html-latex-environment latex-environment contents info)
              <span class="string">"$$\n"</span>))
  
    (<span class="keyword">defun</span> <span class="function-name">org-utf8-entity</span> (entity _contents _info)
      <span class="doc">"Transcode an ENTITY object from Org to utf-8.
  CONTENTS are the definition itself.  INFO is a plist holding
  contextual information."</span>
      (org-element-property <span class="builtin">:utf-8</span> entity))
  
    <span class="comment-delimiter">;; </span><span class="comment">We can't let this be immediately parsed and evaluated,
</span>    <span class="comment-delimiter">;; </span><span class="comment">because eager macro-expansion tries to call as-of-yet
</span>    <span class="comment-delimiter">;; </span><span class="comment">undefined functions.
</span>    <span class="comment-delimiter">;; </span><span class="bold"><span class="success">NOTE</span></span><span class="comment"> in the near future this shouldn't be required
</span>    (eval
     '(dolist (extra-transcoder
               '((latex-fragment . org-md-latex-fragment)
                 (latex-environment . org-md-latex-environment)
                 (entity . org-utf8-entity)))
        (<span class="keyword">unless</span> (member extra-transcoder (org-export-backend-transcoders
                                          (org-export-get-backend 'md)))
          (<span class="keyword">push</span> extra-transcoder (org-export-backend-transcoders
                                  (org-export-get-backend 'md)))))))
  (<span class="keyword">setq</span> org-babel-python-command <span class="string">"python3"</span>)
  (<span class="keyword">defun</span> <span class="function-name">tec-org-python</span> ()
    (<span class="keyword">if</span> (eq major-mode 'python-mode)
        (<span class="keyword">progn</span> (anaconda-mode t)
               (company-mode t))))
  (add-hook 'org-src-mode-hook 'tec-org-python)
  (<span class="keyword">setq</span> ess-eval-visibly 'nowait)
  (<span class="keyword">setq</span> ess-R-font-lock-keywords
        '((ess-R-fl-keyword:keywords . t)
          (ess-R-fl-keyword:constants . t)
          (ess-R-fl-keyword:modifiers . t)
          (ess-R-fl-keyword:fun-defs . t)
          (ess-R-fl-keyword:assign-ops . t)
          (ess-R-fl-keyword:%op% . t)
          (ess-fl-keyword:fun-calls . t)
          (ess-fl-keyword:numbers . t)
          (ess-fl-keyword:operators . t)
          (ess-fl-keyword:delimiters . t)
          (ess-fl-keyword:= . t)
          (ess-R-fl-keyword:F&amp;T . t)))
)

(<span class="keyword">setq</span> org-roam-directory <span class="string">"~/Desktop/TEC/Organisation/Roam/"</span>)

<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Compilation][Compilation:1]]
</span>(<span class="keyword">setq</span> TeX-save-query nil
      TeX-show-compilation t
      TeX-command-extra-options <span class="string">"-shell-escape"</span>)
(<span class="keyword">after!</span> latex
  (add-to-list 'TeX-command-list '(<span class="string">"XeLaTeX"</span> <span class="string">"%`xelatex%(mode)%' %t"</span> TeX-run-TeX nil t)))
<span class="comment-delimiter">;; </span><span class="comment">Compilation:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Compilation][Compilation:2]]
</span>(<span class="keyword">setq</span> +latex-viewers '(pdf-tools evince zathura okular skim sumatrapdf))
<span class="comment-delimiter">;; </span><span class="comment">Compilation:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Template][Template:2]]
</span>(<span class="keyword">setq</span> tec/yas-latex-template-preamble <span class="string">"
\\usepackage[pdfa,unicode=true,hidelinks]{hyperref}

\\usepackage[dvipsnames,svgnames,table,hyperref]{xcolor}
\\renewcommand{\\UrlFont}{\\ttfamily\\small}

\\usepackage[a-2b]{pdfx} % why not be archival

\\usepackage[T1]{fontenc}
\\usepackage[osf,helvratio=0.9]{newpxtext} % pallatino
\\usepackage[scale=0.9]{sourcecodepro}

\\usepackage[varbb]{newpxmath}
\\usepackage{mathtools}
\\usepackage{amssymb}

\\usepackage[activate={true,nocompatibility},final,tracking=true,kerning=true,spacing=true,factor=2000]{microtype}
% microtype makes text look nicer

\\usepackage{graphicx} % include graphics
\\usepackage{grffile} % fix allowed graphicx filenames

\\usepackage{booktabs} % nice table rules
"</span>)

(<span class="keyword">defun</span> <span class="function-name">tec/yas-latex-get-class-choice</span> ()
  <span class="doc">"Prompt user for LaTeX class choice"</span>
  (<span class="keyword">setq</span> tec/yas-latex-class-choice (ivy-read <span class="string">"Select document class: "</span> '(<span class="string">"article"</span> <span class="string">"scrartcl"</span> <span class="string">"bmc"</span>) <span class="builtin">:def</span> <span class="string">"bmc"</span>)))

(<span class="keyword">defun</span> <span class="function-name">tec/yas-latex-preamble-if</span> ()
  <span class="doc">"Based on class choice prompt for insertion of default preamble"</span>
  (<span class="keyword">if</span> (equal tec/yas-latex-class-choice <span class="string">"bmc"</span>) 'nil
    (eq (read-char-choice <span class="string">"Include default preamble? [Type y/n]"</span> '(?y ?n)) ?y)))
<span class="comment-delimiter">;; </span><span class="comment">Template:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Deliminators][Deliminators:1]]
</span>(<span class="keyword">after!</span> tex
  (<span class="keyword">defvar</span> <span class="variable-name">tec/tex-last-delim-char</span> nil
    <span class="doc">"Last open delim expanded in a tex document"</span>)
  (<span class="keyword">defvar</span> <span class="variable-name">tec/tex-delim-dot-second</span> t
    <span class="doc">"When the `</span><span class="doc"><span class="constant">tec/tex-last-delim-char</span></span><span class="doc">' is . a second charachter (this) is prompted for"</span>)
  (<span class="keyword">defun</span> <span class="function-name">tec/get-open-delim-char</span> ()
    <span class="doc">"Exclusivly read next char to tec/tex-last-delim-char"</span>
    (<span class="keyword">setq</span> tec/tex-delim-dot-second nil)
    (<span class="keyword">setq</span> tec/tex-last-delim-char (read-char-exclusive <span class="string">"Opening deliminator, recognises: 9 ( [ { &lt; | ."</span>))
    (<span class="keyword">when</span> (eql ?. tec/tex-last-delim-char)
      (<span class="keyword">setq</span> tec/tex-delim-dot-second (read-char-exclusive <span class="string">"Other deliminator, recognises: 0 9 (  ) [ ] { } &lt; &gt; |"</span>))))
  (<span class="keyword">defun</span> <span class="function-name">tec/tex-open-delim-from-char</span> (<span class="type">&amp;optional</span> open-char)
    <span class="doc">"Find the associated opening delim as string"</span>
    (<span class="keyword">unless</span> open-char (<span class="keyword">setq</span> open-char (<span class="keyword">if</span> (eql ?. tec/tex-last-delim-char)
                                          tec/tex-delim-dot-second
                                        tec/tex-last-delim-char)))
    (<span class="keyword">pcase</span> open-char
      (?\( <span class="string">"("</span>)
      (?9  <span class="string">"("</span>)
      (?\[ <span class="string">"["</span>)
      (?\{ <span class="string">"\\{"</span>)
      (?&lt;  <span class="string">"&lt;"</span>)
      (?|  (<span class="keyword">if</span> tec/tex-delim-dot-second <span class="string">"."</span> <span class="string">"|"</span>))
      (_   <span class="string">"."</span>)))
  (<span class="keyword">defun</span> <span class="function-name">tec/tex-close-delim-from-char</span> (<span class="type">&amp;optional</span> open-char)
    <span class="doc">"Find the associated closing delim as string"</span>
    (<span class="keyword">if</span> tec/tex-delim-dot-second
        (<span class="keyword">pcase</span> tec/tex-delim-dot-second
          (?\) <span class="string">")"</span>)
          (?0  <span class="string">")"</span>)
          (?\] <span class="string">"]"</span>)
          (?\} <span class="string">"\\}"</span>)
          (?\&gt; <span class="string">"&gt;"</span>)
          (?|  <span class="string">"|"</span>)
          (_   <span class="string">"."</span>))
      (<span class="keyword">pcase</span> (<span class="keyword">or</span> open-char tec/tex-last-delim-char)
        (?\( <span class="string">")"</span>)
        (?9  <span class="string">")"</span>)
        (?\[ <span class="string">"]"</span>)
        (?\{ <span class="string">"\\}"</span>)
        (?&lt;  <span class="string">"&gt;"</span>)
        (?\) <span class="string">")"</span>)
        (?0  <span class="string">")"</span>)
        (?\] <span class="string">"]"</span>)
        (?\} <span class="string">"\\}"</span>)
        (?\&gt; <span class="string">"&gt;"</span>)
        (?|  <span class="string">"|"</span>)
        (_   <span class="string">"."</span>))))
  (<span class="keyword">defun</span> <span class="function-name">tec/tex-next-char-smart-close-delim</span> (<span class="type">&amp;optional</span> open-char)
    (<span class="keyword">and</span> (<span class="keyword">bound-and-true-p</span> smartparens-mode)
         (eql (char-after) (<span class="keyword">pcase</span> (<span class="keyword">or</span> open-char tec/tex-last-delim-char)
                             (?\( ?\))
                             (?\[ ?\])
                             (?{ ?})
                             (?&lt; ?&gt;)))))
  (<span class="keyword">defun</span> <span class="function-name">tec/tex-delim-yas-expand</span> (<span class="type">&amp;optional</span> open-char)
    (yas-expand-snippet (yas-lookup-snippet <span class="string">"_deliminators"</span> 'latex-mode) (point) (+ (point) (<span class="keyword">if</span> (tec/tex-next-char-smart-close-delim open-char) <span class="highlight-numbers-number">2</span> <span class="highlight-numbers-number">1</span>)))))
<span class="comment-delimiter">;; </span><span class="comment">Deliminators:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Editor visuals][Editor visuals:1]]
</span>(add-hook 'LaTeX-mode-hook #'mixed-pitch-mode)
<span class="comment-delimiter">;; </span><span class="comment">Editor visuals:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Editor visuals][Editor visuals:2]]
</span>(<span class="keyword">after!</span> latex
  (setcar (assoc <span class="string">"&#226;&#139;&#134;"</span> LaTeX-fold-math-spec-list) <span class="string">"&#226;&#152;&#133;"</span>)) <span class="comment-delimiter">;; </span><span class="comment">make \star bigger
</span>
(<span class="keyword">setq</span> TeX-fold-math-spec-list
      `(<span class="comment-delimiter">;; </span><span class="comment">missing/better symbols
</span>        (<span class="string">"&#226;&#137;&#164;"</span> (<span class="string">"le"</span>))
        (<span class="string">"&#226;&#137;&#165;"</span> (<span class="string">"ge"</span>))
        (<span class="string">"&#226;&#137;&#160;"</span> (<span class="string">"ne"</span>))
        <span class="comment-delimiter">;; </span><span class="comment">conviniance shorts -- these don't work nicely ATM
</span>        <span class="comment-delimiter">;; </span><span class="comment">("&#226;&#128;&#185;" ("left"))
</span>        <span class="comment-delimiter">;; </span><span class="comment">("&#226;&#128;&#186;" ("right"))
</span>        <span class="comment-delimiter">;; </span><span class="comment">private macros
</span>        (<span class="string">"&#226;&#132;&#157;"</span> (<span class="string">"RR"</span>))
        (<span class="string">"&#226;&#132;&#149;"</span> (<span class="string">"NN"</span>))
        (<span class="string">"&#226;&#132;&#164;"</span> (<span class="string">"ZZ"</span>))
        (<span class="string">"&#226;&#132;&#154;"</span> (<span class="string">"QQ"</span>))
        (<span class="string">"&#226;&#132;&#130;"</span> (<span class="string">"CC"</span>))
        (<span class="string">"&#226;&#132;&#153;"</span> (<span class="string">"PP"</span>))
        (<span class="string">"&#226;&#132;&#141;"</span> (<span class="string">"HH"</span>))
        (<span class="string">"&#240;&#157;&#148;&#188;"</span> (<span class="string">"EE"</span>))
        (<span class="string">"&#240;&#157;&#145;&#145;"</span> (<span class="string">"dd"</span>))
        <span class="comment-delimiter">;; </span><span class="comment">known commands
</span>        (<span class="string">""</span> (<span class="string">"phantom"</span>))
        (,(<span class="keyword">lambda</span> (num den) (<span class="keyword">if</span> (<span class="keyword">and</span> (TeX-string-single-token-p num) (TeX-string-single-token-p den))
                                (concat num <span class="string">"&#239;&#188;&#143;"</span> den)
                              (concat <span class="string">"&#226;&#157;&#170;"</span> num <span class="string">"&#239;&#188;&#143;"</span> den <span class="string">"&#226;&#157;&#171;"</span>))) (<span class="string">"frac"</span>))
        (,(<span class="keyword">lambda</span> (arg) (concat <span class="string">"&#226;&#136;&#154;"</span> (TeX-fold-parenthesize-as-neccesary arg))) (<span class="string">"sqrt"</span>))
        (,(<span class="keyword">lambda</span> (arg) (concat <span class="string">"&#226;&#173;&#161;"</span> (TeX-fold-parenthesize-as-neccesary arg))) (<span class="string">"vec"</span>))
        (<span class="string">"&#226;&#128;&#152;{1}&#226;&#128;&#153;"</span> (<span class="string">"text"</span>))
        <span class="comment-delimiter">;; </span><span class="comment">private commands
</span>        (<span class="string">"|{1}|"</span> (<span class="string">"abs"</span>))
        (<span class="string">"&#226;&#128;&#150;{1}&#226;&#128;&#150;"</span> (<span class="string">"norm"</span>))
        (<span class="string">"&#226;&#140;&#138;{1}&#226;&#140;&#139;"</span> (<span class="string">"floor"</span>))
        (<span class="string">"&#226;&#140;&#136;{1}&#226;&#140;&#137;"</span> (<span class="string">"ceil"</span>))
        (<span class="string">"&#226;&#140;&#138;{1}&#226;&#140;&#137;"</span> (<span class="string">"round"</span>))
        (<span class="string">"&#240;&#157;&#145;&#145;{1}/&#240;&#157;&#145;&#145;{2}"</span> (<span class="string">"dv"</span>))
        (<span class="string">"&#226;&#136;&#130;{1}/&#226;&#136;&#130;{2}"</span> (<span class="string">"pdv"</span>))
        <span class="comment-delimiter">;; </span><span class="comment">fancification
</span>        (<span class="string">"{1}"</span> (<span class="string">"mathrm"</span>))
        (,(<span class="keyword">lambda</span> (word) (string-offset-roman-chars <span class="highlight-numbers-number">119743</span> word)) (<span class="string">"mathbf"</span>))
        (,(<span class="keyword">lambda</span> (word) (string-offset-roman-chars <span class="highlight-numbers-number">119951</span> word)) (<span class="string">"mathcal"</span>))
        (,(<span class="keyword">lambda</span> (word) (string-offset-roman-chars <span class="highlight-numbers-number">120003</span> word)) (<span class="string">"mathfrak"</span>))
        (,(<span class="keyword">lambda</span> (word) (string-offset-roman-chars <span class="highlight-numbers-number">120055</span> word)) (<span class="string">"mathbb"</span>))
        (,(<span class="keyword">lambda</span> (word) (string-offset-roman-chars <span class="highlight-numbers-number">120159</span> word)) (<span class="string">"mathsf"</span>))
        (,(<span class="keyword">lambda</span> (word) (string-offset-roman-chars <span class="highlight-numbers-number">120367</span> word)) (<span class="string">"mathtt"</span>))
        )
      TeX-fold-macro-spec-list
      '(
        <span class="comment-delimiter">;; </span><span class="comment">as the defaults
</span>        (<span class="string">"[f]"</span> (<span class="string">"footnote"</span> <span class="string">"marginpar"</span>))
        (<span class="string">"[c]"</span> (<span class="string">"cite"</span>))
        (<span class="string">"[l]"</span> (<span class="string">"label"</span>))
        (<span class="string">"[r]"</span> (<span class="string">"ref"</span> <span class="string">"pageref"</span> <span class="string">"eqref"</span>))
        (<span class="string">"[i]"</span> (<span class="string">"index"</span> <span class="string">"glossary"</span>))
        (<span class="string">"..."</span> (<span class="string">"dots"</span>))
        (<span class="string">"{1}"</span> (<span class="string">"emph"</span> <span class="string">"textit"</span> <span class="string">"textsl"</span> <span class="string">"textmd"</span> <span class="string">"textrm"</span> <span class="string">"textsf"</span> <span class="string">"texttt"</span>
                <span class="string">"textbf"</span> <span class="string">"textsc"</span> <span class="string">"textup"</span>))
        <span class="comment-delimiter">;; </span><span class="comment">tweaked defaults
</span>        (<span class="string">"&#194;&#169;"</span> (<span class="string">"copyright"</span>))
        (<span class="string">"&#194;&#174;"</span> (<span class="string">"textregistered"</span>))
        (<span class="string">"&#226;&#132;&#162;"</span>  (<span class="string">"texttrademark"</span>))
        (<span class="string">"[1]:||&#226;&#150;&#186;"</span> (<span class="string">"item"</span>))
        (<span class="string">"&#226;&#157;&#161;&#226;&#157;&#161;&#226;&#128;&#134;{1}"</span> (<span class="string">"part"</span> <span class="string">"part*"</span>))
        (<span class="string">"&#226;&#157;&#161;&#226;&#128;&#134;{1}"</span> (<span class="string">"chapter"</span> <span class="string">"chapter*"</span>))
        (<span class="string">"&#194;&#167;&#226;&#128;&#134;{1}"</span> (<span class="string">"section"</span> <span class="string">"section*"</span>))
        (<span class="string">"&#194;&#167;&#194;&#167;&#226;&#128;&#134;{1}"</span> (<span class="string">"subsection"</span> <span class="string">"subsection*"</span>))
        (<span class="string">"&#194;&#167;&#194;&#167;&#194;&#167;&#226;&#128;&#134;{1}"</span> (<span class="string">"subsubsection"</span> <span class="string">"subsubsection*"</span>))
        (<span class="string">"&#194;&#182;&#226;&#128;&#134;{1}"</span> (<span class="string">"paragraph"</span> <span class="string">"paragraph*"</span>))
        (<span class="string">"&#194;&#182;&#194;&#182;&#226;&#128;&#134;{1}"</span> (<span class="string">"subparagraph"</span> <span class="string">"subparagraph*"</span>))
        <span class="comment-delimiter">;; </span><span class="comment">extra
</span>        (<span class="string">"&#226;&#172;&#150;&#226;&#128;&#134;{1}"</span> (<span class="string">"begin"</span>))
        (<span class="string">"&#226;&#172;&#151;&#226;&#128;&#134;{1}"</span> (<span class="string">"end"</span>))
        ))

(<span class="keyword">defun</span> <span class="function-name">string-offset-roman-chars</span> (offset word)
  <span class="doc">"Shift the codepoint of each charachter in WORD by OFFSET with an extra -6 shift if the letter is lowercase"</span>
  (apply 'string
         (mapcar (<span class="keyword">lambda</span> (c)
                   (string-offset-apply-roman-char-exceptions
                    (+ (<span class="keyword">if</span> (&gt;= c <span class="highlight-numbers-number">97</span>) (- c <span class="highlight-numbers-number">6</span>) c) offset)))
                 word)))

(<span class="keyword">defvar</span> <span class="variable-name">string-offset-roman-char-exceptions</span>
  '(<span class="comment-delimiter">;; </span><span class="comment">lowercase serif
</span>    (<span class="highlight-numbers-number">119892</span> .  <span class="highlight-numbers-number">8462</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#142;
</span>    <span class="comment-delimiter">;; </span><span class="comment">lowercase caligraphic
</span>    (<span class="highlight-numbers-number">119994</span> . <span class="highlight-numbers-number">8495</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#175;
</span>    (<span class="highlight-numbers-number">119996</span> . <span class="highlight-numbers-number">8458</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#138;
</span>    (<span class="highlight-numbers-number">120004</span> . <span class="highlight-numbers-number">8500</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#180;
</span>    <span class="comment-delimiter">;; </span><span class="comment">caligraphic
</span>    (<span class="highlight-numbers-number">119965</span> . <span class="highlight-numbers-number">8492</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#172;
</span>    (<span class="highlight-numbers-number">119968</span> . <span class="highlight-numbers-number">8496</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#176;
</span>    (<span class="highlight-numbers-number">119969</span> . <span class="highlight-numbers-number">8497</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#177;
</span>    (<span class="highlight-numbers-number">119971</span> . <span class="highlight-numbers-number">8459</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#139;
</span>    (<span class="highlight-numbers-number">119972</span> . <span class="highlight-numbers-number">8464</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#144;
</span>    (<span class="highlight-numbers-number">119975</span> . <span class="highlight-numbers-number">8466</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#146;
</span>    (<span class="highlight-numbers-number">119976</span> . <span class="highlight-numbers-number">8499</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#179;
</span>    (<span class="highlight-numbers-number">119981</span> . <span class="highlight-numbers-number">8475</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#155;
</span>    <span class="comment-delimiter">;; </span><span class="comment">fraktur
</span>    (<span class="highlight-numbers-number">120070</span> . <span class="highlight-numbers-number">8493</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#173;
</span>    (<span class="highlight-numbers-number">120075</span> . <span class="highlight-numbers-number">8460</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#140;
</span>    (<span class="highlight-numbers-number">120076</span> . <span class="highlight-numbers-number">8465</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#145;
</span>    (<span class="highlight-numbers-number">120085</span> . <span class="highlight-numbers-number">8476</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#156;
</span>    (<span class="highlight-numbers-number">120092</span> . <span class="highlight-numbers-number">8488</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#168;
</span>    <span class="comment-delimiter">;; </span><span class="comment">blackboard
</span>    (<span class="highlight-numbers-number">120122</span> . <span class="highlight-numbers-number">8450</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#130;
</span>    (<span class="highlight-numbers-number">120127</span> . <span class="highlight-numbers-number">8461</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#141;
</span>    (<span class="highlight-numbers-number">120133</span> . <span class="highlight-numbers-number">8469</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#149;
</span>    (<span class="highlight-numbers-number">120135</span> . <span class="highlight-numbers-number">8473</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#153;
</span>    (<span class="highlight-numbers-number">120136</span> . <span class="highlight-numbers-number">8474</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#154;
</span>    (<span class="highlight-numbers-number">120137</span> . <span class="highlight-numbers-number">8477</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#157;
</span>    (<span class="highlight-numbers-number">120145</span> . <span class="highlight-numbers-number">8484</span>) <span class="comment-delimiter">; </span><span class="comment">&#226;&#132;&#164;
</span>    )
  <span class="doc">"An alist of deceptive codepoints, and then where the glyph actually resides."</span>)

(<span class="keyword">defun</span> <span class="function-name">string-offset-apply-roman-char-exceptions</span> (char)
  <span class="doc">"Sometimes the codepoint doesn't contain the char you expect.
Such special cases should be remapped to another value, as given in `</span><span class="doc"><span class="constant">string-offset-roman-char-exceptions</span></span><span class="doc">'."</span>
  (<span class="keyword">if</span> (assoc char string-offset-roman-char-exceptions)
      (cdr (assoc char string-offset-roman-char-exceptions))
    char))

(<span class="keyword">defun</span> <span class="function-name">TeX-fold-parenthesize-as-neccesary</span> (tokens <span class="type">&amp;optional</span> suppress-left suppress-right)
  <span class="doc">"Add &#226;&#157;&#170; &#226;&#157;&#171; parenthesis as if multiple LaTeX tokens appear to be present"</span>
  (<span class="keyword">if</span> (TeX-string-single-token-p tokens) tokens
    (concat (<span class="keyword">if</span> suppress-left <span class="string">""</span> <span class="string">"&#226;&#157;&#170;"</span>)
            tokens
            (<span class="keyword">if</span> suppress-right <span class="string">""</span> <span class="string">"&#226;&#157;&#171;"</span>))))

(<span class="keyword">defun</span> <span class="function-name">TeX-string-single-token-p</span> (teststring)
  <span class="doc">"Return t if TESTSTRING appears to be a single token, nil otherwise"</span>
  (<span class="keyword">if</span> (string-match-p <span class="string">"^\\\\?\\w+$"</span> teststring) t nil))
<span class="comment-delimiter">;; </span><span class="comment">Editor visuals:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Editor visuals][Editor visuals:3]]
</span>(<span class="keyword">after!</span> tex
  (<span class="keyword">map!</span>
   <span class="builtin">:map</span> LaTeX-mode-map
   <span class="builtin">:ei</span> [C-return] #'LaTeX-insert-item)
  (<span class="keyword">setq</span> TeX-electric-math '(<span class="string">"</span><span class="string"><span class="regexp-grouping-backslash">\\</span></span><span class="string"><span class="regexp-grouping-construct">(</span></span><span class="string">"</span> . <span class="string">""</span>)))
<span class="comment-delimiter">;; </span><span class="comment">Editor visuals:3 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Editor visuals][Editor visuals:4]]
</span><span class="comment-delimiter">;; </span><span class="comment">Making \( \) less visible
</span>(<span class="keyword">defface</span> <span class="variable-name">unimportant-latex-face</span>
  '((t
     <span class="builtin">:inherit</span> font-lock-comment-face <span class="builtin">:family</span> <span class="string">"Overpass"</span> <span class="builtin">:weight</span> light))
  <span class="doc">"Face used to make \\(\\), \\[</span><span class="doc"><span class="constant">\\</span></span><span class="doc">] less visible."</span>
  <span class="builtin">:group</span> 'LaTeX-math)

(font-lock-add-keywords
 'latex-mode
 `((,(<span class="keyword">rx</span> (<span class="keyword">and</span> <span class="string">"\\"</span> (any <span class="string">"()[]"</span>))) <span class="highlight-numbers-number">0</span> 'unimportant-latex-face prepend))
 'end)

(font-lock-add-keywords
 'latex-mode
 `((,<span class="string">"\\\\[[:word:]]+"</span> <span class="highlight-numbers-number">0</span> 'font-lock-keyword-face prepend))
 'end)
<span class="comment-delimiter">;; </span><span class="comment">Editor visuals:4 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Editor visuals][Editor visuals:5]]
</span>(<span class="keyword">setq</span> preview-LaTeX-command '(<span class="string">"%`%l \"\\nonstopmode\\nofiles\
\\PassOptionsToPackage{"</span> (<span class="string">","</span> . preview-required-option-list) <span class="string">"}{preview}\
\\AtBeginDocument{\\ifx\\ifPreview\\undefined"</span>
preview-default-preamble <span class="string">"\\fi}\"%' \"\\detokenize{\" %t \"}\""</span>))
<span class="comment-delimiter">;; </span><span class="comment">Editor visuals:5 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*CDLaTeX][CDLaTeX:1]]
</span>(<span class="keyword">after!</span> cdlatex
  (<span class="keyword">setq</span> <span class="comment-delimiter">;; </span><span class="comment">cdlatex-math-symbol-prefix ?\; ;; doesn't work at the moment :(
</span>   cdlatex-math-symbol-alist
   '( <span class="comment-delimiter">;; </span><span class="comment">adding missing functions to 3rd level symbols
</span>     (?_    (<span class="string">"\\downarrow"</span>  <span class="string">""</span>           <span class="string">"\\inf"</span>))
     (?2    (<span class="string">"^2"</span>           <span class="string">"\\sqrt{?}"</span>     <span class="string">""</span>     ))
     (?3    (<span class="string">"^3"</span>           <span class="string">"\\sqrt[3]{?}"</span>  <span class="string">""</span>     ))
     (?^    (<span class="string">"\\uparrow"</span>    <span class="string">""</span>           <span class="string">"\\sup"</span>))
     (?k    (<span class="string">"\\kappa"</span>      <span class="string">""</span>           <span class="string">"\\ker"</span>))
     (?m    (<span class="string">"\\mu"</span>         <span class="string">""</span>           <span class="string">"\\lim"</span>))
     (?c    (<span class="string">""</span>             <span class="string">"\\circ"</span>     <span class="string">"\\cos"</span>))
     (?d    (<span class="string">"\\delta"</span>      <span class="string">"\\partial"</span>  <span class="string">"\\dim"</span>))
     (?D    (<span class="string">"\\Delta"</span>      <span class="string">"\\nabla"</span>    <span class="string">"\\deg"</span>))
     <span class="comment-delimiter">;; </span><span class="comment">no idea why \Phi isnt on 'F' in first place, \phi is on 'f'.
</span>     (?F    (<span class="string">"\\Phi"</span>))
     <span class="comment-delimiter">;; </span><span class="comment">now just conveniance
</span>     (?.    (<span class="string">"\\cdot"</span> <span class="string">"\\dots"</span>))
     (?:    (<span class="string">"\\vdots"</span> <span class="string">"\\ddots"</span>))
     (?*    (<span class="string">"\\times"</span> <span class="string">"\\star"</span> <span class="string">"\\ast"</span>)))
   cdlatex-math-modify-alist
   '( <span class="comment-delimiter">;; </span><span class="comment">my own stuff
</span>     (?B    <span class="string">"\\mathbb"</span>        nil          t    nil  nil)
     (?a    <span class="string">"\\abs"</span>           nil          t    nil  nil))))
<span class="comment-delimiter">;; </span><span class="comment">CDLaTeX:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*SyncTeX][SyncTeX:1]]
</span>(<span class="keyword">after!</span> tex
  (add-to-list 'TeX-view-program-list '(<span class="string">"Evince"</span> <span class="string">"evince %o"</span>))
  (add-to-list 'TeX-view-program-selection '(output-pdf <span class="string">"Evince"</span>)))
<span class="comment-delimiter">;; </span><span class="comment">SyncTeX:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Fixes][Fixes:1]]
</span>(<span class="keyword">when</span> EMACS28+
  (add-hook 'latex-mode-hook #'TeX-latex-mode))
<span class="comment-delimiter">;; </span><span class="comment">Fixes:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Python][Python:1]]
</span>(<span class="keyword">after!</span> lsp-python-ms
  (set-lsp-priority! 'mspyls <span class="highlight-numbers-number">1</span>))
<span class="comment-delimiter">;; </span><span class="comment">Python:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Editor Visuals][Editor Visuals:1]]
</span>(<span class="keyword">after!</span> ess-r-mode
  (<span class="keyword">appendq!</span> +ligatures-extra-symbols
            '(<span class="builtin">:assign</span> <span class="string">"&#226;&#159;&#181;"</span>
              <span class="builtin">:multiply</span> <span class="string">"&#195;&#151;"</span>))
  (set-ligatures! 'ess-r-mode
    <span class="comment-delimiter">;; </span><span class="comment">Functional
</span>    <span class="builtin">:def</span> <span class="string">"function"</span>
    <span class="comment-delimiter">;; </span><span class="comment">Types
</span>    <span class="builtin">:null</span> <span class="string">"NULL"</span>
    <span class="builtin">:true</span> <span class="string">"TRUE"</span>
    <span class="builtin">:false</span> <span class="string">"FALSE"</span>
    <span class="builtin">:int</span> <span class="string">"int"</span>
    <span class="builtin">:floar</span> <span class="string">"float"</span>
    <span class="builtin">:bool</span> <span class="string">"bool"</span>
    <span class="comment-delimiter">;; </span><span class="comment">Flow
</span>    <span class="builtin">:not</span> <span class="string">"!"</span>
    <span class="builtin">:and</span> <span class="string">"&amp;&amp;"</span> <span class="builtin">:or</span> <span class="string">"||"</span>
    <span class="builtin">:for</span> <span class="string">"for"</span>
    <span class="builtin">:in</span> <span class="string">"%in%"</span>
    <span class="builtin">:return</span> <span class="string">"return"</span>
    <span class="comment-delimiter">;; </span><span class="comment">Other
</span>    <span class="builtin">:assign</span> <span class="string">"&lt;-"</span>
    <span class="builtin">:multiply</span> <span class="string">"%*%"</span>))
<span class="comment-delimiter">;; </span><span class="comment">Editor Visuals:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Graphviz][Graphviz:1]]
</span>(<span class="keyword">use-package!</span> graphviz-dot-mode
  <span class="builtin">:commands</span> graphviz-dot-mode
  <span class="builtin">:mode</span> (<span class="string">"\\.dot\\'"</span> <span class="string">"\\.gz\\'"</span>)
  <span class="builtin">:init</span>
  (<span class="keyword">after!</span> org
    (setcdr (assoc <span class="string">"dot"</span> org-src-lang-modes)
            'graphviz-dot)))

(<span class="keyword">use-package!</span> company-graphviz-dot
  <span class="builtin">:after</span> graphviz-dot-mode)
<span class="comment-delimiter">;; </span><span class="comment">Graphviz:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Markdown][Markdown:1]]
</span>(<span class="keyword">add-hook!</span> (gfm-mode markdown-mode) #'mixed-pitch-mode)
<span class="comment-delimiter">;; </span><span class="comment">Markdown:1 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Markdown][Markdown:2]]
</span>(<span class="keyword">add-hook!</span> (gfm-mode markdown-mode) #'visual-line-mode #'turn-off-auto-fill)
<span class="comment-delimiter">;; </span><span class="comment">Markdown:2 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Markdown][Markdown:3]]
</span>(<span class="keyword">custom-set-faces!</span>
  '(markdown-header-face-1 <span class="builtin">:height</span> <span class="highlight-numbers-number">1.25</span> <span class="builtin">:weight</span> extra-bold <span class="builtin">:inherit</span> markdown-header-face)
  '(markdown-header-face-2 <span class="builtin">:height</span> <span class="highlight-numbers-number">1.15</span> <span class="builtin">:weight</span> bold       <span class="builtin">:inherit</span> markdown-header-face)
  '(markdown-header-face-3 <span class="builtin">:height</span> <span class="highlight-numbers-number">1.08</span> <span class="builtin">:weight</span> bold       <span class="builtin">:inherit</span> markdown-header-face)
  '(markdown-header-face-4 <span class="builtin">:height</span> <span class="highlight-numbers-number">1.00</span> <span class="builtin">:weight</span> bold       <span class="builtin">:inherit</span> markdown-header-face)
  '(markdown-header-face-5 <span class="builtin">:height</span> <span class="highlight-numbers-number">0.90</span> <span class="builtin">:weight</span> bold       <span class="builtin">:inherit</span> markdown-header-face)
  '(markdown-header-face-6 <span class="builtin">:height</span> <span class="highlight-numbers-number">0.75</span> <span class="builtin">:weight</span> extra-bold <span class="builtin">:inherit</span> markdown-header-face))
<span class="comment-delimiter">;; </span><span class="comment">Markdown:3 ends here
</span>
<span class="comment-delimiter">;; </span><span class="comment">[[file:~/.config/doom/config.org::*Beancount][Beancount:1]]
</span>(<span class="keyword">use-package!</span> beancount
  <span class="builtin">:mode</span> (<span class="string">"\\.beancount\\'"</span> . beancount-mode)
  <span class="builtin">:init</span>
  (<span class="keyword">after!</span> all-the-icons
    (add-to-list 'all-the-icons-icon-alist
                 '(<span class="string">"\\.beancount\\'"</span> all-the-icons-material <span class="string">"attach_money"</span> <span class="builtin">:face</span> all-the-icons-lblue))
    (add-to-list 'all-the-icons-mode-icon-alist
                 '(beancount-mode all-the-icons-material <span class="string">"attach_money"</span> <span class="builtin">:face</span> all-the-icons-lblue)))
  <span class="builtin">:config</span>
  (<span class="keyword">setq</span> beancount-electric-currency t)
  (<span class="keyword">defun</span> <span class="function-name">beancount-bal</span> ()
    <span class="doc">"Run bean-report bal."</span>
    (<span class="keyword">interactive</span>)
    (<span class="keyword">let</span> ((compilation-read-command nil))
      (beancount--run <span class="string">"bean-report"</span>
                      (file-relative-name buffer-file-name) <span class="string">"bal"</span>)))
  (<span class="keyword">map!</span> <span class="builtin">:map</span> beancount-mode-map
        <span class="builtin">:n</span> <span class="string">"TAB"</span> #'beancount-align-to-previous-number
        <span class="builtin">:i</span> <span class="string">"RET"</span> (<span class="keyword">cmd!</span> (newline-and-indent) (beancount-align-to-previous-number))))
<span class="comment-delimiter">;; </span><span class="comment">Beancount:1 ends here
</span></pre>
  </body>
</html>
